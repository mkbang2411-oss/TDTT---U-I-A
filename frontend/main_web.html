<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>UIA - Find Food Find Us</title>
    <link rel="stylesheet" href="banner.css">
    <link rel="stylesheet" href="button.css">
    <link rel="stylesheet" href="weblogin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    
    <!-- üó∫Ô∏è Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- ‚úÖ MarkerCluster CSS - QUAN TR·ªåNG! -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- üöó Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    
    <!-- üé® Custom Styles -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="minigame.css" />

</head>

<style>
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: #fff;
        padding: 12px 18px;
        border-radius: 10px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 9999;
        font-size: 15px;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success {
        background: #4caf50;
    }
    .toast.error {
        background: #e53935;
    }
    
    /* ·∫®n/hi·ªán ph·∫ßn t·ª≠ theo tr·∫°ng th√°i */
    .guest-only,
    .user-only { display: none; }

    body.logged-in .guest-only { display: none; }
    body.logged-in .user-only { display: flex !important; } /* ƒê·ªîI: block ‚Üí flex */
</style>

<body>
    <!-- üîî Toast Notification -->
    <div id="toast" class="toast"></div>

    <header class="banner">
        <div class="background">
            <img src="Picture/background.png" class="bg" alt="UIA Logo">
            <img src="Picture/UIAaa.png" class="uia" alt="UIA">
            
            <!-- N√∫t Account - CH·ªà HI·ªÜN KHI ƒê√É ƒêƒÇNG NH·∫¨P -->
            <div class="user-only">
                <!-- N√∫t Y√™u th√≠ch (Icon tr√°i tim - n·∫±m b√™n TR√ÅI) -->
                <button id="favoriteModeBtnHeader" class="favorite-heart-btn" title="Qu√°n y√™u th√≠ch">
                    <i class="fa-solid fa-heart"></i>
                </button>

                <!-- ‚≠ê N√öT TH√îNG B√ÅO (M·ªöI TH√äM) -->
                <button id="notificationBtn" class="notification-btn" title="Th√¥ng b√°o">
                    <i class="fa-solid fa-bell"></i>
                    <!-- Badge s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc -->
                    <span class="notification-badge" style="display: none;">0</span>
                </button>
                
                <!-- N√∫t T√†i kho·∫£n (n·∫±m b√™n PH·∫¢I) -->
                <a href="Account.html" class="account-button">
                    <span class="account-text">T√†i kho·∫£n</span>
                    <img src="Picture/user.png" alt="Account" class="account-img">
                </a>
            </div>

            <!-- N√∫t Sign Up/Sign In - CH·ªà HI·ªÜN KHI CH∆ØA ƒêƒÇNG NH·∫¨P -->
            <div class="guest-only">
                <a href="http://127.0.0.1:8000/accounts/signup" class="button-SignUp">ƒêƒÉng K√≠</a>
                <a href="http://127.0.0.1:8000/accounts/login" class="button-SignIn">ƒêƒÉng Nh·∫≠p</a>
            </div>
        </div>
    </header>

    <div id="controls">
        <!-- üß≠ THANH NH·∫¨P ƒê·ªäA ƒêI·ªÇM -->
        <div class="gps-box">
            <button id="gpsLocateBtn" class="gps-btn" title="D√πng GPS">
                <img src="Picture/GPS.png" alt="GPS" class="gps-icon">
            </button>
            <input id="gpsInput" type="text" placeholder="ƒê·ªãa ƒëi·ªÉm c·ªßa b·∫°n..." autocomplete="off" />
        </div>

        <!-- üîç THANH T√åM QU√ÅN ƒÇN -->
        <div class="search-row">
            <div class="search-box">
                <input id="query" type="text" placeholder="T√¨m qu√°n ƒÉn..." autocomplete="off" />
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>

        <!-- Multi-select kh·∫©u v·ªã -->
        <div class="flavor-selector" id="flavorSelector">
            <div class="flavor-selector-btn" id="flavorBtn">
                <span class="selected-flavors empty">Kh·∫©u v·ªã</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="flavorDropdown">
                <div class="flavor-option">
                    <input type="checkbox" value="cay" id="flavor-cay">
                    <label for="flavor-cay">Cay</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="man" id="flavor-man">
                    <label for="flavor-man">M·∫∑n</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="ngot" id="flavor-ngot">
                    <label for="flavor-ngot">Ng·ªçt</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="chua" id="flavor-chua">
                    <label for="flavor-chua">Chua</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="dang" id="flavor-dang">
                    <label for="flavor-dang">ƒê·∫Øng</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="tanh" id="flavor-tanh">
                    <label for="flavor-tanh">Tanh</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="thanh" id="flavor-thanh">
                    <label for="flavor-thanh">Thanh</label>
                </div>
            </div>
        </div>

        <!-- üí∞ NG√ÇN S√ÅCH -->
        <div class="budget-selector flavor-selector" id="budgetSelector">
            <div class="flavor-selector-btn" id="budgetBtn">
                <span class="selected-flavors empty">Ng√¢n s√°ch m·∫∑c ƒë·ªãnh</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="budgetDropdown">
                <div class="flavor-option">
                    <input type="radio" name="budget" value="" id="budget-default" checked>
                    <label for="budget-default">Ng√¢n s√°ch m·∫∑c ƒë·ªãnh</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="1-100000" id="budget-1">
                    <label for="budget-1">1 ‚Äì 100.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="100000-200000" id="budget-2">
                    <label for="budget-2">100.000 ‚Äì 200.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="200000-300000" id="budget-3">
                    <label for="budget-3">200.000 ‚Äì 300.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="300000-9999999" id="budget-4">
                    <label for="budget-4">300.000 ‚Ç´ tr·ªü l√™n</label>
                </div>
            </div>
            <!-- ‚úÖ HIDDEN INPUT ƒê·ªÇ SCRIPT.JS ƒê·ªåC ƒê∆Ø·ª¢C -->
            <input type="hidden" id="budget" value="">
        </div>

        <!-- üìè B√ÅN K√çNH -->
        <div class="radius-selector flavor-selector" id="radiusSelector">
            <div class="flavor-selector-btn" id="radiusBtn">
                <span class="selected-flavors empty">B√°n k√≠nh t√¨m ki·∫øm</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="radiusDropdown">
                <div class="flavor-option">
                    <input type="radio" name="radius" value="" id="radius-default" checked>
                    <label for="radius-default">B√°n k√≠nh m·∫∑c ƒë·ªãnh</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="0.5" id="radius-05">
                    <label for="radius-05">500 m</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="1" id="radius-1">
                    <label for="radius-1">1 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="2" id="radius-2">
                    <label for="radius-2">2 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="3" id="radius-3">
                    <label for="radius-3">3 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="5" id="radius-5">
                    <label for="radius-5">5 km</label>
                </div>
            </div>
            <!-- ‚úÖ HIDDEN INPUT ƒê·ªÇ SCRIPT.JS ƒê·ªåC ƒê∆Ø·ª¢C -->
            <input type="hidden" id="radius" value="">
        </div>

        <button id="btnSearch">
            <img src="Picture/find.png" style="width: 24px; height: 24px;">
        </button>
    </div>

    <div id="sidebar" class="hidden">
        <!-- ‚úÖ HEADER C·ªê ƒê·ªäNH (lu√¥n c√≥) -->
        <div class="sidebar-header">
            <h2 id="sidebar-title">Th√¥ng tin chi ti·∫øt</h2>
            <button id="closeSidebar">√ó</button>
        </div>
        
        <!-- ‚úÖ N·ªòI DUNG ƒê·ªòNG (render t·ª´ JS) -->
        <div id="sidebar-content"></div>
    </div>

    <!-- ‚úÖ MAP + N√öT QU√ÅN Y√äU TH√çCH -->
    <div id="map-container" style="position: relative;">
        <div id="map"></div>

         <!-- üß© N√∫t Mini Game -->
    <button id="miniGameBtn" class="map-floating-btn mini-game-btn">
        üß©
    </button>
    </div>
    
    <!-- ‚úÖ CHATBOT V√Ä FOOD PLAN BUTTONS - INJECT HERE -->
    <div id="insert-chatbot-and-map">
        <!-- Python s·∫Ω inject chatbot v√† food planner v√†o ƒë√¢y -->
    </div>
    
    <!-- üñºÔ∏è Popup zoom ·∫£nh -->
    <div id="imageModal" class="image-modal">
        <span id="closeModal">&times;</span>
        <img id="modalImg" src="" alt="Zoomed image">
    </div>

   

    <!-- üì¶ JAVASCRIPT LIBRARIES -->
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- ‚úÖ MarkerCluster JS - QUAN TR·ªåNG! Ph·∫£i load SAU Leaflet -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Fuse.js for search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    
    <!-- ‚úÖ Your custom script - Load CU·ªêI C√ôNG -->
    <script src="script.js"></script>
   

    
    <!-- üîê Script ki·ªÉm tra ƒëƒÉng nh·∫≠p -->
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
    
            // L·∫•y c√°c ph·∫ßn t·ª≠ n√∫t
            const guestButtons = document.querySelector('.guest-only');
            const userButton = document.querySelector('.user-only');

            // G·ªçi API tr√™n server Django
            fetch('http://127.0.0.1:8000/api/check-auth/', {
                method: 'GET',
                // B·∫ÆT BU·ªòC: G·ª≠i cookie (session) c√πng v·ªõi y√™u c·∫ßu
                credentials: 'include' 
            })
            .then(response => response.json())
            .then(data => {
                console.log('üîç Check auth response:', data); // ‚úÖ TH√äM d√≤ng n√†y
                // data s·∫Ω l√†: {is_authenticated: true} ho·∫∑c {is_authenticated: false}
                if (data.is_authenticated) {
                    // ƒê√£ ƒëƒÉng nh·∫≠p
                    if (guestButtons) guestButtons.style.display = 'none';
                    if (userButton) {
                        userButton.classList.add('show');  // ‚≠ê TH√äM class 'show'
                    }
                    console.log('Ch√†o m·ª´ng, ' + data.username);
                } else {
                    // Ch∆∞a ƒëƒÉng nh·∫≠p
                    if (guestButtons) guestButtons.style.display = 'block';
                    if (userButton) {
                        userButton.classList.remove('show');  // ‚≠ê X√ìA class 'show'
                    }
                }
            })
            .catch(error => {
                console.error('L·ªói khi ki·ªÉm tra x√°c th·ª±c:', error);
                // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã l√† ch∆∞a ƒëƒÉng nh·∫≠p n·∫øu API l·ªói
                if (guestButtons) guestButtons.style.display = 'block';
                if (userButton) userButton.style.display = 'none';
            });
        });
    </script>
      <!-- üß© MINI GAME OVERLAY -->
<div id="miniGameOverlay" class="mini-game-overlay hidden">
    <div class="mini-game-wrapper">
        <!-- Header -->
        <div class="mini-game-header">
            <button id="miniGameCloseBtn" class="mini-game-home-btn" title="Tho√°t mini game">
                ‚åÇ
            </button>
            <h2 class="mini-game-title">
                Gh√©p H√¨nh Vui Nh·ªôn (Jigsaw Puzzle)
            </h2>
        </div>

        <!-- Khu v·ª±c board gh√©p h√¨nh -->
        <div class="mini-game-content">
           <!-- üó∫Ô∏è MAP SELECTOR -->
<div class="map-selector">
    <!-- üÜï TAB SWITCHER -->
    <div class="tab-switcher">
        <button class="tab-btn active" data-tab="maps">
            üéÆ Ch·ªçn Map
        </button>
        <button class="tab-btn" data-tab="achievements">
            üèÜ Th√†nh T·ª±u
        </button>
    </div>

                <!-- üÜï TAB CONTENT: MAPS -->
                <div class="tab-content active" id="tab-maps">
                    <button class="map-option active" data-map="banh_mi">
                        <img src="Picture/banh_mi.png" alt="B√°nh M√¨">
                        <span>B√°nh M√¨</span>
                    </button>
                    <button class="map-option" data-map="com_tam">
                        <img src="Picture/com_tam.png" alt="C∆°m T·∫•m">
                        <span>C∆°m T·∫•m</span>
                    </button>
                    <button class="map-option" data-map="bun_bo_hue">
                        <img src="Picture/bun_bo_hue.png" alt="B√∫n B√≤ Hu·∫ø">
                        <span>B√∫n B√≤ Hu·∫ø</span>
                    </button>
                </div>

                <!-- üÜï TAB CONTENT: ACHIEVEMENTS -->
                <div class="tab-content" id="tab-achievements">
                    <div class="achievements-container">
                        <!-- JavaScript s·∫Ω render n·ªôi dung v√†o ƒë√¢y -->
                        <p class="loading-achievements">ƒêang t·∫£i th√†nh t·ª±u...</p>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ TH√äM PH·∫¶N N√ÄY - GAME CONTAINER -->
            <div class="game-container">
                <!-- ‚úÖ GAME HEADER (Timer, Moves, Shuffle) -->
                <div class="game-header">
                    <div class="timer">‚è±Ô∏è Th·ªùi gian: <span>0:00</span></div>
                    <div class="moves">üîÑ S·ªë b∆∞·ªõc: <span>0</span></div>
                    <button class="btn-shuffle">üîÄ X√°o l·∫°i</button>
                    <!-- N√∫t Reset s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông t·∫°i ƒë√¢y -->
                </div>

                <!-- PUZZLE BOARD -->
                <div id="jigsawBoard" class="jigsaw-board">
                    <div id="board">
                        <svg id="puzzle" viewBox="0 0 1071 750" style="display:none"
                             xmlns="http://www.w3.org/2000/svg"
                             xmlns:xlink="http://www.w3.org/1999/xlink">

                            <defs>
                                <!-- ·∫¢nh n·ªÅn -->
                                <image id="full-img"
                                       href="Picture/banh_mi.png"
                                       x="0" y="0"
                                       width="1071" height="750" />

    <!-- 12 path m·∫£nh gh√©p t·ª´ SVG m·ªõi (1071x750) -->
<path id="piece-0" d="M357 63.6807C373.569 63.6807 387 77.2552 387 94C387 110.745 373.569 124.319 357 124.319V189H207.994C207.727 172.444 194.402 159.106 178 159.106C161.598 159.106 148.273 172.444 148.006 189H0V-1H357V63.6807Z" />

<path id="piece-1" d="M714 63C697.431 63 684 76.4315 684 93C684 109.569 697.431 123 714 123V188.22H565.994C565.997 188.388 566 188.556 566 188.725C566 205.445 552.569 219 536 219C519.431 219 506 205.445 506 188.725C506 188.556 506.003 188.388 506.006 188.22H357V124.138C373.569 124.138 387 110.583 387 93.8623C387 77.1418 373.569 63.5869 357 63.5869V-1H714V63Z" />

<path id="piece-2" d="M893 158C909.569 158 923 171.431 923 188C923 188.335 922.992 188.668 922.981 189H1071V376.5H922.994C922.997 376.334 923 376.167 923 376C923 359.431 909.569 346 893 346C876.431 346 863 359.431 863 376C863 376.167 863.003 376.334 863.006 376.5H714V312.981C713.668 312.992 713.335 313 713 313C696.431 313 683 299.569 683 283C683 266.431 696.431 253 713 253C713.335 253 713.668 253.007 714 253.018V189H863.019C863.008 188.668 863 188.335 863 188C863 171.431 876.431 158 893 158Z" />

<path id="piece-3" d="M178 158C194.569 158 208 171.431 208 188H357V249C340.431 249 327 262.431 327 279C327 295.569 340.431 309 357 309V375.5H208C208 392.069 194.569 405.5 178 405.5C161.431 405.5 148 392.069 148 375.5H0V188H148C148 171.431 161.431 158 178 158Z" />

<path id="piece-4" d="M1071 190H922.994C922.727 173.444 909.402 160.106 893 160.106C876.598 160.106 863.273 173.444 863.006 190H714V123.64C697.432 123.64 684 110.03 684 93.2402C684 76.4508 697.431 62.8398 714 62.8398V0H1071V190Z" />

<path id="piece-5" d="M178 532C194.569 532 208 545.431 208 562H357V629C373.569 629 387 642.431 387 659C387 675.569 373.569 689 357 689V749.5H0V562H148C148 545.431 161.431 532 178 532Z" />

<path id="piece-6" d="M148 375C148 391.569 161.431 405 178 405C194.569 405 208 391.569 208 375H357V439C340.431 439 327 452.431 327 469C327 485.569 340.431 499 357 499V562.5H207.994C207.727 546.162 194.402 533 178 533C161.598 533 148.273 546.162 148.006 562.5H0V375H148Z" />

<path id="piece-7" d="M893 345C909.569 345 923 358.431 923 375H1071V562.5H922.994C922.727 546.162 909.402 533 893 533C876.598 533 863.273 546.162 863.006 562.5H714V501C730.569 501 744 487.569 744 471C744 454.431 730.569 441 714 441V375H863C863 358.431 876.431 345 893 345Z" />

<path id="piece-8" d="M536 345C552.569 345 566 358.431 566 375H714V441C730.569 441 744 454.431 744 471C744 487.569 730.569 501 714 501V562.5H565.994C565.727 546.162 552.402 533 536 533C519.598 533 506.273 546.162 506.006 562.5H357V500C340.431 500 327 486.569 327 470C327 453.431 340.431 440 357 440V375H506C506 358.431 519.431 345 536 345Z" />

<path id="piece-9" d="M893 532C909.569 532 923 545.431 923 562H1071V749.5H714V686.981C713.668 686.992 713.335 687 713 687C696.431 687 683 673.569 683 657C683 640.431 696.431 627 713 627C713.335 627 713.668 627.007 714 627.018V562H863C863 545.431 876.431 532 893 532Z" />

<path id="piece-10" d="M536 532C552.569 532 566 545.431 566 562C566 562.335 565.992 562.668 565.981 563H714V627.018C713.668 627.007 713.335 627 713 627C696.431 627 683 640.431 683 657C683 673.569 696.431 687 713 687C713.335 687 713.668 686.992 714 686.981V750.5H357V689C373.569 689 387 675.569 387 659C387 642.431 373.569 629 357 629V563H506.019C506.008 562.668 506 562.335 506 562C506 545.431 519.431 532 536 532Z" />

<path id="piece-11" d="M506.019 188C506.546 204.106 519.766 217 536 217C552.234 217 565.454 204.106 565.981 188H714V253.018C713.668 253.007 713.335 253 713 253C696.431 253 683 266.431 683 283C683 299.569 696.431 313 713 313C713.335 313 713.668 312.992 714 312.981V375.5H565.994C565.727 359.162 552.402 346 536 346C519.598 346 506.273 359.162 506.006 375.5H357V309C340.431 309 327 295.569 327 279C327 262.431 340.431 249 357 249V188H506.019Z" />

</defs>

            <!-- ·∫¢nh n·ªÅn m·ªù l√†m h√¨nh g·ª£i √Ω, d√πng CHUNG h·ªá t·ªça ƒë·ªô v·ªõi m·∫£nh gh√©p -->
<image
    id="bg-hint-img"
    href="Picture/banh_mi.png"
    x="0" y="0"
    width="1071" height="750"
    preserveAspectRatio="none"
    opacity="0.18"
    style="pointer-events:none" />

    <!-- n∆°i ch·ª©a 12 m·∫£nh -->
    <g id="pieces"></g>
</svg>
    </div>
</div>

            </div>
        </div>
    </div>
     <script src="minigame.js"></script>

    <script>
    // Test n√∫t th√¥ng b√°o
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationBadge = notificationBtn.querySelector('.notification-badge');

    // Gi·∫£ l·∫≠p c√≥ 5 th√¥ng b√°o m·ªõi
    function showNotification(count) {
        if (count > 0) {
            notificationBtn.classList.add('has-notification');
            notificationBadge.textContent = count;
            notificationBadge.style.display = 'block';
        } else {
            notificationBtn.classList.remove('has-notification');
            notificationBadge.style.display = 'none';
        }
    }

    // Khi click n√∫t th√¥ng b√°o
    notificationBtn.addEventListener('click', () => {
        alert('Danh s√°ch th√¥ng b√°o (s·∫Ω l√†m sau)');
        // X√≥a th√¥ng b√°o sau khi xem
        showNotification(0);
    });

    // Gi·∫£ l·∫≠p c√≥ 3 th√¥ng b√°o m·ªõi khi load trang
    setTimeout(() => {
        showNotification(3);
    }, 2000);
    </script>

    <script>
        // ‚úÖ QU·∫¢N L√ù Z-INDEX ƒê·ªòNG - OPTIMIZED VERSION
        document.addEventListener('DOMContentLoaded', () => {
            const chatWindow = document.querySelector('.chat-window');
            const chatbotBtn = document.querySelector('.chatbot-button');
            const foodPlannerPanel = document.querySelector('.food-planner-panel');
            const musicPanel = document.querySelector('.music-panel');
            const musicBtn = document.querySelector('.music-player-btn');
            const miniGameOverlay = document.getElementById('miniGameOverlay');
            const sidebar = document.getElementById('sidebar'); 
            
            // ‚ö° CACHE Z-INDEX VALUES (kh√¥ng ph·∫£i t√≠nh l·∫°i m·ªói l·∫ßn)
            const Z_INDEX = {
                MINI_GAME_ACTIVE: {
                    chat: '999999',
                    food: '999999',
                    music: '10000002',
                    musicBtn: '10000002',
                    sidebar: '10000003'
                },
                CHAT_ACTIVE: {
                    chat: '10000001',
                    food: '9999999',
                    music: '9999998',
                    musicBtn: '999997',
                    sidebar: '10000002'
                },
                FOOD_ACTIVE: {
                    chat: '9999999',
                    food: '10000001',
                    music: '9999998',
                    musicBtn: '999997',
                    sidebar: '10000002'
                },
                MUSIC_ACTIVE: {
                    chat: '9999999',
                    food: '9999999',
                    music: '10000001',
                    musicBtn: '999997',
                    sidebar: '10000002'
                },
                DEFAULT: {
                    chat: '1000000',
                    food: '9999999',
                    music: '99999998',
                    musicBtn: '999997',
                    sidebar: '100000000'
                }
            };
            
            // üöÄ H√ÄM UPDATE Z-INDEX - SIMPLIFIED
            function updateZIndex() {
                const isMiniGameOpen = miniGameOverlay && !miniGameOverlay.classList.contains('hidden');
                const isChatOpen = chatWindow && chatWindow.classList.contains('open');
                const isFoodOpen = foodPlannerPanel && foodPlannerPanel.classList.contains('active');
                const isMusicOpen = musicPanel && musicPanel.classList.contains('open');
                
                let zIndexSet;
                
                // X√°c ƒë·ªãnh state v√† l·∫•y z-index t∆∞∆°ng ·ª©ng
                if (isMiniGameOpen) {
                    zIndexSet = Z_INDEX.MINI_GAME_ACTIVE;
                } else if (isChatOpen) {
                    zIndexSet = Z_INDEX.CHAT_ACTIVE;
                } else if (isFoodOpen) {
                    zIndexSet = Z_INDEX.FOOD_ACTIVE;
                } else if (isMusicOpen) {
                    zIndexSet = Z_INDEX.MUSIC_ACTIVE;
                } else {
                    zIndexSet = Z_INDEX.DEFAULT;
                }
                
                // Apply z-index m·ªôt l·∫ßn (batch update)
                if (chatWindow) chatWindow.style.zIndex = zIndexSet.chat;
                if (foodPlannerPanel) foodPlannerPanel.style.zIndex = zIndexSet.food;
                if (musicPanel) musicPanel.style.zIndex = zIndexSet.music;
                if (musicBtn) musicBtn.style.zIndex = zIndexSet.musicBtn;
                if (sidebar) sidebar.style.zIndex = zIndexSet.sidebar;
            }
            
            // ‚ö° DEBOUNCED UPDATE (tr√°nh g·ªçi nhi·ªÅu l·∫ßn li√™n t·ª•c)
            let updateTimeout;
            function scheduleUpdate() {
                if (updateTimeout) return; // N·∫øu ƒëang c√≥ schedule r·ªìi th√¨ b·ªè qua
                
                updateTimeout = requestAnimationFrame(() => {
                    updateZIndex();
                    updateTimeout = null;
                });
            }
            
            // üéØ L·∫ÆNG NGHE THAY ƒê·ªîI
            if (chatbotBtn) {
                chatbotBtn.addEventListener('click', scheduleUpdate);
            }
            
            if (foodPlannerPanel) {
                new MutationObserver(scheduleUpdate).observe(foodPlannerPanel, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
            }
            
            if (musicPanel) {
                new MutationObserver(scheduleUpdate).observe(musicPanel, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
            }
            
            if (miniGameOverlay) {
                new MutationObserver(scheduleUpdate).observe(miniGameOverlay, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
            }
            
            // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
            updateZIndex();
        });
    </script>

    <style>
    /* ========== FIX HORIZONTAL SCROLL ========== */
    html, body {
        overflow-x: hidden !important;
        max-width: 100vw !important;
    }

    * {
        box-sizing: border-box !important;
    }

    .chat-window {
        max-width: calc(100vw - 60px) !important;
    }

    .chat-history-sidebar {
        max-width: 260px !important;
    }

    .speech-bubble {
        max-width: 240px !important;
        word-wrap: break-word !important;
    }
    </style>

</body>
</html>
