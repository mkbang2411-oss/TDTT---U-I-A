<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>UIA - Find Food Find Us</title>
    <link rel="stylesheet" href="banner.css">
    <link rel="stylesheet" href="button.css">
    <link rel="stylesheet" href="weblogin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>

<style>
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: #fff;
        padding: 12px 18px;
        border-radius: 10px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        z-index: 9999;
        font-size: 15px;
    }
    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }
    .toast.success {
        background: #4caf50;
    }
    .toast.error {
        background: #e53935;
    }
    
    /* ·∫®n/hi·ªán ph·∫ßn t·ª≠ theo tr·∫°ng th√°i */
    /* .guest-only { display: block; } */
    .guest-only,
    .user-only { display: none; }
    
    body.logged-in .guest-only { display: none; }
    body.logged-in .user-only { display: block; }
</style>

<body>
    <!-- üîî Toast Notification -->
    <div id="toast" class="toast"></div>

    <header class="banner">
        <div class="background">
            <img src="Picture/background.png" class="bg" alt="UIA Logo">
            <img src="Picture/UIAaa.png" class="uia" alt="UIA">
            
            <!-- N√∫t Account - CH·ªà HI·ªÜN KHI ƒê√É ƒêƒÇNG NH·∫¨P -->
            <div class="user-only">
                <a href="Account.html" class="account-button">
                    <span class="account-text">T√†i kho·∫£n</span>
                    <img src="Picture/user.png" alt="Account" class="account-img">
                </a>
            </div>
            <!-- N√∫t Sign Up/Sign In - CH·ªà HI·ªÜN KHI CH∆ØA ƒêƒÇNG NH·∫¨P -->
                <div class="guest-only">
                    <a href="http://127.0.0.1:8000/accounts/signup" class="button-SignUp">ƒêƒÉng K√≠</a>
                    <a href="http://127.0.0.1:8000/accounts/login" class="button-SignIn">ƒêƒÉng Nh·∫≠p</a>
                </div>
        </div>
    </header>

    <div id="controls">
        <!-- üß≠ THANH NH·∫¨P ƒê·ªäA ƒêI·ªÇM -->
        <div class="gps-box">
            <button id="gpsLocateBtn" class="gps-btn" title="D√πng GPS">
                <img src="Picture/GPS.png" alt="GPS" class="gps-icon">
            </button>
            <input id="gpsInput" type="text" placeholder="ƒê·ªãa ƒëi·ªÉm c·ªßa b·∫°n..." autocomplete="off" />
        </div>

        <!-- üîç THANH T√åM QU√ÅN ƒÇN -->
        <div class="search-row">
            <div class="search-box">
                <input id="query" type="text" placeholder="T√¨m qu√°n ƒÉn..." autocomplete="off" />
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>

        <!-- Multi-select kh·∫©u v·ªã -->
<div class="flavor-selector" id="flavorSelector">
    <div class="flavor-selector-btn" id="flavorBtn">
        <span class="selected-flavors empty">Kh·∫©u v·ªã</span>
        <span class="arrow">‚ñº</span>
    </div>
    <div class="flavor-dropdown" id="flavorDropdown">
        <div class="flavor-option">
            <input type="checkbox" value="cay" id="flavor-cay">
            <label for="flavor-cay">Cay</label>
        </div>
        <div class="flavor-option">
            <input type="checkbox" value="man" id="flavor-man">
            <label for="flavor-man">M·∫∑n</label>
        </div>
        <div class="flavor-option">
            <input type="checkbox" value="ngot" id="flavor-ngot">
            <label for="flavor-ngot">Ng·ªçt</label>
        </div>
        <div class="flavor-option">
            <input type="checkbox" value="chua" id="flavor-chua">
            <label for="flavor-chua">Chua</label>
        </div>
        <div class="flavor-option">
            <input type="checkbox" value="dang" id="flavor-dang">
            <label for="flavor-dang">ƒê·∫Øng</label>
        </div>
        <div class="flavor-option">
            <input type="checkbox" value="tanh" id="flavor-tanh">
            <label for="flavor-tanh">Tanh</label>
        </div>
        <div class="flavor-option">
            <input type="checkbox" value="thanh" id="flavor-thanh">
            <label for="flavor-thanh">Thanh</label>
        </div>
    </div>
</div>

        <!-- üí∞ NG√ÇN S√ÅCH -->
        <div class="budget-selector flavor-selector" id="budgetSelector">
            <div class="flavor-selector-btn" id="budgetBtn">
                <span class="selected-flavors empty">Ng√¢n s√°ch m·∫∑c ƒë·ªãnh</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="budgetDropdown">
                <div class="flavor-option">
                    <input type="radio" name="budget" value="" id="budget-default" checked>
                    <label for="budget-default">Ng√¢n s√°ch m·∫∑c ƒë·ªãnh</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="1-100000" id="budget-1">
                    <label for="budget-1">1 ‚Äì 100.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="100000-200000" id="budget-2">
                    <label for="budget-2">100.000 ‚Äì 200.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="200000-300000" id="budget-3">
                    <label for="budget-3">200.000 ‚Äì 300.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="300000-9999999" id="budget-4">
                    <label for="budget-4">300.000 ‚Ç´ tr·ªü l√™n</label>
                </div>
            </div>
            <!-- ‚úÖ HIDDEN INPUT ƒê·ªÇ SCRIPT.JS ƒê·ªåC ƒê∆Ø·ª¢C -->
            <input type="hidden" id="budget" value="">
        </div>

        <!-- üìè B√ÅN K√çNH -->
        <div class="radius-selector flavor-selector" id="radiusSelector">
            <div class="flavor-selector-btn" id="radiusBtn">
                <span class="selected-flavors empty">B√°n k√≠nh t√¨m ki·∫øm</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="radiusDropdown">
                <div class="flavor-option">
                    <input type="radio" name="radius" value="" id="radius-default" checked>
                    <label for="radius-default">B√°n k√≠nh m·∫∑c ƒë·ªãnh</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="0.5" id="radius-05">
                    <label for="radius-05">500 m</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="1" id="radius-1">
                    <label for="radius-1">1 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="2" id="radius-2">
                    <label for="radius-2">2 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="3" id="radius-3">
                    <label for="radius-3">3 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="5" id="radius-5">
                    <label for="radius-5">5 km</label>
                </div>
            </div>
            <!-- ‚úÖ HIDDEN INPUT ƒê·ªÇ SCRIPT.JS ƒê·ªåC ƒê∆Ø·ª¢C -->
            <input type="hidden" id="radius" value="">
        </div>

        <button id="btnSearch">
            <img src="Picture/find.png" style="width: 24px; height: 24px;">
        </button>
    </div>

    <div id="sidebar" class="hidden">
        <!-- ‚úÖ HEADER C·ªê ƒê·ªäNH (lu√¥n c√≥) -->
        <div class="sidebar-header">
            <h2 id="sidebar-title">Th√¥ng tin chi ti·∫øt</h2>
            <button id="closeSidebar">√ó</button>
        </div>
        
        <!-- ‚úÖ N·ªòI DUNG ƒê·ªòNG (render t·ª´ JS) -->
        <div id="sidebar-content"></div>
    </div>

    <!-- ‚úÖ MAP + N√öT QU√ÅN Y√äU TH√çCH -->
    <div id="map-container" style="position: relative;">
        <div id="map"></div>

        <!-- üî¥ N√∫t ch·ªâ hi·ªÉn th·ªã qu√°n ƒë√£ y√™u th√≠ch (JS s·∫Ω l√†m ·ªü b∆∞·ªõc 3) -->
        <div id="favoriteModeBtn" class="map-floating-btn">
            ‚ù§Ô∏è Qu√°n y√™u th√≠ch
        </div>
    </div>
    
    <!-- üñºÔ∏è Popup zoom ·∫£nh -->
    <div id="imageModal" class="image-modal">
        <span id="closeModal">&times;</span>
        <img id="modalImg" src="" alt="Zoomed image">
    </div>
  <!-- üéÆ MINI GAME START -->
<button id="miniGameBtn" class="mini-game-btn">üéÆ Mini Game</button>

<div id="miniGamePopup" class="mini-game-popup hidden">
    <div class="mini-game-content">

        <!-- N√∫t ƒë√≥ng popup -->
        <button id="closeMiniGame" class="close-mini-game" type="button">√ó</button>

        <h2>Mini-game</h2>

        <!-- V√πng ch·ª©a game v√† win screen -->
        <div id="miniGameInner">
            <canvas id="gameCanvas" width="800" height="800"></canvas>
        </div>

        <!-- √Çm thanh m·ªü r∆∞∆°ng -->
        <audio id="chestSoundAudio" src="GameAssets/open_chest.mp3" hidden></audio>

    </div>
</div>
<!-- üéÆ MINI GAME END -->

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    <script src="script.js"></script>
    
    <!-- üîê Script ki·ªÉm tra ƒëƒÉng nh·∫≠p -->
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
    
            // L·∫•y c√°c ph·∫ßn t·ª≠ n√∫t
            const guestButtons = document.querySelector('.guest-only');
            const userButton = document.querySelector('.user-only');

            // G·ªçi API tr√™n server Django
            fetch('http://127.0.0.1:8000/api/check-auth/', {
                method: 'GET',
                // B·∫ÆT BU·ªòC: G·ª≠i cookie (session) c√πng v·ªõi y√™u c·∫ßu
                credentials: 'include' 
            })
            .then(response => response.json())
            .then(data => {
                // data s·∫Ω l√†: {is_authenticated: true} ho·∫∑c {is_authenticated: false}
                if (data.is_authenticated) {
                    // ƒê√£ ƒëƒÉng nh·∫≠p
                    if (guestButtons) guestButtons.style.display = 'none'; // ·∫®n n√∫t ƒêƒÉng nh·∫≠p
                    if (userButton) userButton.style.display = 'block';  // Hi·ªán n√∫t Account
                    
                    // T√πy ch·ªçn: Ch√†o m·ª´ng ng∆∞·ªùi d√πng
                    console.log('Ch√†o m·ª´ng, ' + data.username);
                } else {
                    // Ch∆∞a ƒëƒÉng nh·∫≠p
                    if (guestButtons) guestButtons.style.display = 'block'; // Hi·ªán n√∫t ƒêƒÉng nh·∫≠p
                    if (userButton) userButton.style.display = 'none';   // ·∫®n n√∫t Account
                }
            })
            .catch(error => {
                console.error('L·ªói khi ki·ªÉm tra x√°c th·ª±c:', error);
                // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã l√† ch∆∞a ƒëƒÉng nh·∫≠p n·∫øu API l·ªói
                if (guestButtons) guestButtons.style.display = 'block';
                if (userButton) userButton.style.display = 'none';
            });
        });
    </script>
    
    <div id="insert-chatbot-and-map"></div>
</body>
</html>
