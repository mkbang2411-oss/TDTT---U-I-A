<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>UIA - Find Food Find Us</title>
    <link rel="stylesheet" href="banner.css">
    <link rel="stylesheet" href="button.css">
    <link rel="stylesheet" href="weblogin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- üó∫Ô∏è Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- ‚úÖ MarkerCluster CSS - QUAN TR·ªåNG! -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- üöó Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
    
    <!-- üé® Custom Styles -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="minigame.css" />

</head>

<style>  
    /* ·∫®n/hi·ªán ph·∫ßn t·ª≠ theo tr·∫°ng th√°i */
    .guest-only,
    .user-only { display: none; }

    body.logged-in .guest-only { display: none; }
    body.logged-in .user-only { display: flex !important; } /* ƒê·ªîI: block ‚Üí flex */

    /* üî• T·∫ÆT KHUNG ƒêEN KHI CLICK V√ÄO ƒê∆Ø·ªúNG ƒêI TR√äN MAP */
    #map .leaflet-interactive:focus,
    #map .leaflet-interactive:focus-visible {
        outline: none !important;
        outline-offset: 0;
    }
</style>



<body>
    <!-- üîî Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- üîî Popup th√¥ng b√°o Food Planner -->
    <div id="notificationOverlay" class="notification-overlay">
        <div class="notification-modal">
            <div class="notification-modal-header">
                <div class="notification-modal-title">
                    <span class="notification-modal-icon">üîî</span>
                    <span data-translate="notification_title">Th√¥ng b√°o</span>
                </div>
                <button id="notificationCloseBtn" class="notification-close-btn" title="ƒê√≥ng" data-translate-title="close">
                    &times;
                </button>
            </div>

            <div id="notificationList" class="notification-list">
                <!-- JS s·∫Ω render danh s√°ch th√¥ng b√°o ·ªü ƒë√¢y -->
            </div>

            <div class="notification-modal-footer">
                <button id="markAllAsReadBtn" class="notification-footer-btn" data-translate="mark_all_read">
                    ‚úî ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
                </button>

                <button id="deleteAllNotificationsBtn" class="notification-delete-all-btn" title="X√≥a t·∫•t c·∫£ th√¥ng b√°o" data-translate-title="delete_all_notifications">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    <span data-translate="delete_all">X√≥a t·∫•t c·∫£</span>
                </button>

            </div>
        </div>
    </div>

    <header class="banner">
        <div class="background">
            <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/background.png" class="bg" alt="UIA Logo">
            <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/UIAaa.png" class="uia" alt="UIA">
            
            <!-- N√∫t Account - CH·ªà HI·ªÜN KHI ƒê√É ƒêƒÇNG NH·∫¨P -->
            <div class="user-only">
                <!-- N√∫t Y√™u th√≠ch (Icon tr√°i tim - n·∫±m b√™n TR√ÅI) -->
                <button id="favoriteModeBtnHeader" class="favorite-heart-btn" title="Qu√°n y√™u th√≠ch" data-translate-title="favorite_restaurants">
                    <i class="fa-solid fa-heart"></i>
                </button>

                <!-- ‚≠ê N√öT TH√îNG B√ÅO (M·ªöI TH√äM) -->
                <button id="notificationBtn" class="notification-btn" title="Th√¥ng b√°o" data-translate-title="notifications">
                    <i class="fa-solid fa-bell"></i>
                    <!-- Badge s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc -->
                    <span class="notification-badge" style="display: none;">0</span>
                </button>
                
                <!-- N√∫t T√†i kho·∫£n (n·∫±m b√™n PH·∫¢I) -->
                <a href="Account.html" class="account-button">
                    <span class="account-text" data-translate="account">T√†i kho·∫£n</span>
                    <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/user.png" alt="Account" class="account-img">
                </a>
            </div>

            <!-- N√∫t Sign Up/Sign In - CH·ªà HI·ªÜN KHI CH∆ØA ƒêƒÇNG NH·∫¨P -->
            <div class="guest-only">
                <a href="/accounts/signup/" class="button-SignUp" data-translate="sign_up">ƒêƒÉng K√Ω</a>
                <a href="/accounts/login/" class="button-SignIn" data-translate="sign_in">ƒêƒÉng Nh·∫≠p</a>
            </div>
        </div>
    </header>

    <div id="controls">
        <!-- üß≠ THANH NH·∫¨P ƒê·ªäA ƒêI·ªÇM -->
        <div class="gps-box">
            <button id="gpsLocateBtn" class="gps-btn" title="D√πng GPS" data-translate-title="use_gps">
                <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/GPS.png" alt="GPS" class="gps-icon">
            </button>
            <input id="gpsInput" type="text" placeholder="ƒê·ªãa ƒëi·ªÉm c·ªßa b·∫°n..." autocomplete="off" data-translate-placeholder="your_location" />
        </div>

        <!-- üîç THANH T√åM QU√ÅN ƒÇN -->
        <div class="search-row">
            <div class="search-box">
                <input id="query" type="text" placeholder="T√¨m m√≥n ƒÉn..." autocomplete="off" data-translate-placeholder="search_restaurant"/>
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>

        <!-- Multi-select kh·∫©u v·ªã -->
        <div class="flavor-selector" id="flavorSelector">
            <div class="flavor-selector-btn" id="flavorBtn">
                <span class="selected-flavors empty" data-translate="flavor">Kh·∫©u v·ªã</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="flavorDropdown">
                <div class="flavor-option">
                    <input type="checkbox" value="cay" id="flavor-cay">
                    <label for="flavor-cay" data-translate="flavor_spicy">Cay</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="man" id="flavor-man">
                    <label for="flavor-man" data-translate="flavor_salty">M·∫∑n</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="ngot" id="flavor-ngot">
                    <label for="flavor-ngot" data-translate="flavor_sweet">Ng·ªçt</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="chua" id="flavor-chua">
                    <label for="flavor-chua" data-translate="flavor_sour">Chua</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="dang" id="flavor-dang">
                    <label for="flavor-dang" data-translate="flavor_bitter">ƒê·∫Øng</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="tanh" id="flavor-tanh">
                    <label for="flavor-tanh" data-translate="flavor_fishy">Tanh</label>
                </div>
                <div class="flavor-option">
                    <input type="checkbox" value="thanh" id="flavor-thanh">
                    <label for="flavor-thanh" data-translate="flavor_plain">Thanh</label>
                </div>
            </div>
        </div>

        <!-- üí∞ NG√ÇN S√ÅCH -->
        <div class="budget-selector flavor-selector" id="budgetSelector">
            <div class="flavor-selector-btn" id="budgetBtn">
                <span class="selected-flavors empty" data-translate="budget_default">Ng√¢n s√°ch m·∫∑c ƒë·ªãnh</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="budgetDropdown">
                <div class="flavor-option">
                    <input type="radio" name="budget" value="" id="budget-default" checked>
                    <label for="budget-default" data-translate="budget_default">Ng√¢n s√°ch m·∫∑c ƒë·ªãnh</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="1-100000" id="budget-1">
                    <label for="budget-1" data-translate="budget_1">1 ‚Äì 100.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="100000-200000" id="budget-2">
                    <label for="budget-2" data-translate="budget_2">100.000 ‚Äì 200.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="200000-300000" id="budget-3">
                    <label for="budget-3" data-translate="budget_3">200.000 ‚Äì 300.000 ‚Ç´</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="budget" value="300000-9999999" id="budget-4">
                    <label for="budget-4" data-translate="budget_4">300.000 ‚Ç´ tr·ªü l√™n</label>
                </div>
            </div>
            <!-- ‚úÖ HIDDEN INPUT ƒê·ªÇ SCRIPT.JS ƒê·ªåC ƒê∆Ø·ª¢C -->
            <input type="hidden" id="budget" value="">
        </div>

        <!-- üìè B√ÅN K√çNH -->
        <div class="radius-selector flavor-selector" id="radiusSelector">
            <div class="flavor-selector-btn" id="radiusBtn">
                <span class="selected-flavors empty" data-translate="radius_default">B√°n k√≠nh t√¨m ki·∫øm</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="flavor-dropdown" id="radiusDropdown">
                <div class="flavor-option">
                    <input type="radio" name="radius" value="" id="radius-default" checked>
                    <label for="radius-default" data-translate="radius_default">B√°n k√≠nh m·∫∑c ƒë·ªãnh</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="0.5" id="radius-05">
                    <label for="radius-05" data-translate="radius_05">500 m</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="1" id="radius-1">
                    <label for="radius-1" data-translate="radius_1">1 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="2" id="radius-2">
                    <label for="radius-2" data-translate="radius_2">2 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="3" id="radius-3">
                    <label for="radius-3" data-translate="radius_3">3 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="5" id="radius-5">
                    <label for="radius-5" data-translate="radius_5">5 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="10" id="radius-10">
                    <label for="radius-10" data-translate="radius_10">10 km</label>
                </div>
                <div class="flavor-option">
                    <input type="radio" name="radius" value="20" id="radius-20">
                    <label for="radius-20" data-translate="radius_20">20 km</label>
                </div>
            </div>
            <!-- ‚úÖ HIDDEN INPUT ƒê·ªÇ SCRIPT.JS ƒê·ªåC ƒê∆Ø·ª¢C -->
            <input type="hidden" id="radius" value="">
        </div>

        <button id="btnSearch" title="T√¨m ki·∫øm" data-translate-title="search">
            <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/find.png" style="width: 24px; height: 24px;">
        </button>
    </div>

    <div id="sidebar" class="hidden">
        <!-- ‚úÖ HEADER C·ªê ƒê·ªäNH (lu√¥n c√≥) -->
        <div class="sidebar-header">
            <h2 id="sidebar-title" data-translate="detail_info">Th√¥ng tin chi ti·∫øt</h2>
            <button id="closeSidebar">√ó</button>
        </div>
        
        <!-- ‚úÖ N·ªòI DUNG ƒê·ªòNG (render t·ª´ JS) -->
        <div id="sidebar-content"></div>
    </div>

    <!-- ‚úÖ MAP + N√öT QU√ÅN Y√äU TH√çCH -->
    <div id="map-container" style="position: relative;">
        <div id="map"></div>
    </div>
    <!-- üß© N√∫t Mini Game -->
    <button id="miniGameBtn" class="map-floating-btn mini-game-btn" title="Mini Game" data-translate-title="mini_game">
        üß©
    </button>
    
    <!-- ‚úÖ CHATBOT V√Ä FOOD PLAN BUTTONS - INJECT HERE -->
    <div id="insert-chatbot-and-map">
        <!-- Python s·∫Ω inject chatbot v√† food planner v√†o ƒë√¢y -->
    </div>
    
    <!-- üñºÔ∏è Popup zoom ·∫£nh -->
    <div id="imageModal" class="image-modal">
        <span id="closeModal">&times;</span>
        <img id="modalImg" src="" alt="Zoomed image">
    </div>
   

    <!-- üì¶ JAVASCRIPT LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- ‚úÖ MarkerCluster JS - QUAN TR·ªåNG! Ph·∫£i load SAU Leaflet -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Fuse.js for search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
    
    <!-- ‚úÖ Your custom script - Load CU·ªêI C√ôNG -->
    <script src="script.js"></script>
   

    
    <!-- üîê Script ki·ªÉm tra ƒëƒÉng nh·∫≠p -->
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
    
            // L·∫•y c√°c ph·∫ßn t·ª≠ n√∫t
            const guestButtons = document.querySelector('.guest-only');
            const userButton = document.querySelector('.user-only');

            // G·ªçi API tr√™n server Django
            fetch('/api/check-auth/', {
                method: 'GET',
                // B·∫ÆT BU·ªòC: G·ª≠i cookie (session) c√πng v·ªõi y√™u c·∫ßu
                credentials: 'include' 
            })
            .then(response => response.json())
            .then(data => {
                console.log('üîç Check auth response:', data); // ‚úÖ TH√äM d√≤ng n√†y
                // data s·∫Ω l√†: {is_authenticated: true} ho·∫∑c {is_authenticated: false}
                if (data.is_authenticated) {
                    // ƒê√£ ƒëƒÉng nh·∫≠p
                    if (guestButtons) guestButtons.style.display = 'none';
                    if (userButton) {
                        userButton.classList.add('show');  // ‚≠ê TH√äM class 'show'
                    }
                    console.log('Ch√†o m·ª´ng, ' + data.username);
                } else {
                    // Ch∆∞a ƒëƒÉng nh·∫≠p
                    if (guestButtons) guestButtons.style.display = 'block';
                    if (userButton) {
                        userButton.classList.remove('show');  // ‚≠ê X√ìA class 'show'
                    }
                }
            })
            .catch(error => {
                console.error('L·ªói khi ki·ªÉm tra x√°c th·ª±c:', error);
                // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã l√† ch∆∞a ƒëƒÉng nh·∫≠p n·∫øu API l·ªói
                if (guestButtons) guestButtons.style.display = 'block';
                if (userButton) userButton.style.display = 'none';
            });
        });
    </script>

    <!-- üß© MINI GAME OVERLAY -->
    <div id="miniGameOverlay" class="mini-game-overlay hidden">
        <div class="mini-game-wrapper">
            <!-- Header -->
            <div class="mini-game-header">
                <button id="miniGameCloseBtn" class="mini-game-home-btn" title="Tho√°t mini game" data-translate-title="exit_game">
                    ‚åÇ
                </button>
                <h2 class="mini-game-title" data-translate="game_title">
                    Gh√©p H√¨nh Vui Nh·ªôn (Jigsaw Puzzle)
                </h2>
            </div>

            <!-- Khu v·ª±c board gh√©p h√¨nh -->
            <div class="mini-game-content">
            <!-- üó∫Ô∏è MAP SELECTOR -->
        <div class="map-selector">
            <!-- üÜï TAB SWITCHER -->
            <div class="tab-switcher">
                <button class="tab-btn active" data-tab="maps" data-translate="select_map">
                    üéÆ Ch·ªçn Map
                </button>
                <button class="tab-btn" data-tab="achievements" data-translate="achievements">
                    üèÜ Th√†nh T·ª±u
                </button>
            </div>

                    <!-- üÜï TAB CONTENT: MAPS -->
                    <div class="tab-content active" id="tab-maps">
                        <button class="map-option active" data-map="banh_mi">
                            <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/banh_mi.png" alt="B√°nh M√¨">
                            <span data-translate="map_banh_mi">B√°nh M√¨</span>
                        </button>
                        <button class="map-option" data-map="com_tam">
                            <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/com_tam.png" alt="C∆°m T·∫•m">
                            <span data-translate="map_com_tam">C∆°m T·∫•m</span>
                        </button>
                        <button class="map-option" data-map="bun_bo_hue">
                            <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/bun_bo_hue.png" alt="B√∫n B√≤ Hu·∫ø">
                            <span data-translate="map_bun_bo_hue">B√∫n B√≤ Hu·∫ø</span>
                        </button>
                    </div>

                    <!-- üÜï TAB CONTENT: ACHIEVEMENTS -->
                    <div class="tab-content" id="tab-achievements">
                        <div class="achievements-container">
                            <!-- JavaScript s·∫Ω render n·ªôi dung v√†o ƒë√¢y -->
                            <p class="loading-achievements" data-translate="loading_achievements">ƒêang t·∫£i th√†nh t·ª±u...</p>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ TH√äM PH·∫¶N N√ÄY - GAME CONTAINER -->
                <div class="game-container">
                    <!-- ‚úÖ GAME HEADER (Timer, Moves, Shuffle) -->
                    <div class="game-header">
                        <div class="timer">
                            <span data-translate="time">‚è±Ô∏è Th·ªùi gian:</span> 
                            <span>0:00</span></div>
                        <div class="moves">
                            <span data-translate="moves">üîÑ S·ªë b∆∞·ªõc:
                            <span>0</span></div>
                        <button class="btn-shuffle" data-translate="shuffle">üîÄ X√°o l·∫°i</button>
                        <!-- N√∫t Reset s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông t·∫°i ƒë√¢y -->
                    </div>

                    <!-- PUZZLE BOARD -->
                    <div id="jigsawBoard" class="jigsaw-board">
                        <div id="board">
                            <svg id="puzzle" viewBox="0 0 1071 750" style="display:none"
                                xmlns="http://www.w3.org/2000/svg"
                                xmlns:xlink="http://www.w3.org/1999/xlink">

                                <defs>
                                    <!-- ·∫¢nh n·ªÅn -->
                                    <image id="full-img"
                                        href="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/banh_mi.png"
                                        x="0" y="0"
                                        width="1071" height="750" />

        <!-- 12 path m·∫£nh gh√©p t·ª´ SVG m·ªõi (1071x750) -->
    <path id="piece-0" d="M357 63.6807C373.569 63.6807 387 77.2552 387 94C387 110.745 373.569 124.319 357 124.319V189H207.994C207.727 172.444 194.402 159.106 178 159.106C161.598 159.106 148.273 172.444 148.006 189H0V-1H357V63.6807Z" />

    <path id="piece-1" d="M714 63C697.431 63 684 76.4315 684 93C684 109.569 697.431 123 714 123V188.22H565.994C565.997 188.388 566 188.556 566 188.725C566 205.445 552.569 219 536 219C519.431 219 506 205.445 506 188.725C506 188.556 506.003 188.388 506.006 188.22H357V124.138C373.569 124.138 387 110.583 387 93.8623C387 77.1418 373.569 63.5869 357 63.5869V-1H714V63Z" />

    <path id="piece-2" d="M893 158C909.569 158 923 171.431 923 188C923 188.335 922.992 188.668 922.981 189H1071V376.5H922.994C922.997 376.334 923 376.167 923 376C923 359.431 909.569 346 893 346C876.431 346 863 359.431 863 376C863 376.167 863.003 376.334 863.006 376.5H714V312.981C713.668 312.992 713.335 313 713 313C696.431 313 683 299.569 683 283C683 266.431 696.431 253 713 253C713.335 253 713.668 253.007 714 253.018V189H863.019C863.008 188.668 863 188.335 863 188C863 171.431 876.431 158 893 158Z" />

    <path id="piece-3" d="M178 158C194.569 158 208 171.431 208 188H357V249C340.431 249 327 262.431 327 279C327 295.569 340.431 309 357 309V375.5H208C208 392.069 194.569 405.5 178 405.5C161.431 405.5 148 392.069 148 375.5H0V188H148C148 171.431 161.431 158 178 158Z" />

    <path id="piece-4" d="M1071 190H922.994C922.727 173.444 909.402 160.106 893 160.106C876.598 160.106 863.273 173.444 863.006 190H714V123.64C697.432 123.64 684 110.03 684 93.2402C684 76.4508 697.431 62.8398 714 62.8398V0H1071V190Z" />

    <path id="piece-5" d="M178 532C194.569 532 208 545.431 208 562H357V629C373.569 629 387 642.431 387 659C387 675.569 373.569 689 357 689V749.5H0V562H148C148 545.431 161.431 532 178 532Z" />

    <path id="piece-6" d="M148 375C148 391.569 161.431 405 178 405C194.569 405 208 391.569 208 375H357V439C340.431 439 327 452.431 327 469C327 485.569 340.431 499 357 499V562.5H207.994C207.727 546.162 194.402 533 178 533C161.598 533 148.273 546.162 148.006 562.5H0V375H148Z" />

    <path id="piece-7" d="M893 345C909.569 345 923 358.431 923 375H1071V562.5H922.994C922.727 546.162 909.402 533 893 533C876.598 533 863.273 546.162 863.006 562.5H714V501C730.569 501 744 487.569 744 471C744 454.431 730.569 441 714 441V375H863C863 358.431 876.431 345 893 345Z" />

    <path id="piece-8" d="M536 345C552.569 345 566 358.431 566 375H714V441C730.569 441 744 454.431 744 471C744 487.569 730.569 501 714 501V562.5H565.994C565.727 546.162 552.402 533 536 533C519.598 533 506.273 546.162 506.006 562.5H357V500C340.431 500 327 486.569 327 470C327 453.431 340.431 440 357 440V375H506C506 358.431 519.431 345 536 345Z" />

    <path id="piece-9" d="M893 532C909.569 532 923 545.431 923 562H1071V749.5H714V686.981C713.668 686.992 713.335 687 713 687C696.431 687 683 673.569 683 657C683 640.431 696.431 627 713 627C713.335 627 713.668 627.007 714 627.018V562H863C863 545.431 876.431 532 893 532Z" />

    <path id="piece-10" d="M536 532C552.569 532 566 545.431 566 562C566 562.335 565.992 562.668 565.981 563H714V627.018C713.668 627.007 713.335 627 713 627C696.431 627 683 640.431 683 657C683 673.569 696.431 687 713 687C713.335 687 713.668 686.992 714 686.981V750.5H357V689C373.569 689 387 675.569 387 659C387 642.431 373.569 629 357 629V563H506.019C506.008 562.668 506 562.335 506 562C506 545.431 519.431 532 536 532Z" />

    <path id="piece-11" d="M506.019 188C506.546 204.106 519.766 217 536 217C552.234 217 565.454 204.106 565.981 188H714V253.018C713.668 253.007 713.335 253 713 253C696.431 253 683 266.431 683 283C683 299.569 696.431 313 713 313C713.335 313 713.668 312.992 714 312.981V375.5H565.994C565.727 359.162 552.402 346 536 346C519.598 346 506.273 359.162 506.006 375.5H357V309C340.431 309 327 295.569 327 279C327 262.431 340.431 249 357 249V188H506.019Z" />

    </defs>

                <!-- ·∫¢nh n·ªÅn m·ªù l√†m h√¨nh g·ª£i √Ω, d√πng CHUNG h·ªá t·ªça ƒë·ªô v·ªõi m·∫£nh gh√©p -->
    <image
        id="bg-hint-img"
        href="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/banh_mi.png"
        x="0" y="0"
        width="1071" height="750"
        preserveAspectRatio="none"
        opacity="0.18"
        style="pointer-events:none" />

        <!-- n∆°i ch·ª©a 12 m·∫£nh -->
        <g id="pieces"></g>
    </svg>
        </div>
    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="minigame.js"></script>

    <script>
    (function () {
    const notificationBtn = document.getElementById('notificationBtn');
    const overlay = document.getElementById('notificationOverlay');
    const notificationBadge = notificationBtn ? notificationBtn.querySelector('.notification-badge') : null;
    const closeBtn = document.getElementById('notificationCloseBtn');
    const listEl = document.getElementById('notificationList');
    const markAllBtn = document.getElementById('markAllAsReadBtn');

    if (!notificationBtn || !overlay) {
        return;
    }

    let notifications = [];
    let eventSource = null;

    async function deleteNotification(notificationId) {
        try {

            const itemEl = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
            if (itemEl) {
                itemEl.classList.add('deleting');
            }
            
            await new Promise(resolve => setTimeout(resolve, 400));

            const res = await fetch(`/api/accounts/notifications/${notificationId}/delete/`, {
                method: 'POST',
                credentials: 'include'
            });
            
            if (res.ok) {
                // X√≥a kh·ªèi m·∫£ng local
                notifications = notifications.filter(n => n.id != notificationId);
                
                // Re-render
                renderList();
                updateBadge();
                
            }
        } catch (err) {
            console.error('L·ªói khi x√≥a notification', err);
             // ‚úÖ TH√äM D·ªäCH
            const errorMsg = window.LanguageToggle ? 
                window.LanguageToggle.getTranslation('delete_notification_error') : 
                'L·ªói khi x√≥a th√¥ng b√°o';
            showToast('L·ªói khi x√≥a th√¥ng b√°o', 'error');
        }
    }

    function updateBadge() {
        if (!notificationBadge) return;
        const unread = notifications.filter(n => !n.is_read).length;
        if (unread > 0) {
        notificationBtn.classList.add('has-notification');
        notificationBadge.textContent = unread > 9 ? '9+' : String(unread);
        notificationBadge.style.display = 'block';
        } else {
        notificationBtn.classList.remove('has-notification');
        notificationBadge.style.display = 'none';
        }
    }

    function formatTimeVi(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return '';
        return d.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
        });
    }

    function closeAllOtherPopups(notificationType) {
        console.log('üî¥ ƒê√≥ng t·∫•t c·∫£ popup kh√°c...', 'Notification type:', notificationType);
        
        const isFoodPlannerNotification =
            notificationType === 'suggestion' || notificationType === 'share_plan';

        // üîπ CH·ªà ƒë√≥ng Food Planner n·∫øu KH√îNG ph·∫£i notification c·ªßa Food Planner
        if (!isFoodPlannerNotification) {
            const foodPlannerPanel = document.getElementById('foodPlannerPanel');
            const plannerBtn = document.getElementById('foodPlannerBtn');

            if (foodPlannerPanel && plannerBtn) {
                // Ch·ªâ click ƒë·ªÉ ƒë√≥ng n·∫øu hi·ªán t·∫°i ƒëang m·ªü
                const isOpen =
                    foodPlannerPanel.classList.contains('active') ||
                    foodPlannerPanel.classList.contains('show');

                if (isOpen) {
                    // d√πng ƒë√∫ng logic toggle c·ªßa Food Planner
                    plannerBtn.click();
                    console.log('‚úÖ ƒê√£ ƒë√≥ng Food Planner qua n√∫t b·∫•m');
                }
            }
        }
                
        // 2Ô∏è‚É£ ƒê√ìNG CHATBOT
        const chatWindow = document.getElementById('chatWindow');
        const chatbotBtn = document.getElementById('chatbotBtn');
        const speechBubble = document.getElementById('speechBubble');
        
        if (chatWindow) {
            chatWindow.style.display = 'none';
            chatWindow.classList.remove('open');
        }
        if (chatbotBtn) {
            chatbotBtn.style.display = 'block';
            chatbotBtn.classList.remove('hidden');
        }
        if (speechBubble) {
            speechBubble.style.display = 'block';
            speechBubble.classList.remove('hidden');
        }
        console.log('‚úÖ ƒê√£ ƒë√≥ng Chatbot');
        
        // 3Ô∏è‚É£ ƒê√ìNG MINI GAME
        const miniGameOverlay = document.getElementById('miniGameOverlay');
        if (miniGameOverlay) {
            miniGameOverlay.classList.add('hidden');
            miniGameOverlay.classList.remove('show');
            console.log('‚úÖ ƒê√£ ƒë√≥ng Mini Game');
        }
        
        // 4Ô∏è‚É£ ƒê√ìNG MUSIC PLAYER
        const musicPlayerOverlay = document.getElementById('musicPlayerOverlay');
        if (musicPlayerOverlay) {
            musicPlayerOverlay.classList.remove('show');
            console.log('‚úÖ ƒê√£ ƒë√≥ng Music Player');
        }
        
        // 5Ô∏è‚É£ ƒê√ìNG SIDEBAR (th√¥ng tin chi ti·∫øt qu√°n)
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.remove('show');
            console.log('‚úÖ ƒê√£ ƒë√≥ng Sidebar');
        }
    }

    function renderList() {
        if (!listEl) return;

        if (!notifications.length) {
        listEl.innerHTML =
            '<div class="notification-empty">' +
            '<div class="notification-empty-icon">üß°</div>' +
            '<div class="notification-empty-text" data-translate="notification_empty_message">Hi·ªán t·∫°i b·∫°n ch∆∞a c√≥ th√¥ng b√°o n√†o.</div>' +
            '</div>';

            // ‚úÖ QUAN TR·ªåNG: Apply translation ngay sau khi render
        setTimeout(function() {
        if (window.LanguageToggle) {
            const emptyText = listEl.querySelector('[data-translate="notification_empty_message"]');
            if (emptyText) {
                const lang = window.LanguageToggle.getCurrentLanguage();
                const translations = {
                    vi: 'Hi·ªán t·∫°i b·∫°n ch∆∞a c√≥ th√¥ng b√°o n√†o.',
                    en: 'You don\'t have any notifications yet.'
                };
                emptyText.textContent = window.LanguageToggle.getTranslation('notification_empty_message') || translations[lang];
            }
        }
        }, 100); // Ch·ªù 100ms ƒë·ªÉ LanguageToggle kh·ªüi t·∫°o xong

    if (window.LanguageToggle && typeof window.LanguageToggle.applyTranslations === "function") {
        window.LanguageToggle.applyTranslations();
      }
        return;
        }

        const itemsHtml = notifications
            .slice()
            .sort(function (a, b) {
                return new Date(b.created_at) - new Date(a.created_at);
            })
            .map(function (n) {
                    // ‚úÖ L·∫§Y TRANSLATION TR∆Ø·ªöC KHI RENDER
                const statusKey = n.is_read ? 'notification_read_status' : 'notification_new_status';
                const statusText = window.LanguageToggle ? 
                    window.LanguageToggle.getTranslation(statusKey) : 
                    (n.is_read ? 'ƒê√£ ƒë·ªçc' : 'M·ªõi');
                    
                return (
                '<div class="notification-item ' + (n.is_read ? 'read' : '') + '" data-id="' + n.id + '">' +
                    '<div class="notification-item-title">' + n.title + '</div>' +
                    '<div class="notification-item-message">' + n.message + '</div>' +
                    (n.created_at ? 
                        '<div class="notification-item-meta">' +
                            formatTimeVi(n.created_at) +
                            '<div class="notification-item-meta-right">' +
                                '<span class="notification-status-badge">' +
                                    statusText +
                                '</span>' +
                                '<button class="notification-item-delete" data-id="' + n.id + '" title="X√≥a th√¥ng b√°o">' +
                                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                                        '<polyline points="3 6 5 6 21 6"/>' +
                                        '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>' +
                                    '</svg>' +
                                '</button>' +
                            '</div>' +
                        '</div>'
                    : '') +
                '</div>'
            );
            })
            .join('');

        listEl.innerHTML = itemsHtml;
        
        if (window.LanguageToggle && typeof window.LanguageToggle.applyTranslations === "function") {
        window.LanguageToggle.applyTranslations();
           }

        const itemEls = listEl.querySelectorAll('.notification-item');
        itemEls.forEach(function (el) {
            el.addEventListener('click', function () {
                const id = el.getAttribute('data-id');
                const item = notifications.find(function (n) { return n.id == id; });
                if (!item) return;
                
                closeAllOtherPopups(item.type);
                handleNotificationClick(item);
                markNotificationAsRead(item.id);
            });
        });

        const deleteButtons = listEl.querySelectorAll('.notification-item-delete');
        deleteButtons.forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.stopPropagation(); // NgƒÉn trigger click v√†o notification-item
                
                const id = btn.getAttribute('data-id');
                
                // X√°c nh·∫≠n x√≥a
                if (confirm(window.LanguageToggle.getTranslation('delete_notification_confirm'))) {
                    deleteNotification(id);
                }
            });
        });
    }

    function openOverlay() {
        overlay.classList.add('show');
        document.body.style.overflow = 'hidden';

        // ‚ú® TH√äM ANIMATION CH·ªà KHI M·ªû POPUP
        setTimeout(function() {
            const newItems = listEl.querySelectorAll('.notification-item:not(.read)');
            newItems.forEach(function(item, index) {
                item.classList.add('new-item'); // Th√™m class ƒë·ªÉ ·∫©n ban ƒë·∫ßu
                setTimeout(function() {
                    item.classList.remove('new-item');
                    item.classList.add('slide-in');
                }, index * 1000); // Delay 100ms gi·ªØa m·ªói item
            });
        }, 50);

    }

    function closeOverlay() {
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }

    notificationBtn.addEventListener('click', () => {
        // ‚úÖ ƒê√ìNG T·∫§T C·∫¢ POPUP KH√ÅC TR∆Ø·ªöC KHI M·ªû TH√îNG B√ÅO
        closeAllOtherPopups(null);
        openOverlay();
    });

    if (closeBtn) {
        closeBtn.addEventListener('click', closeOverlay);
    }

    overlay.addEventListener('click', function (e) {
        if (e.target === overlay) {
        closeOverlay();
        }
    });

    if (markAllBtn) {
        markAllBtn.addEventListener('click', function () {
        markAllNotificationsAsRead();
        });
    }

    // ========== X√ìA T·∫§T C·∫¢ TH√îNG B√ÅO ==========
    const deleteAllBtn = document.getElementById('deleteAllNotificationsBtn');

    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', async function () {
            // ‚úÖ X√ÅC NH·∫¨N TR∆Ø·ªöC KHI X√ìA
            if (!confirm(window.LanguageToggle.getTranslation('delete_all_confirm'))) {
                return;
            }
            
            try {
                const res = await fetch('/api/accounts/notifications/clear-all/', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (res.ok) {
                    const data = await res.json();
                    
                    // ‚úÖ X√ìA TO√ÄN B·ªò DANH S√ÅCH LOCAL
                    notifications = [];
                    renderList();
                    updateBadge();
                }
            } catch (err) {
                console.error('‚ùå L·ªói x√≥a t·∫•t c·∫£ notifications:', err);
                showToast('‚ùå L·ªói k·∫øt n·ªëi', 'error');
            }
        });
    }

    function handleNotificationClick(item) {
        // üåü 1. Th√¥ng b√°o ai ƒë√≥ xem qu√°n y√™u th√≠ch ‚Üí Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi xem
        if (item.type === 'favorite_viewed') {
            // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi ƒë√£ xem
            markNotificationAsRead(item.id);
            return; // ‚ö†Ô∏è RETURN S·ªöM - KH√îNG ƒë√≥ng popup th√¥ng b√°o
        }

        if (item.type === 'friend_accepted') {
            markNotificationAsRead(item.id);
            return; // ‚ö†Ô∏è Ch·ªâ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc, kh√¥ng l√†m g√¨ th√™m
        }

        closeOverlay();
        // üåü 2. Th√¥ng b√°o k·∫øt b·∫°n ‚Üí nh·∫£y sang Account
        if (item.type === 'friend_request') {
            try {
                localStorage.setItem('openFriendRequestsTab', '1');
            } catch (e) {
                console.warn('Kh√¥ng l∆∞u ƒë∆∞·ª£c flag', e);
            }
            window.location.href = 'Account.html';
            return;
        }

        // ‚úÖ CH·ªú 300MS ƒê·ªÇ POPUP ƒê√ìNG HO√ÄN TO√ÄN TR∆Ø·ªöC KHI M·ªû FOOD PLANNER
        setTimeout(function() {
            // üåü 3. M·ªü bubble Food Planner
            var plannerBtn = document.getElementById('foodPlannerBtn');
            if (plannerBtn) {
                plannerBtn.click();
            }

            // üåü 4. Load plan (d√πng cho c·∫£ suggestion & share plan)
            if (item.related_id && typeof loadSavedPlans === 'function') {
                setTimeout(function () {
                    try {
                        loadSavedPlans(item.related_id, true);

                        // ‚ö† Ch·ªâ notification "suggestion" m·ªõi c·∫ßn scroll
                        if (item.type !== 'suggestion') {
                            return; // share plan & lo·∫°i kh√°c: d·ª´ng ·ªü ƒë√¢y, KH√îNG scroll
                        }

                        // üåü 4. Scroll t·ªõi planResult (ch·ªâ cho suggestion)
                        setTimeout(function () {
                            const planResult = document.getElementById('planResult');
                            const savedPlansSection = document.getElementById('savedPlansSection');
                            
                            if (!planResult || !savedPlansSection) {
                               const errorMsg = window.LanguageToggle ? 
                                    window.LanguageToggle.getTranslation('element_not_found') : 
                                    '‚ùå Kh√¥ng t√¨m th·∫•y element';
                                console.error(errorMsg);
                                return;
                            }
                            
                            console.log('‚úÖ T√¨m th·∫•y planResult v√† savedPlansSection');
                            
                            // üîç T√åM PARENT CONTAINER C√ì SCROLL (bubble content)
                            let scrollContainer = savedPlansSection.parentElement;
                            
                            // T√¨m element c√≥ overflow: auto ho·∫∑c scroll
                            while (scrollContainer && scrollContainer !== document.body) {
                                const style = window.getComputedStyle(scrollContainer);
                                const overflow = style.overflow + style.overflowY;
                                
                                if (overflow.includes('auto') || overflow.includes('scroll')) {
                                    console.log('‚úÖ T√¨m th·∫•y scroll container:', scrollContainer.className || scrollContainer.id);
                                    break;
                                }
                                
                                scrollContainer = scrollContainer.parentElement;
                            }
                            
                            if (!scrollContainer || scrollContainer === document.body) {
                                const warnMsg = window.LanguageToggle ? 
                                        window.LanguageToggle.getTranslation('scroll_container_not_found') : 
                                        '‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y scroll container ph√π h·ª£p';
                                    console.warn(warnMsg);
                                    planResult.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                return;
                            }
                            
                            const planResultTop = planResult.offsetTop;
                            const containerHeight = scrollContainer.clientHeight;

                            // ƒê∆∞a planResult l√™n g·∫ßn ƒë·∫ßu container, c√°ch kho·∫£ng 80px
                            let targetScroll = planResultTop - 130;

                            // Kh√¥ng cho scroll qu√° gi·ªõi h·∫°n
                            const maxScroll = scrollContainer.scrollHeight - containerHeight;
                            if (targetScroll < 0) targetScroll = 0;
                            if (targetScroll > maxScroll) targetScroll = maxScroll;

                            console.log('üîç Scroll t·ªõi', targetScroll);

                            scrollContainer.scrollTo({
                                top: targetScroll,
                                behavior: 'smooth'
                            });

                            // Th√™m hi·ªáu ·ª©ng highlight
                            planResult.style.transition = 'all 0.3s ease';
                            planResult.style.backgroundColor = 'rgba(255, 165, 0, 0.15)';
                            
                            setTimeout(function () {
                                planResult.style.backgroundColor = '';
                            }, 2000);
                            
                        }, 1000); // ch·ªù UI render xong tr∆∞·ªõc khi scroll

                    } catch (e) {
                        const errorMsg = window.LanguageToggle ? 
                            window.LanguageToggle.getTranslation('load_saved_plans_error') : 
                            'L·ªói loadSavedPlans';
                        console.error(errorMsg, e);
                    }
                }, 350);
            }
        }, 100); // ‚úÖ CH·ªú 300MS TR∆Ø·ªöC KHI M·ªû FOOD PLANNER
    }

    // ================================
    // üîî LOAD INITIAL NOTIFICATIONS
    // ================================
    async function loadNotifications() {
        try {
        const res = await fetch('/api/accounts/notifications/', {
            credentials: 'include'
        });
        
        if (!res.ok) {
           // ‚úÖ TH√äM D·ªäCH
            const errorMsg = window.LanguageToggle ? 
                window.LanguageToggle.getTranslation('notification_load_error') : 
                'Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng b√°o';
            console.warn(errorMsg, res.status);
            console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng b√°o:', res.status);
            return;
        }

        const data = await res.json();
        notifications = data.notifications || [];
        
        renderList();
        updateBadge();
        } catch (err) {
        // ‚úÖ TH√äM D·ªäCH
        const errorMsg = window.LanguageToggle ? 
            window.LanguageToggle.getTranslation('notification_load_error') : 
            'L·ªói load notifications';
        console.error(errorMsg, err);
        }
    }

    // ================================
    // üì¢ SSE - REAL-TIME CONNECTION
    // ================================
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    const RECONNECT_DELAY = 5000; // 5 gi√¢y

    function connectSSE() {
        // ƒê√≥ng connection c≈© n·∫øu c√≥
        if (eventSource) {
            eventSource.close();
        }

        console.log('üîå Connecting to SSE...');

        // ‚úÖ S·ª¨A: ƒê·∫£m b·∫£o URL ƒë√∫ng format
        const sseUrl = '/api/accounts/notifications/stream/';
        
        eventSource = new EventSource(sseUrl, {
            withCredentials: true
        });

        eventSource.onopen = function(event) {
            console.log('   ReadyState:', eventSource.readyState); // ‚úÖ TH√äM debug
            console.log('   URL:', eventSource.url);
            const msg = window.LanguageToggle ? 
                    window.LanguageToggle.getTranslation('sse_connected') : 
                    '‚úÖ SSE Connected';
            console.log(msg);
            reconnectAttempts = 0;
        };

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                console.log('üì© SSE Message:', data.type);

                if (data.type === 'connected') {
                    console.log('‚úÖ', data.message);
                }
                
                else if (data.type === 'new_notifications') {
                    console.log('üîî New notifications:', data.notifications.length);
                    
                    // ‚úÖ TH√äM TH√îNG B√ÅO M·ªöI V√ÄO ƒê·∫¶U DANH S√ÅCH
                    data.notifications.forEach(function(newNotif) {
                        const exists = notifications.find(n => n.id === newNotif.id);
                        if (!exists) {
                            notifications.unshift(newNotif);
                        }
                    });
                    
                    renderList();
                    updateBadge();
                    
                    // ‚úÖ HI·ªÇN TH·ªä TOAST NOTIFICATION
                    showToastNotification(data.notifications[0]);
                }
                
                else if (data.type === 'heartbeat') {
                    console.log('üíì Heartbeat at', data.timestamp);
                }
                
                else if (data.type === 'error') {
                    console.error('‚ùå SSE Error:', data.message);
                }
                
            } catch (err) {
                console.error('‚ùå Error parsing SSE data:', err);
            }
        };

        eventSource.onerror = function(error) {
            console.error('‚ùå SSE Error:', error);
            console.error('   ReadyState:', eventSource.readyState);
            console.error('   Status:', error.status || 'unknown');
            
            eventSource.close();
            
            // ‚úÖ RECONNECT LOGIC v·ªõi exponential backoff
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = RECONNECT_DELAY * reconnectAttempts;
                
                console.log(`üîÑ Reconnecting (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}) in ${delay/1000}s...`);
                
                setTimeout(connectSSE, delay);
            } else {
                const errorMsg = window.LanguageToggle ? 
                    window.LanguageToggle.getTranslation('sse_max_attempts') : 
                    '‚ùå Max reconnection attempts reached. Please refresh page.';
                console.error(errorMsg);
                
                const toastMsg = window.LanguageToggle ? 
                    window.LanguageToggle.getTranslation('connection_lost_message') : 
                    '‚ö†Ô∏è M·∫•t k·∫øt n·ªëi th√¥ng b√°o. Vui l√≤ng t·∫£i l·∫°i trang.';
                showToast(toastMsg, 'error');
            }
        };
    }

    // ================================
    // üì¢ TOAST NOTIFICATION
    // ================================
    function showToastNotification(notif) {
        // Ki·ªÉm tra quy·ªÅn th√¥ng b√°o tr√¨nh duy·ªát
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(notif.title, {
                body: notif.message,
                icon: '/static/Picture/UIAaa.png',
                badge: '/static/Picture/UIAaa.png',
                tag: 'notification-' + notif.id,
                requireInteraction: false // T·ª± ƒë·ªông ƒë√≥ng sau 5s
            });
        }
    }

    // ================================
    // üì¢ REQUEST NOTIFICATION PERMISSION
    // ================================
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                if (permission === 'granted') {
                    console.log('‚úÖ Notification permission granted');
                } else {
                    console.log('‚ÑπÔ∏è Notification permission denied - using toast only');
                }
            });
        }
    }

    // ================================
    // üì¢ INIT
    // ================================

    // Load th√¥ng b√°o ban ƒë·∫ßu
    loadNotifications();

    // K·∫øt n·ªëi SSE cho real-time updates
    connectSSE();

    // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o
    requestNotificationPermission();

    // Cleanup khi t·∫Øt trang
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            console.log('üîå Closing SSE connection...');
            eventSource.close();
        }
    });

    // ‚úÖ CHECK CONNECTION STATUS m·ªói 30 gi√¢y
    setInterval(function() {
        if (eventSource && eventSource.readyState !== EventSource.OPEN) {
            console.warn('‚ö†Ô∏è SSE connection lost. Reconnecting...');
            connectSSE();
        }
    }, 30000); // 30 seconds

    // ================================
    // üîî MARK AS READ
    // ================================
    async function markNotificationAsRead(notificationId) {
        try {
        const res = await fetch(`/api/accounts/notifications/${notificationId}/read/`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (res.ok) {
            const notif = notifications.find(n => n.id == notificationId);
            if (notif) {
            notif.is_read = true;
            }
            
            renderList();
            updateBadge();
        }
        } catch (err) {
            const errorMsg = window.LanguageToggle ? 
            window.LanguageToggle.getTranslation('mark_as_read_error') : 
             'L·ªói mark as read';
            console.error(errorMsg, err);
        }
    }

    async function markAllNotificationsAsRead() {
        try {
        const res = await fetch('/api/accounts/notifications/read-all/', {
            method: 'POST',
            credentials: 'include'
        });
        
        if (res.ok) {
            notifications.forEach(n => n.is_read = true);
            renderList();
            updateBadge();
        }
        } catch (err) {
            const errorMsg = window.LanguageToggle ? 
            window.LanguageToggle.getTranslation('mark_all_read_error') : 
            'L·ªói mark all as read';
            console.error(errorMsg, err);
        }
    }

    // ================================
    // üîî INIT
    // ================================
    
    // Load th√¥ng b√°o ban ƒë·∫ßu
    loadNotifications();
    
    // K·∫øt n·ªëi SSE cho real-time updates
    connectSSE();
    
    // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o
    requestNotificationPermission();
    
    // Cleanup khi t·∫Øt trang
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
        eventSource.close();
        }
    });
    
    })();
        // L·∫•y ng√¥n ng·ªØ hi·ªán t·∫°i
    const currentLang = window.LanguageToggle.getCurrentLanguage();
    console.log(currentLang); // 'vi' ho·∫∑c 'en'

    // ƒê·ªïi ng√¥n ng·ªØ b·∫±ng code
    window.LanguageToggle.setLanguage('en');

    // L·∫•y b·∫£n d·ªãch c·ªßa m·ªôt key
    const greeting = window.LanguageToggle.getTranslation('greeting');

    // ‚úÖ TH√äM EVENT LISTENER ƒê·ªÇ RE-RENDER KHI ƒê·ªîI NG√îN NG·ªÆ
    window.addEventListener('languageChanged', (e) => {
        console.log('üåê Notification: Language changed to:', e.detail.language);
        // Re-render l·∫°i notification list v·ªõi ng√¥n ng·ªØ m·ªõi
        renderList();
        
        // ‚úÖ Update c√°c button text kh√°c n·∫øu c√≥
        const markAllBtn = document.getElementById('markAllAsReadBtn');
        if (markAllBtn && window.LanguageToggle) {
            const btnText = markAllBtn.querySelector('[data-translate]');
            if (btnText) {
                const key = btnText.getAttribute('data-translate');
                btnText.textContent = window.LanguageToggle.getTranslation(key);
            }
        }
    });
    // L√†m g√¨ ƒë√≥ khi ƒë·ªïi ng√¥n ng·ªØ (reload data, update UI, etc.)
    </script>

    <script>
    function syncToggleWithLanguage() {
        const lang = localStorage.getItem("user_language") || "vi";

        // ƒê·ª£i cho t·ªõi khi LanguageToggle script load xong
        function wait() {
            if (window.LanguageToggle) {
                window.LanguageToggle.setLanguage(lang);
            } else {
                setTimeout(wait, 30);
            }
        }
        wait();
    }

    // Khi quay l·∫°i main_web, script n√†y ch·∫°y l·∫°i
    syncToggleWithLanguage();
    </script>

</body>
</html>