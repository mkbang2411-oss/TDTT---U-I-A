<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Web Demo</title>
    <link rel="stylesheet" href="Account.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <video class="bg-video" autoplay muted loop>
      <source src="Picture/bg1.mp4" type="video/mp4">
    </video>
    <div class="background-left">
      <img src="Picture/background2.png" class ="bg" alt="UIA Logo"/>
      <img src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/UIAaa.png" class="logo" alt="UIA Logo"/>
      <a href="/">
        <img
          src="https://res.cloudinary.com/dbmq2hme4/image/upload/Picture/ƒë.png"
          class="Button_back"
          alt="Back"
        />
      </a>
          <!--Side bar b√™n ph·∫£i-->
    <div class="sidebar-content">
      <div class="Menu">
        <div class="Menu_Account" onclick="showPage('Account_Page')">
          T√†i Kho·∫£n
        </div>
        <div class="Menu_Favorite" onclick="showPage('Favorite_Page')">
          Y√™u Th√≠ch
        </div>
        <div class="Menu_Friend" onclick="showPage('Friend_Page')">
          B·∫°n B√®
        </div>
        <div class="Menu_Logout" id="logout-button">ƒêƒÉng Xu·∫•t</div>
      </div>
    </div>
    
    </div>

    <div class="background-right">
      <img src="Picture/background3.png" class ="bga"/>
    </div>

    <div class="main-content">
      <!--Account-->
      <div id="Account_Page" class="page active">
        <div class="avatar">
          <div class="avatar-wrapper">
            <img src="Picture/avatar.png" class="avt" id="user-avatar-img"/>
            <div
              class="camera-btn"
              onclick="document.getElementById('avatar-upload-input').click()"
              style="
                position: fixed;
                left: 41vw;
                top: 40vh;
                background-color: #e4e6eb;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border: 2px solid white;
                transition: background 0.2s;
              "
            >
              <svg viewBox="0 0 24 24" width="22" height="22" fill="black">
                <path
                  d="M21.317 4.381H10.971L9.078 2.45c-.246-.251-.736-.45-1.089-.45H5.344c-.353 0-.843.199-1.089.45L2.362 4.381H2.683C1.204 4.381 0 5.593 0 7.081V18.32c0 1.488 1.204 2.699 2.683 2.699H21.317c1.479 0 2.683-1.211 2.683-2.699V7.081c0-1.488-1.204-2.7-2.683-2.7zM12 17.626c-3.146 0-5.697-2.568-5.697-5.735 0-3.167 2.55-5.735 5.697-5.735 3.147 0 5.697 2.568 5.697 5.735 0 3.167-2.55 5.735-5.697 5.735z"
                />
              </svg>
            </div>
          </div>
          <input
            type="file"
            id="avatar-upload-input"
            accept="image/*"
            style="display: none"
            onchange="handleFileSelect()"
          />
        </div>

        <div class="account_Info">
          <div class="form-group">
            <div class="input-box">
              <label>Email</label>
              <input
                type="email"
                id="user-email"
                placeholder="abc@gmail.com"
                readonly
                style="
                  background: rgba(255, 255, 255, 0.3); /* m·ªù m·ªù */
                  transition: all 0.3s;
                  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                  backdrop-filter: blur(15px);
                  -webkit-backdrop-filter: blur(15px);"
              />
            </div>

            <div class="input-box">
              <label>M·∫≠t kh·∫©u</label>
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="password"
                  id="main-password-display"
                  value="******"
                  disabled
                  style="flex: 1;
                  background: rgba(255, 255, 255, 0.3); /* m·ªù m·ªù */
                  transition: all 0.3s;
                  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                  backdrop-filter: blur(15px);
                  -webkit-backdrop-filter: blur(15px);"
                />

                <button
                  id="btn-open-changepass"
                  onclick="openPassModal()"
                  style="
                    display: none;
                    padding: 10px 15px;
                    background: #ff3561;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    white-space: nowrap;
                    backdrop-filter: blur(15px);
                    -webkit-backdrop-filter: blur(15px);
                  "
                >
                  ƒê·ªïi m·∫≠t kh·∫©u
                </button>
              </div>
              <small
                id="google-note"
                style="
                  display: none;
                  color: #888;
                  margin-top: 5px;
                  font-style: italic;
                "
                >* T√†i kho·∫£n Google ƒë∆∞·ª£c qu·∫£n l√Ω b·∫£o m·∫≠t b·ªüi Google.</small
              >
            </div>

            <!-- Beautiful Password Change Modal -->
            <div id="password-modal" class="password-modal-overlay">
              <div class="password-modal-content">
                <div class="password-modal-header">
                  <div class="header-content">
                    <div class="icon-wrapper">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        width="45"
                        height="45"
                        fill="white"
                      >
                        <path
                          d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"
                        />
                      </svg>
                    </div>
                    <h1>ƒê·ªïi m·∫≠t kh·∫©u</h1>
                    <p>B·∫£o v·ªá t√†i kho·∫£n v·ªõi m·∫≠t kh·∫©u m·∫°nh üîí</p>
                  </div>
                  <span class="close-password-modal" onclick="closePassModal()"
                    >&times;</span
                  >
                </div>

                <div class="password-modal-body">
                  <form id="change-password-form">
                    <div class="form-group-pass">
                      <label for="inp-old-pass">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                      <div class="password-wrapper">
                        <input
                          type="password"
                          id="inp-old-pass"
                          placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i..."
                          required
                        />
                        <button
                          type="button"
                          class="toggle-password"
                          id="toggle-old"
                          title="Hi·ªán/·∫®n m·∫≠t kh·∫©u"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="eye-open"
                          >
                            <path
                              d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                            ></path>
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="eye-closed"
                          >
                            <path
                              d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                            ></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                          </svg>
                        </button>
                      </div>
                    </div>

                    <div
                      id="password-error-message"
                      class="validation-message error"
                      style="display: none; margin-bottom: 20px"
                    ></div>

                    <div class="form-group-pass">
                      <label for="inp-new-pass">M·∫≠t kh·∫©u m·ªõi</label>
                      <div class="password-wrapper">
                        <input
                          type="password"
                          id="inp-new-pass"
                          placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..."
                          required
                        />
                        <button
                          type="button"
                          class="toggle-password"
                          id="toggle-new"
                          title="Hi·ªán/·∫®n m·∫≠t kh·∫©u"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="eye-open"
                          >
                            <path
                              d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                            ></path>
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="eye-closed"
                          >
                            <path
                              d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                            ></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                          </svg>
                        </button>
                      </div>
                      <div
                        id="strength-indicator-change"
                        class="strength-indicator"
                      ></div>
                      <div class="requirements">
                        <div class="requirement" id="req-length-change">
                          <span class="icon">‚óã</span> √çt nh·∫•t 8 k√Ω t·ª±
                        </div>
                        <div class="requirement" id="req-uppercase-change">
                          <span class="icon">‚óã</span> C√≥ ch·ªØ in hoa (A-Z)
                        </div>
                        <div class="requirement" id="req-lowercase-change">
                          <span class="icon">‚óã</span> C√≥ ch·ªØ th∆∞·ªùng (a-z)
                        </div>
                        <div class="requirement" id="req-number-change">
                          <span class="icon">‚óã</span> C√≥ s·ªë (0-9)
                        </div>
                      </div>
                    </div>

                    <div class="form-group-pass">
                      <label for="inp-confirm-pass"
                        >X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label
                      >
                      <div class="password-wrapper">
                        <input
                          type="password"
                          id="inp-confirm-pass"
                          placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi..."
                          required
                        />
                        <button
                          type="button"
                          class="toggle-password"
                          id="toggle-confirm"
                          title="Hi·ªán/·∫®n m·∫≠t kh·∫©u"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="eye-open"
                          >
                            <path
                              d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                            ></path>
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="eye-closed"
                          >
                            <path
                              d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                            ></path>
                            <line x1="1" y1="1" x2="23" y2="23"></line>
                          </svg>
                        </button>
                      </div>
                      <div
                        id="confirm-validation-change"
                        class="validation-message"
                      ></div>
                    </div>

                    <button
                      type="submit"
                      class="btn-change-password"
                      id="btn-submit-change"
                    >
                      ƒê·ªïi m·∫≠t kh·∫©u
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="avatar-modal" class="modal-overlay" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h3>C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán</h3>
              <span class="close-modal" onclick="closeModal()">√ó</span>
            </div>

            <div class="modal-body">
              <p>Xem tr∆∞·ªõc ·∫£nh c·ªßa b·∫°n</p>
              <div class="preview-container">
                <img id="avatar-preview-img" src="" alt="Preview" />
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
              <button class="btn-save" onclick="confirmUpload()">L∆∞u</button>
            </div>
          </div>
        </div>
      </div>

      <!--Favorite-->
      <div id="Favorite_Page" class="page">
        <div id="favorites-list" class="favorites-grid-container">
          <p style="text-align: center; color: #666">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
        <!-- Pagination Controls -->
        <div id="pagination-controls" class="pagination-wrapper" style="display: none;">
          <button class="pagination-btn" id="prev-page-btn" onclick="changePage(-1)">‚óÄ Tr∆∞·ªõc</button>
          <div id="page-numbers" class="page-numbers"></div>
          <button class="pagination-btn" id="next-page-btn" onclick="changePage(1)">Sau ‚ñ∂</button>
        </div>
      </div>

      <!--Friends-->
      <div id="Friend_Page" class="page">
        <!-- TABS -->
        <div class="friend-tabs">
          <button class="tab-btn active" onclick="switchTab('search')">
            üîç T√¨m ki·∫øm
          </button>
          <button class="tab-btn" onclick="switchTab('requests')">
            üì® L·ªùi m·ªùi K·∫øt b·∫°n (<span id="request-count">0</span>)
          </button>
          <button class="tab-btn" onclick="switchTab('list')">
            üë• Danh s√°ch b·∫°n
          </button>
        </div>

        <!-- TAB 1: T√åM KI·∫æM -->
        <div id="search-tab" class="tab-content active">
          <div class="search-container">
            <div class="search-box">
              <input
                type="email"
                id="search-input"
                class="search-input"
                placeholder="Nh·∫≠p email ƒë·ªÉ t√¨m b·∫°n b√®..."
              />
              <button class="search-button" onclick="searchUsers()">üîé</button>
            </div>
          </div>
          <div id="search-results" class="friends-list"></div>
        </div>

        <!-- TAB 2: L·ªúI M·ªúI K·∫æT B·∫†N -->
        <div id="requests-tab" class="tab-content">
          <div id="friend-requests" class="friends-list"></div>
        </div>

        <!-- TAB 3: DANH S√ÅCH B·∫†N B√à -->
        <div id="list-tab" class="tab-content">
          <div id="friends-list" class="friends-list"></div>
        </div>
      </div>
    </div>
    <!-- JAVASCRIPT -->
    <script>
      const API_URL = "/api/accounts";
      let CURRENT_USER_ID = null;
      let isLoadingUser = false; // ‚úÖ Th√™m flag

      // ‚úÖ L·∫§Y TH√îNG TIN USER HI·ªÜN T·∫†I
      async function loadCurrentUser() {
        if (isLoadingUser) return; // ‚úÖ Tr√°nh g·ªçi nhi·ªÅu l·∫ßn
        isLoadingUser = true;

        try {
          const response = await fetch(`${API_URL}/current-user/`, {
            credentials: "include", // ‚úÖ G·ª≠i cookie
          });

          if (response.status === 401) {
            // User ch∆∞a ƒëƒÉng nh·∫≠p - redirect v·ªÅ login
            console.log("‚ö†Ô∏è User ch∆∞a ƒëƒÉng nh·∫≠p, redirect v·ªÅ login");
            window.location.href = '/accounts/login/';
            return;
          }

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          CURRENT_USER_ID = data.id;
          console.log("‚úÖ Current User ID:", CURRENT_USER_ID);
        } catch (error) {
          console.error("‚ùå Kh√¥ng th·ªÉ l·∫•y user hi·ªán t·∫°i:", error);
          // Redirect v·ªÅ login thay v√¨ hi·ªán alert
          window.location.href = '/accounts/login/';
        } finally {
          isLoadingUser = false;
        }
      }

      // ‚úÖ G·ªåI NGAY KHI TRANG LOAD
      loadCurrentUser();

      function showPage(pageId) {
        var pages = document.querySelectorAll(".page");
        pages.forEach(function (page) {
          page.classList.remove("active");
        });

        document.getElementById(pageId).classList.add("active");

        document.querySelectorAll(".Menu > div").forEach(function (menu) {
          menu.classList.remove("active");
        });

        if (pageId === "Account_Page") {
          document.querySelector(".Menu_Account").classList.add("active");
        } else if (pageId === "Favorite_Page") {
          document.querySelector(".Menu_Favorite").classList.add("active");
        } else if (pageId === "Friend_Page") {
          document.querySelector(".Menu_Friend").classList.add("active");
          // ‚úÖ ƒê·∫£m b·∫£o load xong user ID
          ensureUserLoaded().then(() => {
            loadFriendRequests();
            loadFriendsList();
          });
        }
      }

      // ‚úÖ TH√äM FUNCTION N√ÄY - ƒê·ª£i user load xong
      async function ensureUserLoaded() {
        if (CURRENT_USER_ID) return; // ƒê√£ c√≥ r·ªìi

        // ƒê·ª£i t·ªëi ƒëa 5 gi√¢y
        for (let i = 0; i < 50; i++) {
          if (CURRENT_USER_ID) return;
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        // N·∫øu v·∫´n ch∆∞a c√≥, th·ª≠ load l·∫°i
        if (!CURRENT_USER_ID) {
          await loadCurrentUser();
        }
      }

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        if (tabName === "search") {
          document
            .querySelector(".tab-btn:nth-child(1)")
            .classList.add("active");
          document.getElementById("search-tab").classList.add("active");
        } else if (tabName === "requests") {
          document
            .querySelector(".tab-btn:nth-child(2)")
            .classList.add("active");
          document.getElementById("requests-tab").classList.add("active");
          ensureUserLoaded().then(() => loadFriendRequests());
        } else if (tabName === "list") {
          document
            .querySelector(".tab-btn:nth-child(3)")
            .classList.add("active");
          document.getElementById("list-tab").classList.add("active");
          ensureUserLoaded().then(() => loadFriendsList());
        }
      }

    // üîî AUT0 M·ªû "B·∫°n B√®" + TAB "L·ªùi m·ªùi K·∫øt b·∫°n" N·∫æU ƒê∆Ø·ª¢C G·ªåI T·ª™ TH√îNG B√ÅO
    (function () {
      try {
        const shouldOpenFriendRequests = localStorage.getItem("openFriendRequestsTab");
        if (shouldOpenFriendRequests === "1") {
          // X√†i xong r·ªìi th√¨ x√≥a flag
          localStorage.removeItem("openFriendRequestsTab");

          // M·ªü trang B·∫°n B√®
          showPage("Friend_Page");
          // M·ªü lu√¥n tab L·ªùi m·ªùi
          switchTab("requests");
        }
      } catch (e) {
        console.warn("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c openFriendRequestsTab t·ª´ localStorage:", e);
      }
    })();

      // T√åM KI·∫æM USER
      async function searchUsers() {
        const query = document.getElementById("search-input").value.trim();
        if (!query) {
          Swal.fire("L·ªói", "Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm", "warning");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/users/search/?q=${query}`);
          const data = await response.json();

          const resultsDiv = document.getElementById("search-results");
          if (data.users && data.users.length > 0) {
            resultsDiv.innerHTML = data.users
              .map(
                (user) => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${user.username}</div>
                                    <div class="friend-email">${user.email}</div>
                                </div>
                            </div>
                            <button class="btn-add" onclick="sendFriendRequest(${user.id})">‚ûï K·∫øt b·∫°n</button>
                        </div>
                    `
              )
              .join("");
          } else {
            resultsDiv.innerHTML =
              '<p class="no-data">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</p>';
          }
        } catch (error) {
          console.error("L·ªói t√¨m ki·∫øm:", error);
          Swal.fire("L·ªói", "Kh√¥ng th·ªÉ t√¨m ki·∫øm", "error");
        }
      }

      // G·ª¨I L·ªúI M·ªúI K·∫æT B·∫†N
      async function sendFriendRequest(receiverId) {
        // ‚úÖ ƒê·∫£m b·∫£o ƒë√£ load user ID
        await ensureUserLoaded();

        if (!CURRENT_USER_ID) {
          Swal.fire(
            "L·ªói",
            "Kh√¥ng th·ªÉ x√°c ƒë·ªãnh user hi·ªán t·∫°i. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.",
            "error"
          );
          return;
        }

        console.log(
          `üì§ G·ª≠i l·ªùi m·ªùi: sender=${CURRENT_USER_ID}, receiver=${receiverId}`
        );

        try {
          const response = await fetch(`${API_URL}/friend-request/send/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include", // ‚úÖ Th√™m
            body: JSON.stringify({
              sender_id: CURRENT_USER_ID,
              receiver_id: receiverId,
            }),
          });

          const data = await response.json();
          if (data.success) {
            Swal.fire("Th√†nh c√¥ng", "ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n", "success");
          } else {
            Swal.fire("L·ªói", data.error, "error");
          }
        } catch (error) {
          console.error("L·ªói g·ª≠i l·ªùi m·ªùi:", error);
          Swal.fire("L·ªói", "Kh√¥ng th·ªÉ g·ª≠i l·ªùi m·ªùi", "error");
        }
      }

      // T·∫¢I DANH S√ÅCH B·∫†N B√à
      async function loadFriendsList() {
        if (!CURRENT_USER_ID) {
          console.log("‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/friends/${CURRENT_USER_ID}/`
          );
          const data = await response.json();

          const friendsDiv = document.getElementById("friends-list");
          if (data.friends && data.friends.length > 0) {
            friendsDiv.innerHTML = data.friends
              .map(
                (friend) => `
                          <div class="friend-card">
                              <div class="friend-info">
                                  <div class="friend-avatar">üë§</div>
                                  <div>
                                      <div class="friend-name">${friend.username}</div>
                                      <div class="friend-email">${friend.email}</div>
                                  </div>
                              </div>
                              <div class="btn-group">
                                  <button class="btn-chat" onclick="viewFriendFavorites(${friend.id}, '${friend.username}')">‚ù§Ô∏è Qu√°n y√™u th√≠ch</button>
                                  <button class="btn-reject" onclick="unfriendUser(${friend.id}, '${friend.username}')">üóëÔ∏è H·ªßy k·∫øt b·∫°n</button>
                              </div>
                          </div>
                      `
              )
              .join("");
          } else {
            friendsDiv.innerHTML = '<p class="no-data">Ch∆∞a c√≥ b·∫°n b√® n√†o</p>';
          }
        } catch (error) {
          console.error("L·ªói t·∫£i danh s√°ch b·∫°n:", error);
        }
      }

      // XEM QU√ÅN Y√äU TH√çCH C·ª¶A B·∫†N B√à - HI·ªÇN TH·ªä TR√äN B·∫¢N ƒê·ªí
      async function viewFriendFavorites(friendId, friendName) {
        try {
          console.log("üì§ [VIEW FAVORITES] Starting...");
          console.log("üì§ [VIEW FAVORITES] Friend ID:", friendId);
          console.log("üì§ [VIEW FAVORITES] Friend Name:", friendName);
          console.log("üì§ [VIEW FAVORITES] API URL:", `${API_URL}/friend/${friendId}/favorites/`);

          const response = await fetch(
            `${API_URL}/friend/${friendId}/favorites/`,
            {
              credentials: "include",
            }
          );

          console.log("üì• [VIEW FAVORITES] Response status:", response.status);
          const data = await response.json();
          console.log("üì¶ [VIEW FAVORITES] Data:", data);

          if (data.status === "success") {
            console.log("‚úÖ [VIEW FAVORITES] Status is success");
            
            if (data.favorites && data.favorites.length > 0) {
              console.log("‚úÖ [VIEW FAVORITES] Has favorites:", data.favorites.length);
              
              // ‚úÖ‚úÖ‚úÖ GHI NH·∫¨N L∆Ø·ª¢T XEM - CRITICAL SECTION ‚úÖ‚úÖ‚úÖ
              console.log("üî• [RECORD VIEW] ===== STARTING RECORD VIEW =====");
              
              try {
                // 1Ô∏è‚É£ Ki·ªÉm tra getCookie
                const csrfToken = getCookie('csrftoken');
                console.log("üîë [RECORD VIEW] CSRF Token:", csrfToken ? "‚úÖ Found" : "‚ùå Not found");
                console.log("üîë [RECORD VIEW] CSRF Token value:", csrfToken);
                
                // 2Ô∏è‚É£ Chu·∫©n b·ªã URL
                const viewUrl = `${API_URL}/friend/${friendId}/favorites/view/`;
                console.log("üåê [RECORD VIEW] View URL:", viewUrl);
                
                // 3Ô∏è‚É£ Chu·∫©n b·ªã headers
                const headers = {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrfToken || ''
                };
                console.log("üìã [RECORD VIEW] Headers:", headers);
                
                // 4Ô∏è‚É£ G·ªçi API
                console.log("üì° [RECORD VIEW] Calling API...");
                const viewResponse = await fetch(viewUrl, {
                  method: 'POST',
                  credentials: 'include',
                  headers: headers
                });

                console.log("üìä [RECORD VIEW] Response status:", viewResponse.status);
                console.log("üìä [RECORD VIEW] Response ok:", viewResponse.ok);
                
                // 5Ô∏è‚É£ ƒê·ªçc response
                const viewData = await viewResponse.json();
                console.log("üì¶ [RECORD VIEW] Response data:", viewData);
                
                if (viewResponse.ok) {
                  console.log("‚úÖ [RECORD VIEW] SUCCESS!");
                } else {
                  console.error("‚ùå [RECORD VIEW] FAILED - Status:", viewResponse.status);
                  console.error("‚ùå [RECORD VIEW] Error data:", viewData);
                }
                
              } catch (viewError) {
                console.error("üí• [RECORD VIEW] EXCEPTION:", viewError);
                console.error("üí• [RECORD VIEW] Error stack:", viewError.stack);
              }
              
              console.log("üî• [RECORD VIEW] ===== FINISHED RECORD VIEW =====");

              // L∆∞u v√†o localStorage
              console.log("üíæ [VIEW FAVORITES] Saving to localStorage...");
              localStorage.setItem(
                "friendFavorites",
                JSON.stringify({
                  friendName: friendName,
                  places: data.favorites,
                })
              );
              console.log("üíæ [VIEW FAVORITES] Saved successfully");

              // Chuy·ªÉn sang trang map
              console.log("üîÑ [VIEW FAVORITES] Redirecting to map...");
              window.location.href = "/?view=friend-favorites";
            } else {
              console.warn("‚ö†Ô∏è [VIEW FAVORITES] No favorites found");
              Swal.fire(
                "Th√¥ng b√°o",
                `${friendName} ch∆∞a c√≥ qu√°n y√™u th√≠ch n√†o`,
                "info"
              );
            }
          } else {
            console.error("‚ùå [VIEW FAVORITES] Status not success:", data.status);
            console.error("‚ùå [VIEW FAVORITES] Error:", data.error);
            Swal.fire("L·ªói", data.error, "error");
          }
        } catch (error) {
          console.error("üí• [VIEW FAVORITES] EXCEPTION:", error);
          console.error("üí• [VIEW FAVORITES] Error stack:", error.stack);
          Swal.fire("L·ªói", "Kh√¥ng th·ªÉ t·∫£i danh s√°ch y√™u th√≠ch", "error");
        }
      }

      // T√¨m ki·∫øm khi nh·∫•n Enter
      document
        .getElementById("search-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            searchUsers();
          }
        });

      // H√ÄM L·∫§Y CSRF TOKEN T·ª™ COOKIE
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      document
        .getElementById("logout-button")
        .addEventListener("click", function (e) {
          e.preventDefault(); // NgƒÉn th·∫ª <a> chuy·ªÉn trang

          Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn?",
            text: "B·∫°n s·∫Øp ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "ƒê√∫ng, ƒêƒÉng xu·∫•t!",
            cancelButtonText: "H·ªßy",
          }).then((result) => {
            if (result.isConfirmed) {
              // N·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω, g·ªçi API ƒëƒÉng xu·∫•t c·ªßa Django
              fetch("/accounts/logout/", {
                method: "POST",
                headers: {
                  // Django ƒë·ªçc CSRF token t·ª´ cookie
                  "X-CSRFToken": getCookie("csrftoken"),
                  "X-Requested-With": "XMLHttpRequest",
                },

                // B·∫£o tr√¨nh duy·ªát g·ª≠i cookie (phi√™n ƒëƒÉng nh·∫≠p)
                // t·ª´ c·ªïng 5000 sang c·ªïng 8000
                credentials: "include",
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Server t·ª´ ch·ªëi. L·ªói " + response.status);
                  }
                  // Y√™u c·∫ßu allauth tr·∫£ v·ªÅ JSON
                  return response.json();
                })
                .then((data) => {
                  Swal.fire(
                    "ƒê√£ ƒëƒÉng xu·∫•t!",
                    "B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.",
                    "success"
                  );

                  // Ch·ªù 2 gi√¢y r·ªìi chuy·ªÉn v·ªÅ trang ch·ªß
                  setTimeout(() => {
                    window.location.href = "/";
                  }, 2000);
                })
                .catch((error) => {
                  console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
                  Swal.fire(
                    "L·ªói!",
                    "C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t t·ª´ server.",
                    "error"
                  );
                });
            }
          });
        });
      const BACKEND_URL = "";

      // C√°c bi·∫øn to√†n c·ª•c cho Modal
      let selectedFile = null;
      const modal = document.getElementById("avatar-modal");
      const previewImg = document.getElementById("avatar-preview-img");
      const passModal = document.getElementById("password-modal");

      // 1. H√†m t·∫£i th√¥ng tin user t·ª´ API v√† ƒëi·ªÅn v√†o form
      function loadUserInfo() {
        fetch(`${BACKEND_URL}/api/user-info/`, {
          method: "GET",
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Avatar & Email
              document.getElementById("user-avatar-img").src = data.avatar_url;
              const emailInput = document.getElementById("user-email");
              if (emailInput) emailInput.value = data.email || "";

              // X·ª≠ l√Ω N√∫t ƒë·ªïi m·∫≠t kh·∫©u
              const btnChangePass = document.getElementById(
                "btn-open-changepass"
              );
              const googleNote = document.getElementById("google-note");

              if (data.is_social_login) {
                // N·∫øu l√† Google: ·∫®n n√∫t ƒë·ªïi pass, Hi·ªán ghi ch√∫
                if (btnChangePass) btnChangePass.style.display = "none";
                if (googleNote) googleNote.style.display = "block";
              } else {
                // N·∫øu l√† Django: Hi·ªán n√∫t ƒë·ªïi pass, ·∫®n ghi ch√∫
                if (btnChangePass) btnChangePass.style.display = "block";
                if (googleNote) googleNote.style.display = "none";
              }
            }
          })
          .catch((err) => console.error("L·ªói t·∫£i th√¥ng tin:", err));
      }
      function openPassModal() {
        const modal = document.getElementById("password-modal");

        if (!modal) return;

        // Reset c√°c √¥ input
        document.getElementById("inp-old-pass").value = "";
        document.getElementById("inp-new-pass").value = "";
        document.getElementById("inp-confirm-pass").value = "";

        // Reset validation messages
        document.getElementById("password-error-message").style.display =
          "none";
        document.getElementById("strength-indicator-change").className =
          "strength-indicator";
        document.getElementById("confirm-validation-change").className =
          "validation-message";

        // Reset requirements
        ["length", "uppercase", "lowercase", "number"].forEach((req) => {
          const elem = document.getElementById(`req-${req}-change`);
          if (elem) {
            elem.classList.remove("met");
            elem.querySelector(".icon").textContent = "‚óã";
          }
        });

        // Show modal
        modal.style.display = "flex";
      }

      function closePassModal() {
        const modal = document.getElementById("password-modal");
        if (modal) {
          modal.style.display = "none";
        }
      }

      // Password visibility toggle
      document.addEventListener("DOMContentLoaded", function () {
        const toggleOld = document.getElementById("toggle-old");
        const toggleNew = document.getElementById("toggle-new");
        const toggleConfirm = document.getElementById("toggle-confirm");

        function togglePasswordVisibility(button, inputId) {
          const input = document.getElementById(inputId);
          const eyeOpen = button.querySelector(".eye-open");
          const eyeClosed = button.querySelector(".eye-closed");

          if (input.type === "password") {
            input.type = "text";
            eyeOpen.style.display = "none";
            eyeClosed.style.display = "block";
          } else {
            input.type = "password";
            eyeOpen.style.display = "block";
            eyeClosed.style.display = "none";
          }
        }

        if (toggleOld) {
          toggleOld.addEventListener("click", function () {
            togglePasswordVisibility(this, "inp-old-pass");
          });
        }

        if (toggleNew) {
          toggleNew.addEventListener("click", function () {
            togglePasswordVisibility(this, "inp-new-pass");
          });
        }

        if (toggleConfirm) {
          toggleConfirm.addEventListener("click", function () {
            togglePasswordVisibility(this, "inp-confirm-pass");
          });
        }
      });

      // Password strength checker
      function checkPasswordStrength(password) {
        const checks = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /\d/.test(password),
        };

        const requirements = {
          length: document.getElementById("req-length-change"),
          uppercase: document.getElementById("req-uppercase-change"),
          lowercase: document.getElementById("req-lowercase-change"),
          number: document.getElementById("req-number-change"),
        };

        for (const [key, element] of Object.entries(requirements)) {
          if (element) {
            if (checks[key]) {
              element.classList.add("met");
              element.querySelector(".icon").textContent = "‚úì";
            } else {
              element.classList.remove("met");
              element.querySelector(".icon").textContent = "‚óã";
            }
          }
        }

        const strengthIndicator = document.getElementById(
          "strength-indicator-change"
        );
        const metCount = Object.values(checks).filter(Boolean).length;

        if (password.length === 0) {
          strengthIndicator.className = "strength-indicator";
          return null;
        }

        if (metCount <= 2) {
          strengthIndicator.className = "strength-indicator weak";
          strengthIndicator.innerHTML =
            "<strong>‚ö†Ô∏è Y·∫øu:</strong> M·∫≠t kh·∫©u c·∫ßn m·∫°nh h∆°n";
          return "weak";
        } else if (metCount === 3) {
          strengthIndicator.className = "strength-indicator medium";
          strengthIndicator.innerHTML =
            "<strong>‚ö° Trung b√¨nh:</strong> M·∫≠t kh·∫©u kh√° t·ªët";
          return "medium";
        } else {
          strengthIndicator.className = "strength-indicator strong";
          strengthIndicator.innerHTML =
            "<strong>‚úì M·∫°nh:</strong> M·∫≠t kh·∫©u r·∫•t t·ªët!";
          return "strong";
        }
      }

      function validatePasswords() {
        const password = document.getElementById("inp-new-pass").value;
        const confirm = document.getElementById("inp-confirm-pass").value;
        const confirmValidation = document.getElementById(
          "confirm-validation-change"
        );

        if (!confirm) {
          confirmValidation.className = "validation-message";
          return false;
        }

        if (password !== confirm) {
          confirmValidation.className = "validation-message error";
          confirmValidation.textContent = "‚ùå M·∫≠t kh·∫©u kh√¥ng kh·ªõp";
          return false;
        }

        const strength = checkPasswordStrength(password);
        if (strength === "weak" || !strength) {
          confirmValidation.className = "validation-message";
          return false;
        }

        confirmValidation.className = "validation-message success";
        confirmValidation.textContent = "‚úì M·∫≠t kh·∫©u kh·ªõp";
        return true;
      }

      // Event listeners for password validation
      document.addEventListener("DOMContentLoaded", function () {
        const newPassInput = document.getElementById("inp-new-pass");
        const confirmPassInput = document.getElementById("inp-confirm-pass");

        if (newPassInput) {
          newPassInput.addEventListener("input", function () {
            checkPasswordStrength(this.value);
            validatePasswords();
          });
        }

        if (confirmPassInput) {
          confirmPassInput.addEventListener("input", validatePasswords);
        }

        // Form submission
        const changePasswordForm = document.getElementById(
          "change-password-form"
        );
        if (changePasswordForm) {
          changePasswordForm.addEventListener("submit", function (e) {
            e.preventDefault();
            submitChangePass();
          });
        }
      });

      function showPasswordError(message) {
        const errorDiv = document.getElementById("password-error-message");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function submitChangePass() {
        const oldPass = document.getElementById("inp-old-pass").value;
        const newPass = document.getElementById("inp-new-pass").value;
        const confirmPass = document.getElementById("inp-confirm-pass").value;
        const btnSubmit = document.getElementById("btn-submit-change");

        // Validate
        if (!oldPass || !newPass || !confirmPass) {
          showPasswordError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
          return;
        }

        if (newPass !== confirmPass) {
          showPasswordError("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");
          return;
        }

        const strength = checkPasswordStrength(newPass);
        if (strength === "weak") {
          showPasswordError(
            "M·∫≠t kh·∫©u qu√° y·∫øu. Vui l√≤ng ƒë√°p ·ª©ng ƒë·ªß c√°c y√™u c·∫ßu!"
          );
          return;
        }

        if (newPass.length < 8) {
          showPasswordError("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±!");
          return;
        }

        // Disable button and show loading
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="loading"></span> ƒêang c·∫≠p nh·∫≠t...';

        // Call API
        fetch(`${BACKEND_URL}/api/change-password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_password: oldPass,
            new_password: newPass,
            confirm_password: confirmPass,
          }),
          credentials: "include",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire({
                icon: "success",
                title: "Th√†nh c√¥ng!",
                text: "ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng",
                confirmButtonColor: "#BC2A12",
              });
              closePassModal();
            } else {
              showPasswordError(data.message || "C√≥ l·ªói x·∫£y ra");
            }
          })
          .catch((err) => {
            console.error("L·ªói:", err);
            showPasswordError("L·ªói k·∫øt n·ªëi server");
          })
          .finally(() => {
            btnSubmit.disabled = false;
            btnSubmit.textContent = "ƒê·ªïi m·∫≠t kh·∫©u";
          });
      }

      // S·ª± ki·ªán click ra ngo√†i ƒë·ªÉ ƒë√≥ng modal (D√πng chung cho c·∫£ Avatar Modal v√† Pass Modal)
      window.onclick = function (event) {
        const avatarModal = document.getElementById("avatar-modal");
        if (event.target == avatarModal) avatarModal.style.display = "none";
        if (event.target == passModal) passModal.style.display = "none";
      };

      // H√†m g·ªçi API ƒë·ªïi m·∫≠t kh·∫©u
      function changePassword() {
        const newPass = document.getElementById("user-password").value;
        if (!newPass) {
          alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi!");
          return;
        }
        if (newPass.length < 6) {
          alert("M·∫≠t kh·∫©u ph·∫£i d√†i h∆°n 6 k√Ω t·ª±!");
          return;
        }

        fetch(`${BACKEND_URL}/api/change-password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: newPass }),
          credentials: "include",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire("Th√†nh c√¥ng", "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
              document.getElementById("user-password").value = "";
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((err) => alert("L·ªói k·∫øt n·ªëi server."));
      }

      // 2. Khi ng∆∞·ªùi d√πng ch·ªçn file -> Hi·ªán Modal Preview
      function handleFileSelect() {
        const fileInput = document.getElementById("avatar-upload-input");

        if (fileInput.files && fileInput.files[0]) {
          selectedFile = fileInput.files[0];
          const objectUrl = URL.createObjectURL(selectedFile);
          previewImg.src = objectUrl;
          modal.style.display = "flex";
        }
      }

      // 3. ƒê√≥ng Modal
      function closeModal() {
        modal.style.display = "none";
        document.getElementById("avatar-upload-input").value = ""; // Reset input
        selectedFile = null;
      }

      // 4. X√°c nh·∫≠n Upload (Khi b·∫•m L∆ØU trong Modal)
      function confirmUpload() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("avatar", selectedFile);

        // Hi·ªáu ·ª©ng n√∫t b·∫•m
        const btnSave = document.querySelector(".btn-save");
        const oldText = btnSave.innerText;
        btnSave.innerText = "ƒêang l∆∞u...";
        btnSave.disabled = true;

        fetch(`${BACKEND_URL}/api/upload-avatar/`, {
          method: "POST",
          body: formData,
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // C·∫≠p nh·∫≠t ·∫£nh th·∫≠t ngo√†i m√†n h√¨nh
              document.getElementById("user-avatar-img").src =
                data.new_avatar_url;
              closeModal(); // T·∫Øt modal
              Swal.fire("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán!", "success");
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((err) => {
            console.error("L·ªói upload:", err);
            alert("C√≥ l·ªói k·∫øt n·ªëi.");
          })
          .finally(() => {
            btnSave.innerText = oldText;
            btnSave.disabled = false;
          });
      }

      // ƒê√≥ng modal khi click ra ngo√†i v√πng tr·∫Øng
      window.onclick = function (event) {
        if (event.target == modal) {
          closeModal();
        }
      };

      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>

    <script>
    // ===== PH√ÇN TRANG FAVORITES =====
    let allFavorites = []; // L∆∞u to√†n b·ªô d·ªØ li·ªáu
    let currentPage = 1;
    const ITEMS_PER_PAGE = 8; // üëà THAY ƒê·ªîI S·ªê N√ÄY ƒë·ªÉ ƒë·ªïi s·ªë qu√°n/trang

    document.addEventListener("DOMContentLoaded", async () => {
      const listContainer = document.getElementById("favorites-list");
      if (!listContainer) return;

      try {
        const response = await fetch("/api/get-favorites/", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
        });

        if (response.status === 403) {
          listContainer.innerHTML = `
            <div style="text-align:center; padding: 20px; width: 100%;">
              <p>‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!</p>
              <a href="/accounts/login/" target="_blank" style="color: blue; text-decoration: underline;">
                B·∫•m v√†o ƒë√¢y ƒë·ªÉ ƒëƒÉng nh·∫≠p
              </a>
            </div>`;
          return;
        }

        const data = await response.json();
        allFavorites = data.favorites || [];

        if (allFavorites.length === 0) {
          listContainer.innerHTML = `
             <div style="
              position: fixed;
              top: 44vh;
              left: 13vw;
              text-align:center;
              color: #777;
              width: 100%;
              z-index: 10;
            ">
              <p>B·∫°n ch∆∞a l∆∞u qu√°n n√†o üçú</p>
            </div>`;
          return;
        }

        renderFavoritesPage();
        renderPagination();
      } catch (err) {
        console.error("L·ªói load favorite:", err);
        listContainer.innerHTML = `
          <div style="text-align:center; color: red; padding: 20px;">
            <p>‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server Django (Port 8000)</p>
            <small>H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ b·∫≠t server backend.</small>
          </div>`;
      }
    });

    function renderFavoritesPage() {
      const listContainer = document.getElementById("favorites-list");
      const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const currentItems = allFavorites.slice(startIndex, endIndex);

      const htmlContent = currentItems
        .map(
          (place) => `
            <div class="fav-card">
              <img src="${place.hinh_anh}" alt="${
            place.ten_quan
          }" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22%3E%3Crect fill=%22%23ddd%22 width=%22150%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E'">
              <div class="fav-info">
                <h4>${place.ten_quan}</h4>
                <p class="address"><i class="fa-solid fa-location-dot"></i> ${
                  place.dia_chi
                }</p>
                <p class="price">${place.gia_trung_binh}</p>
                <a href="/?search=${encodeURIComponent(
                  place.ten_quan
                )}" class="view-btn">
                  <i class="fa-solid fa-map-location-dot"></i> Xem v·ªã tr√≠
                </a>
              </div>
            </div>
          `
        )
        .join("");

      listContainer.innerHTML = htmlContent;
    }

    function renderPagination() {
      const totalPages = Math.ceil(allFavorites.length / ITEMS_PER_PAGE);
      const paginationContainer = document.getElementById("pagination-controls");
      const pageNumbersContainer = document.getElementById("page-numbers");
      const prevBtn = document.getElementById("prev-page-btn");
      const nextBtn = document.getElementById("next-page-btn");

      if (totalPages <= 1) {
        paginationContainer.style.display = "none";
        return;
      }

      paginationContainer.style.display = "flex";

      let pageButtonsHTML = "";
      const maxVisible = 4; // S·ªë trang hi·ªÉn th·ªã t·ªëi ƒëa
      
      if (totalPages <= maxVisible + 2) {
        // N·∫øu t·ªïng s·ªë trang √≠t, hi·ªán t·∫•t c·∫£
        for (let i = 1; i <= totalPages; i++) {
          pageButtonsHTML += `
            <button class="page-number-btn ${i === currentPage ? "active" : ""}" 
                    onclick="goToPage(${i})">
              ${i}
            </button>
          `;
        }
      } else {
        // Nhi·ªÅu trang: hi·ªÉn th·ªã th√¥ng minh
        // Lu√¥n hi·ªán trang 1
        pageButtonsHTML += `
          <button class="page-number-btn ${currentPage === 1 ? "active" : ""}" 
                  onclick="goToPage(1)">
            1
          </button>
        `;

        let startPage, endPage;
        
        if (currentPage <= 3) {
          // G·∫ßn ƒë·∫ßu
          startPage = 2;
          endPage = maxVisible;
        } else if (currentPage >= totalPages - 2) {
          // G·∫ßn cu·ªëi
          startPage = totalPages - maxVisible + 1;
          endPage = totalPages - 1;
        } else {
          // ·ªû gi·ªØa
          startPage = currentPage - 1;
          endPage = currentPage + 1;
        }

        // Th√™m "..." n·∫øu c·∫ßn
        if (startPage > 2) {
          pageButtonsHTML += `<span class="pagination-dots">...</span>`;
        }

        // Hi·ªán c√°c trang ·ªü gi·ªØa
        for (let i = startPage; i <= endPage; i++) {
          pageButtonsHTML += `
            <button class="page-number-btn ${i === currentPage ? "active" : ""}" 
                    onclick="goToPage(${i})">
              ${i}
            </button>
          `;
        }

        // Th√™m "..." n·∫øu c·∫ßn
        if (endPage < totalPages - 1) {
          pageButtonsHTML += `<span class="pagination-dots">...</span>`;
        }

        // Lu√¥n hi·ªán trang cu·ªëi
        pageButtonsHTML += `
          <button class="page-number-btn ${currentPage === totalPages ? "active" : ""}" 
                  onclick="goToPage(${totalPages})">
            ${totalPages}
          </button>
        `;
      }

      pageNumbersContainer.innerHTML = pageButtonsHTML;

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    function changePage(direction) {
      const totalPages = Math.ceil(allFavorites.length / ITEMS_PER_PAGE);
      const newPage = currentPage + direction;

      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderFavoritesPage();
        renderPagination();
        
        document.getElementById("favorites-list").scrollIntoView({ 
          behavior: "smooth", 
          block: "start" 
        });
      }
    }

    function goToPage(pageNumber) {
      currentPage = pageNumber;
      renderFavoritesPage();
      renderPagination();
      
      document.getElementById("favorites-list").scrollIntoView({ 
        behavior: "smooth", 
        block: "start" 
      });
    }
  </script>
  <script>
    // ===== PH√ÇN TRANG CHO FRIEND PAGE =====
    let allSearchResults = [];
    let allFriendRequests = [];
    let allFriendsList = [];

    let currentSearchPage = 1;
    let currentRequestsPage = 1;
    let currentFriendsPage = 1;

    const FRIENDS_PER_PAGE = 8;

    // ===== T√åM KI·∫æM USER =====
    async function searchUsers() {
      const query = document.getElementById("search-input").value.trim();
      if (!query) {
        Swal.fire("L·ªói", "Vui l√≤ng nh·∫≠p email ƒë·ªÉ t√¨m ki·∫øm", "warning");
        return;
      }

      try {
        const response = await fetch(`${API_URL}/users/search/?q=${query}`);
        const data = await response.json();

        allSearchResults = data.users || [];
        currentSearchPage = 1;
        renderSearchPage();
        renderSearchPagination();
      } catch (error) {
        console.error("L·ªói t√¨m ki·∫øm:", error);
        Swal.fire("L·ªói", "Kh√¥ng th·ªÉ t√¨m ki·∫øm", "error");
      }
    }

    function renderSearchPage() {
      const resultsDiv = document.getElementById("search-results");
      
      if (allSearchResults.length === 0) {
        resultsDiv.innerHTML = '<p class="no-data">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</p>';
        return;
      }

      const startIndex = (currentSearchPage - 1) * FRIENDS_PER_PAGE;
      const endIndex = startIndex + FRIENDS_PER_PAGE;
      const currentItems = allSearchResults.slice(startIndex, endIndex);

      resultsDiv.innerHTML = currentItems
        .map(
          (user) => `
          <div class="friend-card">
            <div class="friend-info">
              <div class="friend-avatar">üë§</div>
              <div>
                <div class="friend-name">${user.username}</div>
                <div class="friend-email">${user.email}</div>
              </div>
            </div>
            <button class="btn-add" onclick="sendFriendRequest(${user.id})">‚ûï K·∫øt b·∫°n</button>
          </div>
        `
        )
        .join("");
    }

    function renderSearchPagination() {
      const totalPages = Math.ceil(allSearchResults.length / FRIENDS_PER_PAGE);
      
      // T·∫°o ho·∫∑c l·∫•y pagination container
      let paginationDiv = document.querySelector('#search-tab .pagination-wrapper');
      if (!paginationDiv) {
        paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination-wrapper';
        paginationDiv.style.position = 'fixed';
        paginationDiv.style.bottom = '5vh';
        paginationDiv.style.left = '61vw';
        document.getElementById('search-tab').appendChild(paginationDiv);
      }

      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }

      paginationDiv.style.display = 'flex';
      paginationDiv.innerHTML = `
        <button class="pagination-btn" id="search-prev-btn" onclick="changeSearchPage(-1)" ${currentSearchPage === 1 ? 'disabled' : ''}>
          ‚óÄ Tr∆∞·ªõc
        </button>
        <div id="search-page-numbers" class="page-numbers"></div>
        <button class="pagination-btn" id="search-next-btn" onclick="changeSearchPage(1)" ${currentSearchPage === totalPages ? 'disabled' : ''}>
          Sau ‚ñ∂
        </button>
      `;

      renderPageNumbers('search', totalPages, currentSearchPage);
    }

    function changeSearchPage(direction) {
      const totalPages = Math.ceil(allSearchResults.length / FRIENDS_PER_PAGE);
      const newPage = currentSearchPage + direction;

      if (newPage >= 1 && newPage <= totalPages) {
        currentSearchPage = newPage;
        renderSearchPage();
        renderSearchPagination();
      }
    }

    function goToSearchPage(pageNumber) {
      currentSearchPage = pageNumber;
      renderSearchPage();
      renderSearchPagination();
    }

    // ===== L·ªúI M·ªúI K·∫æT B·∫†N =====
    async function loadFriendRequests() {
      if (!CURRENT_USER_ID) {
        console.log("‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID");
        return;
      }

      try {
        const response = await fetch(`${API_URL}/friend-requests/${CURRENT_USER_ID}/`);
        const data = await response.json();

        allFriendRequests = data.requests || [];
        currentRequestsPage = 1;
        
        const count = allFriendRequests.length;
        document.getElementById("request-count").textContent = count;

        renderRequestsPage();
        renderRequestsPagination();
      } catch (error) {
        console.error("L·ªói t·∫£i l·ªùi m·ªùi:", error);
      }
    }

    function renderRequestsPage() {
      const requestsDiv = document.getElementById("friend-requests");

      if (allFriendRequests.length === 0) {
        requestsDiv.innerHTML = '<p class="no-data">Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n n√†o</p>';
        return;
      }

      const startIndex = (currentRequestsPage - 1) * FRIENDS_PER_PAGE;
      const endIndex = startIndex + FRIENDS_PER_PAGE;
      const currentItems = allFriendRequests.slice(startIndex, endIndex);

      requestsDiv.innerHTML = currentItems
        .map(
          (req) => `
          <div class="friend-card">
            <div class="friend-info">
              <div class="friend-avatar">üë§</div>
              <div>
                <div class="friend-name">${req.sender_username}</div>
                <div class="friend-email">G·ª≠i l√∫c: ${req.created_at}</div>
              </div>
            </div>
            <div class="btn-group">
              <button class="btn-accept" onclick="acceptRequest(${req.id})">‚úì</button>
              <button class="btn-reject" onclick="rejectRequest(${req.id})">‚úó</button>
            </div>
          </div>
        `
        )
        .join("");
    }

    function renderRequestsPagination() {
      const totalPages = Math.ceil(allFriendRequests.length / FRIENDS_PER_PAGE);
      
      let paginationDiv = document.querySelector('#requests-tab .pagination-wrapper');
      if (!paginationDiv) {
        paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination-wrapper';
        paginationDiv.style.position = 'fixed';
        paginationDiv.style.bottom = '5vh';
        paginationDiv.style.left = '61vw';
        document.getElementById('requests-tab').appendChild(paginationDiv);
      }

      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }

      paginationDiv.style.display = 'flex';
      paginationDiv.innerHTML = `
        <button class="pagination-btn" onclick="changeRequestsPage(-1)" ${currentRequestsPage === 1 ? 'disabled' : ''}>
          ‚óÄ Tr∆∞·ªõc
        </button>
        <div id="requests-page-numbers" class="page-numbers"></div>
        <button class="pagination-btn" onclick="changeRequestsPage(1)" ${currentRequestsPage === totalPages ? 'disabled' : ''}>
          Sau ‚ñ∂
        </button>
      `;

      renderPageNumbers('requests', totalPages, currentRequestsPage);
    }

    function changeRequestsPage(direction) {
      const totalPages = Math.ceil(allFriendRequests.length / FRIENDS_PER_PAGE);
      const newPage = currentRequestsPage + direction;

      if (newPage >= 1 && newPage <= totalPages) {
        currentRequestsPage = newPage;
        renderRequestsPage();
        renderRequestsPagination();
      }
    }

    function goToRequestsPage(pageNumber) {
      currentRequestsPage = pageNumber;
      renderRequestsPage();
      renderRequestsPagination();
    }

    // ===== DANH S√ÅCH B·∫†N B√à =====
    async function loadFriendsList() {
      if (!CURRENT_USER_ID) {
        console.log("‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID");
        return;
      }

      try {
        const response = await fetch(`${API_URL}/friends/${CURRENT_USER_ID}/`);
        const data = await response.json();

        allFriendsList = data.friends || [];
        currentFriendsPage = 1;

        renderFriendsPage();
        renderFriendsPagination();
      } catch (error) {
        console.error("L·ªói t·∫£i danh s√°ch b·∫°n:", error);
      }
    }

    function renderFriendsPage() {
      const friendsDiv = document.getElementById("friends-list");

      if (allFriendsList.length === 0) {
        friendsDiv.innerHTML = '<p class="no-data">Ch∆∞a c√≥ b·∫°n b√® n√†o</p>';
        return;
      }

      const startIndex = (currentFriendsPage - 1) * FRIENDS_PER_PAGE;
      const endIndex = startIndex + FRIENDS_PER_PAGE;
      const currentItems = allFriendsList.slice(startIndex, endIndex);

      friendsDiv.innerHTML = currentItems
        .map(
          (friend) => `
          <div class="friend-card">
            <div class="friend-info">
              <div class="friend-avatar">üë§</div>
              <div>
                <div class="friend-name">${friend.username}</div>
                <div class="friend-email">${friend.email}</div>
              </div>
            </div>
            <div class="friend-actions">
                <button class="btn-more" onclick="toggleActionMenu(this)">‚ãØ</button>

                <div class="action-overlay">
                    <button onclick="viewFriendFavorites(${friend.id}, '${friend.username}')">‚ù§Ô∏è Qu√°n y√™u th√≠ch</button>
                    <button onclick="unfriendUser(${friend.id}, '${friend.username}')">üóëÔ∏è H·ªßy k·∫øt b·∫°n</button>
                </div>
            </div>
          </div>
        `
        )
        .join("");
    }

    function renderFriendsPagination() {
      const totalPages = Math.ceil(allFriendsList.length / FRIENDS_PER_PAGE);
      
      let paginationDiv = document.querySelector('#list-tab .pagination-wrapper');
      if (!paginationDiv) {
        paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination-wrapper';
        paginationDiv.style.position = 'fixed';
        paginationDiv.style.bottom = '5vh';
        paginationDiv.style.left = '61vw';
        document.getElementById('list-tab').appendChild(paginationDiv);
      }

      if (totalPages <= 1) {
        paginationDiv.style.display = 'none';
        return;
      }

      paginationDiv.style.display = 'flex';
      paginationDiv.innerHTML = `
        <button class="pagination-btn" onclick="changeFriendsPage(-1)" ${currentFriendsPage === 1 ? 'disabled' : ''}>
          ‚óÄ Tr∆∞·ªõc
        </button>
        <div id="friends-page-numbers" class="page-numbers"></div>
        <button class="pagination-btn" onclick="changeFriendsPage(1)" ${currentFriendsPage === totalPages ? 'disabled' : ''}>
          Sau ‚ñ∂
        </button>
      `;

      renderPageNumbers('friends', totalPages, currentFriendsPage);
    }

    function changeFriendsPage(direction) {
      const totalPages = Math.ceil(allFriendsList.length / FRIENDS_PER_PAGE);
      const newPage = currentFriendsPage + direction;

      if (newPage >= 1 && newPage <= totalPages) {
        currentFriendsPage = newPage;
        renderFriendsPage();
        renderFriendsPagination();
      }
    }

    function goToFriendsPage(pageNumber) {
      currentFriendsPage = pageNumber;
      renderFriendsPage();
      renderFriendsPagination();
    }

    // ===== RENDER PAGE NUMBERS (D√ông CHUNG) =====
    function renderPageNumbers(type, totalPages, currentPage) {
      const container = document.getElementById(`${type}-page-numbers`);
      if (!container) return;

      let pageButtonsHTML = "";
      const maxVisible = 4;
      
      if (totalPages <= maxVisible + 2) {
        for (let i = 1; i <= totalPages; i++) {
          pageButtonsHTML += `
            <button class="page-number-btn ${i === currentPage ? "active" : ""}" 
                    onclick="goTo${type.charAt(0).toUpperCase() + type.slice(1)}Page(${i})">
              ${i}
            </button>
          `;
        }
      } else {
        // Trang 1
        pageButtonsHTML += `
          <button class="page-number-btn ${currentPage === 1 ? "active" : ""}" 
                  onclick="goTo${type.charAt(0).toUpperCase() + type.slice(1)}Page(1)">
            1
          </button>
        `;

        let startPage, endPage;
        
        if (currentPage <= 3) {
          startPage = 2;
          endPage = maxVisible;
        } else if (currentPage >= totalPages - 2) {
          startPage = totalPages - maxVisible + 1;
          endPage = totalPages - 1;
        } else {
          startPage = currentPage - 1;
          endPage = currentPage + 1;
        }

        if (startPage > 2) {
          pageButtonsHTML += `<span class="pagination-dots">...</span>`;
        }

        for (let i = startPage; i <= endPage; i++) {
          pageButtonsHTML += `
            <button class="page-number-btn ${i === currentPage ? "active" : ""}" 
                    onclick="goTo${type.charAt(0).toUpperCase() + type.slice(1)}Page(${i})">
              ${i}
            </button>
          `;
        }

        if (endPage < totalPages - 1) {
          pageButtonsHTML += `<span class="pagination-dots">...</span>`;
        }

        // Trang cu·ªëi
        pageButtonsHTML += `
          <button class="page-number-btn ${currentPage === totalPages ? "active" : ""}" 
                  onclick="goTo${type.charAt(0).toUpperCase() + type.slice(1)}Page(${totalPages})">
            ${totalPages}
          </button>
        `;
      }

      container.innerHTML = pageButtonsHTML;
    }

    // ===== C·∫¨P NH·∫¨T L·∫†I C√ÅC H√ÄM C≈® =====
    // Sau khi accept/reject request
    async function acceptRequest(requestId) {
      try {
        const response = await fetch(`${API_URL}/friend-request/accept/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ request_id: requestId }),
        });

        const data = await response.json();
        if (data.success) {
          Swal.fire("Th√†nh c√¥ng", "ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi", "success");
          await loadFriendRequests(); // ‚úÖ Reload v·ªõi pagination
          await loadFriendsList();
        }
      } catch (error) {
        console.error("L·ªói:", error);
        Swal.fire("L·ªói", "Kh√¥ng th·ªÉ ch·∫•p nh·∫≠n", "error");
      }
    }

    async function rejectRequest(requestId) {
      try {
        const response = await fetch(`${API_URL}/friend-request/reject/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ request_id: requestId }),
        });

        const data = await response.json();
        if (data.success) {
          Swal.fire("ƒê√£ t·ª´ ch·ªëi", "L·ªùi m·ªùi ƒë√£ b·ªã t·ª´ ch·ªëi", "info");
          await loadFriendRequests(); // ‚úÖ Reload v·ªõi pagination
        }
      } catch (error) {
        console.error("L·ªói:", error);
      }
    }

    async function unfriendUser(friendId, friendName) {
      const result = await Swal.fire({
        title: "X√°c nh·∫≠n h·ªßy k·∫øt b·∫°n?",
        text: `B·∫°n mu·ªën h·ªßy k·∫øt b·∫°n v·ªõi ${friendName}?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "ƒê√∫ng, h·ªßy k·∫øt b·∫°n!",
        cancelButtonText: "H·ªßy",
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`${API_URL}/friend/unfriend/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ friend_id: friendId }),
          });

          const data = await response.json();
          if (data.success) {
            Swal.fire("Th√†nh c√¥ng", "ƒê√£ h·ªßy k·∫øt b·∫°n", "success");
            await loadFriendsList(); // ‚úÖ Reload v·ªõi pagination
          } else {
            Swal.fire("L·ªói", data.error, "error");
          }
        } catch (error) {
          console.error("L·ªói:", error);
          Swal.fire("L·ªói", "Kh√¥ng th·ªÉ h·ªßy k·∫øt b·∫°n", "error");
        }
      }
    }

    function toggleActionMenu(button) {
        const card = button.closest(".friend-card");
        const overlay = card.querySelector(".action-overlay");

        // N·∫øu ƒëang m·ªü ‚Üí ƒë√≥ng
        if (overlay.classList.contains("show")) {
            overlay.classList.remove("show");
            return;
        }

        // ƒê√≥ng m·ªçi overlay kh√°c
        document.querySelectorAll(".action-overlay").forEach(el => {
            el.classList.remove("show");
        });

        // M·ªü overlay c·ªßa ch√≠nh card ƒëang b·∫•m
        overlay.classList.add("show");
    }

    // ·∫§n ra ngo√†i ƒë·ªÉ ƒë√≥ng
    document.addEventListener("click", function(e) {
        if (!e.target.closest(".friend-card")) {
            document.querySelectorAll(".action-overlay").forEach(el => {
                el.classList.remove("show");
            });
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get('tab');
      const openFriendRequests = params.get('openFriendRequests');

      // V√≠ d·ª•: b·∫°n ƒë√£ c√≥ s·∫µn m·∫•y h√†m ki·ªÉu:
      //   - switchToFriendsTab()
      //   - showFriendRequestsSection()
      // Ch·ªâ c·∫ßn g·ªçi l·∫°i ·ªü ƒë√¢y.

      if (tab === 'friends') {
        if (typeof switchToFriendsTab === 'function') {
          switchToFriendsTab();
        }

        if (openFriendRequests === '1' &&
            typeof showFriendRequestsSection === 'function') {
          showFriendRequestsSection(); // scroll t·ªõi / active block "L·ªùi m·ªùi k·∫øt b·∫°n"
        }
      }
    });

    </script>
  </body>
</html>
