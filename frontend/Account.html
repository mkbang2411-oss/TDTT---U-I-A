<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web Demo</title>
    <link rel="stylesheet" href="Account.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="background-left">
        <img src="Picture/background.png" width="850" height="200" alt="UIA Logo">
        
    </div>
    

    <!--Side bar bên phải-->
    <div class="sidebar-content">
            <div class="logo">
                <img src="Picture/UIAaa.png" width="500" height="200" alt="UIA Logo">
            </div>
            <div class="Menu">
                <div class="Menu_Account" onclick="showPage('Account_Page')"> Tài Khoản</div>
                <div class="Menu_Favorite" onclick="showPage('Favorite_Page')"> Yêu Thích</div>
            </div>
            <div class="Back">
                <a href="/" class="Button_back">
                    <img src="Picture/đ.png" width="50" height="50" alt="Back">
                </a>
            </div>
        </div>
    </div>
    <div class="main-content">
        <!--Account-->
        <div id="Account_Page" class="page active">
            <div class="Account">
                <p>Tài Khoản</p>
            </div>
            <div class="avatar">
                <img src="Picture/avatar.jpg" width="200" height="200" alt="Avatar">
            </div>
            <div class="Sign-out">
                <a href="#" class="button-SignOut" id="logout-button">Đăng Xuất</a>
            </div>
            <div class="account_Info">
                <div class="form-group">
                    <div class="input-box">
                        <label>Email</label>
                        <input type="email" placeholder="abc@gmail.com">
                    </div>
                    <div class="input-box">
                        <label>Mật khẩu</label>
                        <input type="password" placeholder="***">
                    </div>
                </div>
            </div>
        </div>
        <!--Favorite-->
        <div id="Favorite_Page" class="page">
            <div class="Favorite">
                <p>Yêu Thích</p>
            </div>
        </div>
    </div>
    <!-- JAVASCRIPT -->
    <script>
        function showPage(pageId) {
            // Ẩn tất cả các trang
            var pages = document.querySelectorAll('.page');
            pages.forEach(function(page) {
                page.classList.remove('active');
            });
            
            // Hiện trang được chọn
            document.getElementById(pageId).classList.add('active');
            
            // Đổi active cho menu
            document.querySelectorAll('.Menu > div').forEach(function(menu) {
                menu.classList.remove('active');
            });
            
            if(pageId === 'Account_Page') {
                document.querySelector('.Menu_Account').classList.add('active');
            } else if(pageId === 'Favorite_Page') {
                document.querySelector('.Menu_Favorite').classList.add('active');
            }
        }

        // HÀM LẤY CSRF TOKEN TỪ COOKIE
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        document.getElementById('logout-button').addEventListener('click', function(e) {
        e.preventDefault(); // Ngăn thẻ <a> chuyển trang

        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: "Bạn sắp đăng xuất khỏi tài khoản!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Đúng, Đăng xuất!',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                // Nếu người dùng đồng ý, gọi API đăng xuất của Django
                fetch('http://127.0.0.1:8000/accounts/logout/', {
                    method: 'POST',
                    headers: {
                        // Django đọc CSRF token từ cookie
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    
                    // Bảo trình duyệt gửi cookie (phiên đăng nhập)
                    // từ cổng 5000 sang cổng 8000
                    credentials: 'include' 
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server từ chối. Lỗi ' + response.status);
                    }
                    // Yêu cầu allauth trả về JSON
                    return response.json(); 
                })
                .then(data => {
                    Swal.fire(
                        'Đã đăng xuất!',
                        'Bạn đã đăng xuất thành công.',
                        'success'
                    );

                    // Chờ 2 giây rồi chuyển về trang chủ 
                    setTimeout(() => {
                        window.location.href = 'http://127.0.0.1:5000/'; 
                    }, 2000);
                })
                .catch(error => {
                    console.error('Lỗi đăng xuất:', error);
                    Swal.fire(
                        'Lỗi!',
                        'Có lỗi xảy ra, không thể đăng xuất từ server.',
                        'error'
                    );
                });
            }
        });
    });
    </script>
</body>
</html>
