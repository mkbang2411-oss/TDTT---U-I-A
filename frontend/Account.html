<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Web Demo</title>
    <link rel="stylesheet" href="Account.css" />


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div class="background-left">
      <img
        src="Picture/background.png"
        width="850"
        height="200"
        alt="UIA Logo"
      />
    </div>

    <!--Side bar b√™n ph·∫£i-->
    <div class="sidebar-content">
        <div class="logo">
            <img src="Picture/UIAaa.png" width="500" height="200" alt="UIA Logo">
        </div>
        <div class="Menu">
            <div class="Menu_Account" onclick="showPage('Account_Page')">T√†i Kho·∫£n</div>
            <div class="Menu_Favorite" onclick="showPage('Favorite_Page')">Y√™u Th√≠ch</div>
            <div class="Menu_Friend" onclick="showPage('Friend_Page')">B·∫°n B√®</div>
            <div class="Menu_Logout">
              <a href="#" class="button-SignOut" id="logout-button">ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
        <div class="Back">
            <a href="/" class="Button_back">
                <img src="Picture/ƒë.png" width="50" height="50" alt="Back">
            </a>
        </div>
        
      </div>
      
    </div>

    <div class="main-content">
      <!--Account-->
      <div id="Account_Page" class="page active">
        <div class="Account">
          <p>T√†i Kho·∫£n</p>
        </div>
        <div
          class="avatar"
          style="display: flex; flex-direction: column; align-items: center"
        >
          <div
            class="avatar-wrapper"
            style="position: relative; display: inline-block"
          >
            <img
              id="user-avatar-img"
              src="Picture/avatar.jpg"
              width="200"
              height="200"
              alt="Avatar"
              style="
                border-radius: 50%;
                object-fit: cover;
                border: 4px solid white;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
              "
            />
            <div
              class="camera-btn"
              onclick="document.getElementById('avatar-upload-input').click()"
              style="
                position: absolute;
                bottom: 15px;
                right: 15px;
                background-color: #e4e6eb;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border: 2px solid white;
                transition: background 0.2s;
              "
            >
              <svg viewBox="0 0 24 24" width="22" height="22" fill="black">
                <path
                  d="M21.317 4.381H10.971L9.078 2.45c-.246-.251-.736-.45-1.089-.45H5.344c-.353 0-.843.199-1.089.45L2.362 4.381H2.683C1.204 4.381 0 5.593 0 7.081V18.32c0 1.488 1.204 2.699 2.683 2.699H21.317c1.479 0 2.683-1.211 2.683-2.699V7.081c0-1.488-1.204-2.7-2.683-2.7zM12 17.626c-3.146 0-5.697-2.568-5.697-5.735 0-3.167 2.55-5.735 5.697-5.735 3.147 0 5.697 2.568 5.697 5.735 0 3.167-2.55 5.735-5.697 5.735z"
                />
              </svg>
            </div>
          </div>
          <input
            type="file"
            id="avatar-upload-input"
            accept="image/*"
            style="display: none"
            onchange="handleFileSelect()"
          />
        </div>

        
        <div class="account_Info">
          <div class="form-group">
            <div class="input-box">
              <label>Email</label>
              <input
                type="email"
                id="user-email"
                placeholder="abc@gmail.com"
                readonly
                style="background-color: #f9f9f9"
              />
            </div>

            <div class="input-box">
              <label>M·∫≠t kh·∫©u</label>
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="password"
                  id="main-password-display"
                  value="******"
                  disabled
                  style="flex: 1; background-color: #f9f9f9"
                />

                <button
                  id="btn-open-changepass"
                  onclick="openPassModal()"
                  style="
                    display: none;
                    padding: 10px 15px;
                    background: #ff6b35;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    white-space: nowrap;
                  "
                >
                  ƒê·ªïi m·∫≠t kh·∫©u
                </button>
              </div>
              <small
                id="google-note"
                style="
                  display: none;
                  color: #888;
                  margin-top: 5px;
                  font-style: italic;
                "
                >* T√†i kho·∫£n Google ƒë∆∞·ª£c qu·∫£n l√Ω b·∫£o m·∫≠t b·ªüi Google.</small
              >
            </div>

            <div
              id="password-modal"
              class="modal-overlay"
              style="display: none"
            >
              <div
                class="modal-content"
                style="width: 400px; font-family: Arial, sans-serif"
              >
                <div
                  class="modal-header"
                  style="
                    border-bottom: 1px solid #eee;
                    padding: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <h3 style="margin: 0; font-size: 18px">ƒê·ªïi m·∫≠t kh·∫©u</h3>
                  <span
                    class="close-modal"
                    onclick="closePassModal()"
                    style="font-size: 24px; cursor: pointer; color: #999"
                    >&times;</span
                  >
                </div>

                <div class="modal-body" style="padding: 20px">
                  <div class="change-pass-form">
                    <div class="input-row" style="margin-bottom: 15px">
                      <label
                        style="
                          display: block;
                          margin-bottom: 8px;
                          font-weight: bold;
                          color: #333;
                        "
                        >M·∫≠t kh·∫©u c≈©</label
                      >
                      <input
                        type="password"
                        id="inp-old-pass"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i..."
                        style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #ccc;
                          border-radius: 5px;
                          box-sizing: border-box;
                        "
                      />
                    </div>

                    <div class="input-row" style="margin-bottom: 15px">
                      <label
                        style="
                          display: block;
                          margin-bottom: 8px;
                          font-weight: bold;
                          color: #333;
                        "
                        >M·∫≠t kh·∫©u m·ªõi</label
                      >
                      <input
                        type="password"
                        id="inp-new-pass"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..."
                        style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #ccc;
                          border-radius: 5px;
                          box-sizing: border-box;
                        "
                      />
                    </div>

                    <div class="input-row" style="margin-bottom: 0">
                      <label
                        style="
                          display: block;
                          margin-bottom: 8px;
                          font-weight: bold;
                          color: #333;
                        "
                        >X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label
                      >
                      <input
                        type="password"
                        id="inp-confirm-pass"
                        placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi..."
                        style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #ccc;
                          border-radius: 5px;
                          box-sizing: border-box;
                        "
                      />
                    </div>
                  </div>
                </div>

                <div
                  class="modal-footer"
                  style="
                    border-top: 1px solid #eee;
                    padding: 15px;
                    text-align: right;
                    background: #f9f9f9;
                    border-radius: 0 0 8px 8px;
                  "
                >
                  <button
                    class="btn-cancel"
                    onclick="closePassModal()"
                    style="
                      padding: 8px 15px;
                      margin-right: 10px;
                      background: white;
                      border: 1px solid #ccc;
                      border-radius: 4px;
                      cursor: pointer;
                    "
                  >
                    H·ªßy
                  </button>
                  <button
                    class="btn-save"
                    onclick="submitChangePass()"
                    style="
                      padding: 8px 20px;
                      background: #1877f2;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      font-weight: bold;
                    "
                  >
                    X√°c nh·∫≠n
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="avatar-modal" class="modal-overlay" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h3>C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán</h3>
              <span class="close-modal" onclick="closeModal()">√ó</span>

            </div>

            <div class="modal-body">
              <p>Xem tr∆∞·ªõc ·∫£nh c·ªßa b·∫°n</p>
              <div class="preview-container">
                <img id="avatar-preview-img" src="" alt="Preview" />
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
              <button class="btn-save" onclick="confirmUpload()">L∆∞u</button>
          </div>
          </div>
        </div>
      </div>
      <!--Favorite-->
      <div id="Favorite_Page" class="page">
        <div class="Favorite">
          <p>Y√™u Th√≠ch</p>
        </div>
        <div id="favorites-list" class="favorites-grid-container">
          <p style="text-align: center; color: #666">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
      </div>
        <!--Friends-->
        <div id="Friend_Page" class="page">
            <div class="Friend">
                <p>B·∫°n b√®</p>
            </div>

            <!-- TABS -->
            <div class="friend-tabs">
                <button class="tab-btn active" onclick="switchTab('search')">üîç T√¨m ki·∫øm</button>
                <button class="tab-btn" onclick="switchTab('requests')">üì® L·ªùi m·ªùi (<span id="request-count">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('list')">üë• Danh s√°ch b·∫°n</button>
            </div>

            <!-- TAB 1: T√åM KI·∫æM -->
            <div id="search-tab" class="tab-content active">
                <div class="search-container">
                    <div class="search-box">
                        <input type="email" id="search-input" class="search-input" placeholder="Nh·∫≠p email ƒë·ªÉ t√¨m b·∫°n b√®...">
                        <button class="search-button" onclick="searchUsers()">üîé</button>
                    </div>
                </div>
                <div id="search-results" class="friends-list"></div>
            </div>

            <!-- TAB 2: L·ªúI M·ªúI K·∫æT B·∫†N -->
            <div id="requests-tab" class="tab-content">
                <div id="friend-requests" class="friends-list"></div>
            </div>

            <!-- TAB 3: DANH S√ÅCH B·∫†N B√à -->
            <div id="list-tab" class="tab-content">
                <div id="friends-list" class="friends-list"></div>
            </div>
        </div>
      </div>
    <!-- JAVASCRIPT -->
    <script>

        const API_URL = '/api/accounts';
        let CURRENT_USER_ID = null;
        let isLoadingUser = false;  // ‚úÖ Th√™m flag

        // ‚úÖ L·∫§Y TH√îNG TIN USER HI·ªÜN T·∫†I
        async function loadCurrentUser() {
            if (isLoadingUser) return;  // ‚úÖ Tr√°nh g·ªçi nhi·ªÅu l·∫ßn
            isLoadingUser = true;
            
            try {
                const response = await fetch(`${API_URL}/current-user/`, {
                    credentials: 'include'  // ‚úÖ G·ª≠i cookie
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                CURRENT_USER_ID = data.id;
                console.log('‚úÖ Current User ID:', CURRENT_USER_ID);
            } catch(error) {
                console.error('‚ùå Kh√¥ng th·ªÉ l·∫•y user hi·ªán t·∫°i:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh user. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
            } finally {
                isLoadingUser = false;
            }
        }

        // ‚úÖ G·ªåI NGAY KHI TRANG LOAD
        loadCurrentUser();

        function showPage(pageId) {
            var pages = document.querySelectorAll('.page');
            pages.forEach(function(page) {
                page.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.Menu > div').forEach(function(menu) {
                menu.classList.remove('active');
            });
            
            if(pageId === 'Account_Page') {
                document.querySelector('.Menu_Account').classList.add('active');
            } else if(pageId === 'Favorite_Page') {
                document.querySelector('.Menu_Favorite').classList.add('active');
            } else if(pageId === 'Friend_Page') {
                document.querySelector('.Menu_Friend').classList.add('active');
                // ‚úÖ ƒê·∫£m b·∫£o load xong user ID
                ensureUserLoaded().then(() => {
                    loadFriendRequests();
                    loadFriendsList();
                });
            }
        }

        // ‚úÖ TH√äM FUNCTION N√ÄY - ƒê·ª£i user load xong
        async function ensureUserLoaded() {
            if (CURRENT_USER_ID) return;  // ƒê√£ c√≥ r·ªìi
            
            // ƒê·ª£i t·ªëi ƒëa 5 gi√¢y
            for (let i = 0; i < 50; i++) {
                if (CURRENT_USER_ID) return;
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // N·∫øu v·∫´n ch∆∞a c√≥, th·ª≠ load l·∫°i
            if (!CURRENT_USER_ID) {
                await loadCurrentUser();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if(tabName === 'search') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('search-tab').classList.add('active');
            } else if(tabName === 'requests') {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('requests-tab').classList.add('active');
                ensureUserLoaded().then(() => loadFriendRequests());
            } else if(tabName === 'list') {
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                document.getElementById('list-tab').classList.add('active');
                ensureUserLoaded().then(() => loadFriendsList());
            }
        }

        // T√åM KI·∫æM USER
        async function searchUsers() {
            const query = document.getElementById('search-input').value.trim();
            if(!query) {
                Swal.fire('L·ªói', 'Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users/search/?q=${query}`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('search-results');
                if(data.users && data.users.length > 0) {
                    resultsDiv.innerHTML = data.users.map(user => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${user.username}</div>
                                    <div class="friend-email">${user.email}</div>
                                </div>
                            </div>
                            <button class="btn-add" onclick="sendFriendRequest(${user.id})">‚ûï K·∫øt b·∫°n</button>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = '<p class="no-data">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</p>';
                }
            } catch(error) {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t√¨m ki·∫øm', 'error');
            }
        }

        // G·ª¨I L·ªúI M·ªúI K·∫æT B·∫†N
        async function sendFriendRequest(receiverId) {
            // ‚úÖ ƒê·∫£m b·∫£o ƒë√£ load user ID
            await ensureUserLoaded();
            
            if(!CURRENT_USER_ID) {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh user hi·ªán t·∫°i. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
                return;
            }
            
            console.log(`üì§ G·ª≠i l·ªùi m·ªùi: sender=${CURRENT_USER_ID}, receiver=${receiverId}`);
            
            try {
                const response = await fetch(`${API_URL}/friend-request/send/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',  // ‚úÖ Th√™m
                    body: JSON.stringify({
                        sender_id: CURRENT_USER_ID,
                        receiver_id: receiverId
                    })
                });
                
                const data = await response.json();
                if(data.success) {
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n', 'success');
                } else {
                    Swal.fire('L·ªói', data.error, 'error');
                }
            } catch(error) {
                console.error('L·ªói g·ª≠i l·ªùi m·ªùi:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i l·ªùi m·ªùi', 'error');
            }
        }

        // T·∫¢I DANH S√ÅCH L·ªúI M·ªúI
        async function loadFriendRequests() {
            if(!CURRENT_USER_ID) {
                console.log('‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/friend-requests/${CURRENT_USER_ID}/`);
                const data = await response.json();
                
                const requestsDiv = document.getElementById('friend-requests');
                const count = data.requests ? data.requests.length : 0;
                document.getElementById('request-count').textContent = count;
                
                if(count > 0) {
                    requestsDiv.innerHTML = data.requests.map(req => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${req.sender_username}</div>
                                    <div class="friend-email">G·ª≠i l√∫c: ${req.created_at}</div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn-accept" onclick="acceptRequest(${req.id})">‚úì Ch·∫•p nh·∫≠n</button>
                                <button class="btn-reject" onclick="rejectRequest(${req.id})">‚úó T·ª´ ch·ªëi</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    requestsDiv.innerHTML = '<p class="no-data">Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n n√†o</p>';
                }
            } catch(error) {
                console.error('L·ªói t·∫£i l·ªùi m·ªùi:', error);
            }
        }

        // CH·∫§P NH·∫¨N L·ªúI M·ªúI
        async function acceptRequest(requestId) {
            try {
                const response = await fetch(`${API_URL}/friend-request/accept/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({request_id: requestId})
                });
                
                const data = await response.json();
                if(data.success) {
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi', 'success');
                    loadFriendRequests();
                    loadFriendsList();
                }
            } catch(error) {
                console.error('L·ªói:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ ch·∫•p nh·∫≠n', 'error');
            }
        }

        // T·ª™ CH·ªêI L·ªúI M·ªúI
        async function rejectRequest(requestId) {
            try {
                const response = await fetch(`${API_URL}/friend-request/reject/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({request_id: requestId})
                });
                
                const data = await response.json();
                if(data.success) {
                    Swal.fire('ƒê√£ t·ª´ ch·ªëi', 'L·ªùi m·ªùi ƒë√£ b·ªã t·ª´ ch·ªëi', 'info');
                    loadFriendRequests();
                }
            } catch(error) {
                console.error('L·ªói:', error);
            }
        }

        // T·∫¢I DANH S√ÅCH B·∫†N B√à
        async function loadFriendsList() {
            if(!CURRENT_USER_ID) {
                console.log('‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/friends/${CURRENT_USER_ID}/`);
                const data = await response.json();
                
                const friendsDiv = document.getElementById('friends-list');
                if(data.friends && data.friends.length > 0) {
                    friendsDiv.innerHTML = data.friends.map(friend => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${friend.username}</div>
                                    <div class="friend-email">${friend.email}</div>
                                </div>
                            </div>
                            <button class="btn-chat">üí¨ Nh·∫Øn tin</button>
                        </div>
                    `).join('');
                } else {
                    friendsDiv.innerHTML = '<p class="no-data">Ch∆∞a c√≥ b·∫°n b√® n√†o</p>';
                }
            } catch(error) {
                console.error('L·ªói t·∫£i danh s√°ch b·∫°n:', error);
            }
        }
        // T·∫¢I DANH S√ÅCH B·∫†N B√à
          async function loadFriendsList() {
              if(!CURRENT_USER_ID) {
                  console.log('‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID');
                  return;
              }
              
              try {
                  const response = await fetch(`${API_URL}/friends/${CURRENT_USER_ID}/`);
                  const data = await response.json();
                  
                  const friendsDiv = document.getElementById('friends-list');
                  if(data.friends && data.friends.length > 0) {
                      friendsDiv.innerHTML = data.friends.map(friend => `
                          <div class="friend-card">
                              <div class="friend-info">
                                  <div class="friend-avatar">üë§</div>
                                  <div>
                                      <div class="friend-name">${friend.username}</div>
                                      <div class="friend-email">${friend.email}</div>
                                  </div>
                              </div>
                              <div class="btn-group">
                                  <button class="btn-chat" onclick="viewFriendFavorites(${friend.id}, '${friend.username}')">‚ù§Ô∏è Qu√°n y√™u th√≠ch</button>
                                  <button class="btn-reject" onclick="unfriendUser(${friend.id}, '${friend.username}')">üóëÔ∏è H·ªßy k·∫øt b·∫°n</button>
                              </div>
                          </div>
                      `).join('');
                  } else {
                      friendsDiv.innerHTML = '<p class="no-data">Ch∆∞a c√≥ b·∫°n b√® n√†o</p>';
                  }
              } catch(error) {
                  console.error('L·ªói t·∫£i danh s√°ch b·∫°n:', error);
              }
          }

          // H·ª¶Y K·∫æT B·∫†N
          async function unfriendUser(friendId, friendName) {
              const result = await Swal.fire({
                  title: 'X√°c nh·∫≠n h·ªßy k·∫øt b·∫°n?',
                  text: `B·∫°n mu·ªën h·ªßy k·∫øt b·∫°n v·ªõi ${friendName}?`,
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#d33',
                  cancelButtonColor: '#3085d6',
                  confirmButtonText: 'ƒê√∫ng, h·ªßy k·∫øt b·∫°n!',
                  cancelButtonText: 'H·ªßy'
              });
              
              if(result.isConfirmed) {
                  try {
                      const response = await fetch(`${API_URL}/friend/unfriend/`, {
                          method: 'POST',
                          headers: {'Content-Type': 'application/json'},
                          credentials: 'include',
                          body: JSON.stringify({friend_id: friendId})
                      });
                      
                      const data = await response.json();
                      if(data.success) {
                          Swal.fire('Th√†nh c√¥ng', 'ƒê√£ h·ªßy k·∫øt b·∫°n', 'success');
                          loadFriendsList(); // Reload danh s√°ch
                      } else {
                          Swal.fire('L·ªói', data.error, 'error');
                      }
                  } catch(error) {
                      console.error('L·ªói:', error);
                      Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ h·ªßy k·∫øt b·∫°n', 'error');
                  }
              }
          }

          // XEM QU√ÅN Y√äU TH√çCH C·ª¶A B·∫†N B√à
          // ‚úÖ XEM QU√ÅN Y√äU TH√çCH C·ª¶A B·∫†N B√à - HI·ªÇN TH·ªä TR√äN B·∫¢N ƒê·ªí
          async function viewFriendFavorites(friendId, friendName) {
            try {
                console.log('üì§ ƒêang g·ªçi API:', `${API_URL}/friend/${friendId}/favorites/`);
                
                const response = await fetch(`${API_URL}/friend/${friendId}/favorites/`, {
                    credentials: 'include'
                });
                
                console.log('üì• Response status:', response.status);
                const data = await response.json();
                console.log('üì¶ Data nh·∫≠n ƒë∆∞·ª£c:', data);
                
                if(data.status === 'success') {
                    if(data.favorites && data.favorites.length > 0) {
                        console.log('‚úÖ C√≥', data.favorites.length, 'qu√°n y√™u th√≠ch');
                        console.log('üìç D·ªØ li·ªáu qu√°n:', data.favorites);
                        
                        // L∆∞u v√†o localStorage
                        localStorage.setItem('friendFavorites', JSON.stringify({
                            friendName: friendName,
                            places: data.favorites
                        }));
                        
                        console.log('üíæ ƒê√£ l∆∞u v√†o localStorage');
                        
                        // Chuy·ªÉn sang trang map
                        window.location.href = '/?view=friend-favorites';
                    } else {
                        console.warn('‚ö†Ô∏è Kh√¥ng c√≥ qu√°n y√™u th√≠ch');
                        Swal.fire('Th√¥ng b√°o', `${friendName} ch∆∞a c√≥ qu√°n y√™u th√≠ch n√†o`, 'info');
                    }
                } else {
                    console.error('‚ùå L·ªói API:', data.error);
                    Swal.fire('L·ªói', data.error, 'error');
                }
            } catch(error) {
                console.error('‚ùå L·ªói:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch y√™u th√≠ch', 'error');
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('logout-button').addEventListener('click', function(e) {
            e.preventDefault();

            Swal.fire({
                title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?',
                text: "B·∫°n s·∫Øp ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ƒê√∫ng, ƒêƒÉng xu·∫•t!',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/accounts/logout/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Server t·ª´ ch·ªëi. L·ªói ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.fire('ƒê√£ ƒëƒÉng xu·∫•t!', 'B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.', 'success');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
                        Swal.fire('L·ªói!', 'C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t t·ª´ server.', 'error');
                    });
                }
            });
        });

        // T√¨m ki·∫øm khi nh·∫•n Enter
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                searchUsers();
            }
        });

      function showPage(pageId) {
        // ·∫®n t·∫•t c·∫£ c√°c trang
        var pages = document.querySelectorAll(".page");
        pages.forEach(function (page) {
          page.classList.remove("active");
        });

        // Hi·ªán trang ƒë∆∞·ª£c ch·ªçn
        document.getElementById(pageId).classList.add("active");

        // ƒê·ªïi active cho menu
        document.querySelectorAll(".Menu > div").forEach(function (menu) {
          menu.classList.remove("active");
        });

        if (pageId === "Account_Page") {
          document.querySelector(".Menu_Account").classList.add("active");
        } else if (pageId === "Favorite_Page") {
          document.querySelector(".Menu_Favorite").classList.add("active");
        }
      }

      // H√ÄM L·∫§Y CSRF TOKEN T·ª™ COOKIE
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      document
        .getElementById("logout-button")
        .addEventListener("click", function (e) {
          e.preventDefault(); // NgƒÉn th·∫ª <a> chuy·ªÉn trang

          Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn?",
            text: "B·∫°n s·∫Øp ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "ƒê√∫ng, ƒêƒÉng xu·∫•t!",
            cancelButtonText: "H·ªßy",
          }).then((result) => {
            if (result.isConfirmed) {
              // N·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω, g·ªçi API ƒëƒÉng xu·∫•t c·ªßa Django
              fetch("/accounts/logout/", {
                method: "POST",
                headers: {
                  // Django ƒë·ªçc CSRF token t·ª´ cookie
                  "X-CSRFToken": getCookie("csrftoken"),
                  "X-Requested-With": "XMLHttpRequest",
                },

                // B·∫£o tr√¨nh duy·ªát g·ª≠i cookie (phi√™n ƒëƒÉng nh·∫≠p)
                // t·ª´ c·ªïng 5000 sang c·ªïng 8000
                credentials: "include",
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Server t·ª´ ch·ªëi. L·ªói " + response.status);
                  }
                  // Y√™u c·∫ßu allauth tr·∫£ v·ªÅ JSON
                  return response.json();
                })
                .then((data) => {
                  Swal.fire(
                    "ƒê√£ ƒëƒÉng xu·∫•t!",
                    "B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.",
                    "success"
                  );

                  // Ch·ªù 2 gi√¢y r·ªìi chuy·ªÉn v·ªÅ trang ch·ªß
                  setTimeout(() => {
                    window.location.href = "/";
                  }, 2000);
                })
                .catch((error) => {
                  console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
                  Swal.fire(
                    "L·ªói!",
                    "C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t t·ª´ server.",
                    "error"
                  );
                });

            }
          });
        });
      const BACKEND_URL = "";

      // C√°c bi·∫øn to√†n c·ª•c cho Modal
      let selectedFile = null;
      const modal = document.getElementById("avatar-modal");
      const previewImg = document.getElementById("avatar-preview-img");
      const passModal = document.getElementById("password-modal");

      // 1. H√†m t·∫£i th√¥ng tin user t·ª´ API v√† ƒëi·ªÅn v√†o form
      function loadUserInfo() {
        fetch(`${BACKEND_URL}/api/user-info/`, {
          method: "GET",
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Avatar & Email
              document.getElementById("user-avatar-img").src = data.avatar_url;
              const emailInput = document.getElementById("user-email");
              if (emailInput) emailInput.value = data.email || "";

              // X·ª≠ l√Ω N√∫t ƒë·ªïi m·∫≠t kh·∫©u
              const btnChangePass = document.getElementById(
                "btn-open-changepass"
              );
              const googleNote = document.getElementById("google-note");

              if (data.is_social_login) {
                // N·∫øu l√† Google: ·∫®n n√∫t ƒë·ªïi pass, Hi·ªán ghi ch√∫
                if (btnChangePass) btnChangePass.style.display = "none";
                if (googleNote) googleNote.style.display = "block";
              } else {
                // N·∫øu l√† Django: Hi·ªán n√∫t ƒë·ªïi pass, ·∫®n ghi ch√∫
                if (btnChangePass) btnChangePass.style.display = "block";
                if (googleNote) googleNote.style.display = "none";
              }
            }
          })
          .catch((err) => console.error("L·ªói t·∫£i th√¥ng tin:", err));
      }
      function openPassModal() {
        // Reset c√°c √¥ input cho tr·ªëng
        document.getElementById("inp-old-pass").value = "";
        document.getElementById("inp-new-pass").value = "";
        document.getElementById("inp-confirm-pass").value = "";
        passModal.style.display = "flex";
      }
      function closePassModal() {
        passModal.style.display = "none";
      }
      function submitChangePass() {
        const oldPass = document.getElementById("inp-old-pass").value;
        const newPass = document.getElementById("inp-new-pass").value;
        const confirmPass = document.getElementById("inp-confirm-pass").value;

        // Validate s∆° b·ªô ·ªü Client
        if (!oldPass || !newPass || !confirmPass) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
          return;
        }
        if (newPass !== confirmPass) {
          alert("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");
          return;
        }
        if (newPass.length < 6) {
          alert("M·∫≠t kh·∫©u m·ªõi ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n!");
          return;
        }

        // G·ªçi API
        fetch(`${BACKEND_URL}/api/change-password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_password: oldPass,
            new_password: newPass,
            confirm_password: confirmPass,
          }),
          credentials: "include",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire("Th√†nh c√¥ng", "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
              closePassModal();
            } else {
              Swal.fire("L·ªói", data.message, "error");
            }
          })
          .catch((err) => alert("L·ªói k·∫øt n·ªëi server."));
      }

      // S·ª± ki·ªán click ra ngo√†i ƒë·ªÉ ƒë√≥ng modal (D√πng chung cho c·∫£ Avatar Modal v√† Pass Modal)
      window.onclick = function (event) {
        const avatarModal = document.getElementById("avatar-modal");
        if (event.target == avatarModal) avatarModal.style.display = "none";
        if (event.target == passModal) passModal.style.display = "none";
      };

      // H√†m g·ªçi API ƒë·ªïi m·∫≠t kh·∫©u
      function changePassword() {
        const newPass = document.getElementById("user-password").value;
        if (!newPass) {
          alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi!");
          return;
        }
        if (newPass.length < 6) {
          alert("M·∫≠t kh·∫©u ph·∫£i d√†i h∆°n 6 k√Ω t·ª±!");
          return;
        }

        fetch(`${BACKEND_URL}/api/change-password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: newPass }),
          credentials: "include",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire("Th√†nh c√¥ng", "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
              document.getElementById("user-password").value = "";
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((err) => alert("L·ªói k·∫øt n·ªëi server."));
      }

      // 2. Khi ng∆∞·ªùi d√πng ch·ªçn file -> Hi·ªán Modal Preview
      function handleFileSelect() {
        const fileInput = document.getElementById("avatar-upload-input");

        if (fileInput.files && fileInput.files[0]) {
          selectedFile = fileInput.files[0];
          const objectUrl = URL.createObjectURL(selectedFile);
          previewImg.src = objectUrl;
          modal.style.display = "flex";
        }
      }

      // 3. ƒê√≥ng Modal
      function closeModal() {
        modal.style.display = "none";
        document.getElementById("avatar-upload-input").value = ""; // Reset input
        selectedFile = null;
      }

      // 4. X√°c nh·∫≠n Upload (Khi b·∫•m L∆ØU trong Modal)
      function confirmUpload() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("avatar", selectedFile);

        // Hi·ªáu ·ª©ng n√∫t b·∫•m
        const btnSave = document.querySelector(".btn-save");
        const oldText = btnSave.innerText;
        btnSave.innerText = "ƒêang l∆∞u...";
        btnSave.disabled = true;

        fetch(`${BACKEND_URL}/api/upload-avatar/`, {
          method: "POST",
          body: formData,
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // C·∫≠p nh·∫≠t ·∫£nh th·∫≠t ngo√†i m√†n h√¨nh
              document.getElementById("user-avatar-img").src =
                data.new_avatar_url;
              closeModal(); // T·∫Øt modal
              Swal.fire("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán!", "success");
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((err) => {
            console.error("L·ªói upload:", err);
            alert("C√≥ l·ªói k·∫øt n·ªëi.");
          })
          .finally(() => {
            btnSave.innerText = oldText;
            btnSave.disabled = false;
          });
      }

      // ƒê√≥ng modal khi click ra ngo√†i v√πng tr·∫Øng
      window.onclick = function (event) {
        if (event.target == modal) {
          closeModal();
        }
      };

      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Ch·ªâ ch·∫°y logic n√†y n·∫øu ƒëang ·ªü trang c√≥ khung favorite
        const listContainer = document.getElementById("favorites-list");
        if (!listContainer) return;

        try {
          // 1. G·ªçi API sang Django (Port 8000)
          const response = await fetch(
            "/api/get-favorites/",
            {
              method: "GET",
              headers: { "Content-Type": "application/json" },
              credentials: "include", // ‚ö†Ô∏è QUAN TR·ªåNG: G·ª≠i k√®m cookie ƒëƒÉng nh·∫≠p
            }
          );

          // 2. X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p (L·ªói 403)
          if (response.status === 403) {
            listContainer.innerHTML = `
                        <div style="text-align:center; padding: 20px; width: 100%;">
                            <p>‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!</p>
                            <a href="/accounts/login/" target="_blank" style="color: blue; text-decoration: underline;">
                                B·∫•m v√†o ƒë√¢y ƒë·ªÉ ƒëƒÉng nh·∫≠p
                            </a>
                        </div>`;
            return;
          }

          // 3. L·∫•y d·ªØ li·ªáu JSON
          const data = await response.json();
          const places = data.favorites;

          // 4. N·∫øu danh s√°ch r·ªóng
          if (!places || places.length === 0) {
            listContainer.innerHTML = `
                        <div style="text-align:center; padding: 40px; color: #777; width: 100%;">
                            <p>B·∫°n ch∆∞a l∆∞u qu√°n n√†o c·∫£. üçú</p>
                            <p>H√£y quay l·∫°i b·∫£n ƒë·ªì v√† th·∫£ tim nh√©!</p>
                        </div>`;
            return;
          }

          // 5. V·∫Ω danh s√°ch qu√°n ra HTML
          const htmlContent = places
            .map(
              (place) => `
                    <div class="fav-card">
                        <img src="${place.hinh_anh}" alt="${
                place.ten_quan
              }" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22%3E%3Crect fill=%22%23ddd%22 width=%22150%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="fav-info">
                            <h4>${place.ten_quan}</h4>
                            <p class="address"><i class="fa-solid fa-location-dot"></i> ${
                              place.dia_chi
                            }</p>
                            <p class="price">${place.gia_trung_binh}</p>
                            <a href="/?search=${encodeURIComponent(place.ten_quan)}" class="view-btn">
                                <i class="fa-solid fa-map-location-dot"></i> Xem v·ªã tr√≠
                            </a>
                        </div>
                    </div>
                `
            )
            .join("");

          listContainer.innerHTML = htmlContent;
        } catch (err) {
          console.error("L·ªói load favorite:", err);
          listContainer.innerHTML = `
                    <div style="text-align:center; color: red; padding: 20px;">
                        <p>‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server Django (Port 8000)</p>
                        <small>H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ b·∫≠t server backend.</small>
                    </div>`;
        }
      });
    </script>
  </body>
</html>
            