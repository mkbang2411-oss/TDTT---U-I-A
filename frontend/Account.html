<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Web Demo</title>
    <link rel="stylesheet" href="Account.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div class="background-left">
      <img
        src="Picture/background.png"
        width="850"
        height="200"
        alt="UIA Logo"
      />
    </div>

    <!--Side bar b√™n ph·∫£i-->
    <div class="sidebar-content">
            <div class="logo">
                <img src="Picture/UIAaa.png" width="500" height="200" alt="UIA Logo">
            </div>
            <div class="Menu">
                <div class="Menu_Account" onclick="showPage('Account_Page')"> T√†i Kho·∫£n</div>
                <div class="Menu_Favorite" onclick="showPage('Favorite_Page')"> Y√™u Th√≠ch</div>
            </div>
            <div class="Back">
                <a href="/" class="Button_back">
                    <img src="Picture/ƒë.png" width="50" height="50" alt="Back">
                </a>
            </div>
        </div>
        <div class="Menu_Favorite" onclick="showPage('Favorite_Page')">
          Y√™u Th√≠ch
        </div>
      </div>
      <div class="Back">
        <a href="http://127.0.0.1:5000/" class="Button_back">
          <img src="Picture/ƒë.png" width="50" height="50" alt="Back" />
        </a>
      </div>
    </div>
    <div class="main-content">
      <!--Account-->
      <div id="Account_Page" class="page active">
        <div class="Account">
          <p>T√†i Kho·∫£n</p>
        </div>
        <div
          class="avatar"
          style="display: flex; flex-direction: column; align-items: center"
        >
          <div
            class="avatar-wrapper"
            style="position: relative; display: inline-block"
          >
            <img
              id="user-avatar-img"
              src="Picture/avatar.jpg"
              width="200"
              height="200"
              alt="Avatar"
              style="
                border-radius: 50%;
                object-fit: cover;
                border: 4px solid white;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
              "
            />
            <div
              class="camera-btn"
              onclick="document.getElementById('avatar-upload-input').click()"
              style="
                position: absolute;
                bottom: 15px;
                right: 15px;
                background-color: #e4e6eb;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                border: 2px solid white;
                transition: background 0.2s;
              "
            >
              <svg viewBox="0 0 24 24" width="22" height="22" fill="black">
                <path
                  d="M21.317 4.381H10.971L9.078 2.45c-.246-.251-.736-.45-1.089-.45H5.344c-.353 0-.843.199-1.089.45L2.362 4.381H2.683C1.204 4.381 0 5.593 0 7.081V18.32c0 1.488 1.204 2.699 2.683 2.699H21.317c1.479 0 2.683-1.211 2.683-2.699V7.081c0-1.488-1.204-2.7-2.683-2.7zM12 17.626c-3.146 0-5.697-2.568-5.697-5.735 0-3.167 2.55-5.735 5.697-5.735 3.147 0 5.697 2.568 5.697 5.735 0 3.167-2.55 5.735-5.697 5.735z"
                />
              </svg>
            </div>
          </div>
          <input
            type="file"
            id="avatar-upload-input"
            accept="image/*"
            style="display: none"
            onchange="handleFileSelect()"
          />
        </div>

        <div class="Sign-out" style="margin-top: 10px">
          <a href="#" class="button-SignOut" id="logout-button">ƒêƒÉng Xu·∫•t</a>
        </div>
        <div class="account_Info">
          <div class="form-group">
            <div class="input-box">
              <label>Email</label>
              <input
                type="email"
                id="user-email"
                placeholder="abc@gmail.com"
                readonly
                style="background-color: #f9f9f9"
              />
            </div>

            <div class="input-box">
              <label>M·∫≠t kh·∫©u</label>
              <div style="display: flex; align-items: center; gap: 10px">
                <input
                  type="password"
                  id="main-password-display"
                  value="******"
                  disabled
                  style="flex: 1; background-color: #f9f9f9"
                />

                <button
                  id="btn-open-changepass"
                  onclick="openPassModal()"
                  style="
                    display: none;
                    padding: 10px 15px;
                    background: #ff6b35;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    white-space: nowrap;
                  "
                >
                  ƒê·ªïi m·∫≠t kh·∫©u
                </button>
              </div>
              <small
                id="google-note"
                style="
                  display: none;
                  color: #888;
                  margin-top: 5px;
                  font-style: italic;
                "
                >* T√†i kho·∫£n Google ƒë∆∞·ª£c qu·∫£n l√Ω b·∫£o m·∫≠t b·ªüi Google.</small
              >
            </div>

            <div
              id="password-modal"
              class="modal-overlay"
              style="display: none"
            >
              <div
                class="modal-content"
                style="width: 400px; font-family: Arial, sans-serif"
              >
                <div
                  class="modal-header"
                  style="
                    border-bottom: 1px solid #eee;
                    padding: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <h3 style="margin: 0; font-size: 18px">ƒê·ªïi m·∫≠t kh·∫©u</h3>
                  <span
                    class="close-modal"
                    onclick="closePassModal()"
                    style="font-size: 24px; cursor: pointer; color: #999"
                    >&times;</span
                  >
                </div>

                <div class="modal-body" style="padding: 20px">
                  <div class="change-pass-form">
                    <div class="input-row" style="margin-bottom: 15px">
                      <label
                        style="
                          display: block;
                          margin-bottom: 8px;
                          font-weight: bold;
                          color: #333;
                        "
                        >M·∫≠t kh·∫©u c≈©</label
                      >
                      <input
                        type="password"
                        id="inp-old-pass"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i..."
                        style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #ccc;
                          border-radius: 5px;
                          box-sizing: border-box;
                        "
                      />
                    </div>

                    <div class="input-row" style="margin-bottom: 15px">
                      <label
                        style="
                          display: block;
                          margin-bottom: 8px;
                          font-weight: bold;
                          color: #333;
                        "
                        >M·∫≠t kh·∫©u m·ªõi</label
                      >
                      <input
                        type="password"
                        id="inp-new-pass"
                        placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi..."
                        style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #ccc;
                          border-radius: 5px;
                          box-sizing: border-box;
                        "
                      />
                    </div>

                    <div class="input-row" style="margin-bottom: 0">
                      <label
                        style="
                          display: block;
                          margin-bottom: 8px;
                          font-weight: bold;
                          color: #333;
                        "
                        >X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label
                      >
                      <input
                        type="password"
                        id="inp-confirm-pass"
                        placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi..."
                        style="
                          width: 100%;
                          padding: 10px;
                          border: 1px solid #ccc;
                          border-radius: 5px;
                          box-sizing: border-box;
                        "
                      />
                    </div>
                  </div>
                </div>

                <div
                  class="modal-footer"
                  style="
                    border-top: 1px solid #eee;
                    padding: 15px;
                    text-align: right;
                    background: #f9f9f9;
                    border-radius: 0 0 8px 8px;
                  "
                >
                  <button
                    class="btn-cancel"
                    onclick="closePassModal()"
                    style="
                      padding: 8px 15px;
                      margin-right: 10px;
                      background: white;
                      border: 1px solid #ccc;
                      border-radius: 4px;
                      cursor: pointer;
                    "
                  >
                    H·ªßy
                  </button>
                  <button
                    class="btn-save"
                    onclick="submitChangePass()"
                    style="
                      padding: 8px 20px;
                      background: #1877f2;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      font-weight: bold;
                    "
                  >
                    X√°c nh·∫≠n
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="avatar-modal" class="modal-overlay" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h3>C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán</h3>
              <span class="close-modal" onclick="closeModal()">√ó</span>
            </div>

            <div class="modal-body">
              <p>Xem tr∆∞·ªõc ·∫£nh c·ªßa b·∫°n</p>
              <div class="preview-container">
                <img id="avatar-preview-img" src="" alt="Preview" />
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
              <button class="btn-save" onclick="confirmUpload()">L∆∞u</button>
            </div>
          </div>
        </div>
      </div>
      <!--Favorite-->
      <div id="Favorite_Page" class="page">
        <div class="Favorite">
          <p>Y√™u Th√≠ch</p>
        </div>
        <div id="favorites-list" class="favorites-grid-container">
          <p style="text-align: center; color: #666">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
      </div>
    </div>
    <!-- JAVASCRIPT -->
    <script>
      function showPage(pageId) {
        // ·∫®n t·∫•t c·∫£ c√°c trang
        var pages = document.querySelectorAll(".page");
        pages.forEach(function (page) {
          page.classList.remove("active");
        });

        // Hi·ªán trang ƒë∆∞·ª£c ch·ªçn
        document.getElementById(pageId).classList.add("active");

        // ƒê·ªïi active cho menu
        document.querySelectorAll(".Menu > div").forEach(function (menu) {
          menu.classList.remove("active");
        });

        if (pageId === "Account_Page") {
          document.querySelector(".Menu_Account").classList.add("active");
        } else if (pageId === "Favorite_Page") {
          document.querySelector(".Menu_Favorite").classList.add("active");
        }
      }

      // H√ÄM L·∫§Y CSRF TOKEN T·ª™ COOKIE
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      document
        .getElementById("logout-button")
        .addEventListener("click", function (e) {
          e.preventDefault(); // NgƒÉn th·∫ª <a> chuy·ªÉn trang

          Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn?",
            text: "B·∫°n s·∫Øp ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "ƒê√∫ng, ƒêƒÉng xu·∫•t!",
            cancelButtonText: "H·ªßy",
          }).then((result) => {
            if (result.isConfirmed) {
              // N·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω, g·ªçi API ƒëƒÉng xu·∫•t c·ªßa Django
              fetch("http://127.0.0.1:8000/accounts/logout/", {
                method: "POST",
                headers: {
                  // Django ƒë·ªçc CSRF token t·ª´ cookie
                  "X-CSRFToken": getCookie("csrftoken"),
                  "X-Requested-With": "XMLHttpRequest",
                },

                // B·∫£o tr√¨nh duy·ªát g·ª≠i cookie (phi√™n ƒëƒÉng nh·∫≠p)
                // t·ª´ c·ªïng 5000 sang c·ªïng 8000
                credentials: "include",
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Server t·ª´ ch·ªëi. L·ªói " + response.status);
                  }
                  // Y√™u c·∫ßu allauth tr·∫£ v·ªÅ JSON
                  return response.json();
                })
                .then((data) => {
                  Swal.fire(
                    "ƒê√£ ƒëƒÉng xu·∫•t!",
                    "B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.",
                    "success"
                  );

                  // Ch·ªù 2 gi√¢y r·ªìi chuy·ªÉn v·ªÅ trang ch·ªß
                  setTimeout(() => {
                    window.location.href = "http://127.0.0.1:5000/";
                  }, 2000);
                })
                .catch((error) => {
                  console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
                  Swal.fire(
                    "L·ªói!",
                    "C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t t·ª´ server.",
                    "error"
                  );
                });
            }
          });
        });
      const BACKEND_URL = "http://127.0.0.1:8000";

      // C√°c bi·∫øn to√†n c·ª•c cho Modal
      let selectedFile = null;
      const modal = document.getElementById("avatar-modal");
      const previewImg = document.getElementById("avatar-preview-img");
      const passModal = document.getElementById("password-modal");

      // 1. H√†m t·∫£i th√¥ng tin user t·ª´ API v√† ƒëi·ªÅn v√†o form
      function loadUserInfo() {
        fetch(`${BACKEND_URL}/api/user-info/`, {
          method: "GET",
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Avatar & Email
              document.getElementById("user-avatar-img").src = data.avatar_url;
              const emailInput = document.getElementById("user-email");
              if (emailInput) emailInput.value = data.email || "";

              // X·ª≠ l√Ω N√∫t ƒë·ªïi m·∫≠t kh·∫©u
              const btnChangePass = document.getElementById(
                "btn-open-changepass"
              );
              const googleNote = document.getElementById("google-note");

              if (data.is_social_login) {
                // N·∫øu l√† Google: ·∫®n n√∫t ƒë·ªïi pass, Hi·ªán ghi ch√∫
                if (btnChangePass) btnChangePass.style.display = "none";
                if (googleNote) googleNote.style.display = "block";
              } else {
                // N·∫øu l√† Django: Hi·ªán n√∫t ƒë·ªïi pass, ·∫®n ghi ch√∫
                if (btnChangePass) btnChangePass.style.display = "block";
                if (googleNote) googleNote.style.display = "none";
              }
            }
          })
          .catch((err) => console.error("L·ªói t·∫£i th√¥ng tin:", err));
      }
      function openPassModal() {
        // Reset c√°c √¥ input cho tr·ªëng
        document.getElementById("inp-old-pass").value = "";
        document.getElementById("inp-new-pass").value = "";
        document.getElementById("inp-confirm-pass").value = "";
        passModal.style.display = "flex";
      }
      function closePassModal() {
        passModal.style.display = "none";
      }
      function submitChangePass() {
        const oldPass = document.getElementById("inp-old-pass").value;
        const newPass = document.getElementById("inp-new-pass").value;
        const confirmPass = document.getElementById("inp-confirm-pass").value;

        // Validate s∆° b·ªô ·ªü Client
        if (!oldPass || !newPass || !confirmPass) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
          return;
        }
        if (newPass !== confirmPass) {
          alert("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");
          return;
        }
        if (newPass.length < 6) {
          alert("M·∫≠t kh·∫©u m·ªõi ph·∫£i t·ª´ 6 k√Ω t·ª± tr·ªü l√™n!");
          return;
        }

        // G·ªçi API
        fetch(`${BACKEND_URL}/api/change-password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_password: oldPass,
            new_password: newPass,
            confirm_password: confirmPass,
          }),
          credentials: "include",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire("Th√†nh c√¥ng", "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
              closePassModal();
            } else {
              Swal.fire("L·ªói", data.message, "error");
            }
          })
          .catch((err) => alert("L·ªói k·∫øt n·ªëi server."));
      }

      // S·ª± ki·ªán click ra ngo√†i ƒë·ªÉ ƒë√≥ng modal (D√πng chung cho c·∫£ Avatar Modal v√† Pass Modal)
      window.onclick = function (event) {
        const avatarModal = document.getElementById("avatar-modal");
        if (event.target == avatarModal) avatarModal.style.display = "none";
        if (event.target == passModal) passModal.style.display = "none";
      };

      // H√†m g·ªçi API ƒë·ªïi m·∫≠t kh·∫©u
      function changePassword() {
        const newPass = document.getElementById("user-password").value;
        if (!newPass) {
          alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi!");
          return;
        }
        if (newPass.length < 6) {
          alert("M·∫≠t kh·∫©u ph·∫£i d√†i h∆°n 6 k√Ω t·ª±!");
          return;
        }

        fetch(`${BACKEND_URL}/api/change-password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: newPass }),
          credentials: "include",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire("Th√†nh c√¥ng", "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!", "success");
              document.getElementById("user-password").value = "";
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((err) => alert("L·ªói k·∫øt n·ªëi server."));
      }

      // 2. Khi ng∆∞·ªùi d√πng ch·ªçn file -> Hi·ªán Modal Preview
      function handleFileSelect() {
        const fileInput = document.getElementById("avatar-upload-input");

        if (fileInput.files && fileInput.files[0]) {
          selectedFile = fileInput.files[0];
          const objectUrl = URL.createObjectURL(selectedFile);
          previewImg.src = objectUrl;
          modal.style.display = "flex";
        }
      }

      // 3. ƒê√≥ng Modal
      function closeModal() {
        modal.style.display = "none";
        document.getElementById("avatar-upload-input").value = ""; // Reset input
        selectedFile = null;
      }

      // 4. X√°c nh·∫≠n Upload (Khi b·∫•m L∆ØU trong Modal)
      function confirmUpload() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append("avatar", selectedFile);

        // Hi·ªáu ·ª©ng n√∫t b·∫•m
        const btnSave = document.querySelector(".btn-save");
        const oldText = btnSave.innerText;
        btnSave.innerText = "ƒêang l∆∞u...";
        btnSave.disabled = true;

        fetch(`${BACKEND_URL}/api/upload-avatar/`, {
          method: "POST",
          body: formData,
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // C·∫≠p nh·∫≠t ·∫£nh th·∫≠t ngo√†i m√†n h√¨nh
              document.getElementById("user-avatar-img").src =
                data.new_avatar_url;
              closeModal(); // T·∫Øt modal
              Swal.fire("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán!", "success");
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((err) => {
            console.error("L·ªói upload:", err);
            alert("C√≥ l·ªói k·∫øt n·ªëi.");
          })
          .finally(() => {
            btnSave.innerText = oldText;
            btnSave.disabled = false;
          });
      }

      // ƒê√≥ng modal khi click ra ngo√†i v√πng tr·∫Øng
      window.onclick = function (event) {
        if (event.target == modal) {
          closeModal();
        }
      };

      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Ch·ªâ ch·∫°y logic n√†y n·∫øu ƒëang ·ªü trang c√≥ khung favorite
        const listContainer = document.getElementById("favorites-list");
        if (!listContainer) return;

        try {
          // 1. G·ªçi API sang Django (Port 8000)
          const response = await fetch(
            "http://127.0.0.1:8000/api/get-favorites/",
            {
              method: "GET",
              headers: { "Content-Type": "application/json" },
              credentials: "include", // ‚ö†Ô∏è QUAN TR·ªåNG: G·ª≠i k√®m cookie ƒëƒÉng nh·∫≠p
            }
          );

          // 2. X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p (L·ªói 403)
          if (response.status === 403) {
            listContainer.innerHTML = `
                        <div style="text-align:center; padding: 20px; width: 100%;">
                            <p>‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!</p>
                            <a href="http://127.0.0.1:8000/accounts/login/" target="_blank" style="color: blue; text-decoration: underline;">
                                B·∫•m v√†o ƒë√¢y ƒë·ªÉ ƒëƒÉng nh·∫≠p
                            </a>
                        </div>`;
            return;
          }

          // 3. L·∫•y d·ªØ li·ªáu JSON
          const data = await response.json();
          const places = data.favorites;

          // 4. N·∫øu danh s√°ch r·ªóng
          if (!places || places.length === 0) {
            listContainer.innerHTML = `
                        <div style="text-align:center; padding: 40px; color: #777; width: 100%;">
                            <p>B·∫°n ch∆∞a l∆∞u qu√°n n√†o c·∫£. üçú</p>
                            <p>H√£y quay l·∫°i b·∫£n ƒë·ªì v√† th·∫£ tim nh√©!</p>
                        </div>`;
            return;
          }

          // 5. V·∫Ω danh s√°ch qu√°n ra HTML
          const htmlContent = places
            .map(
              (place) => `
                    <div class="fav-card">
                        <img src="${place.hinh_anh}" alt="${
                place.ten_quan
              }" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                        <div class="fav-info">
                            <h4>${place.ten_quan}</h4>
                            <p class="address"><i class="fa-solid fa-location-dot"></i> ${
                              place.dia_chi
                            }</p>
                            <p class="price">${place.gia_trung_binh}</p>
                            <a href="/?search=${encodeURIComponent(place.ten_quan)}" class="view-btn">
                                <i class="fa-solid fa-map-location-dot"></i> Xem v·ªã tr√≠
                            </a>
                        </div>
                    </div>
                `
            )
            .join("");

          listContainer.innerHTML = htmlContent;
        } catch (err) {
          console.error("L·ªói load favorite:", err);
          listContainer.innerHTML = `
                    <div style="text-align:center; color: red; padding: 20px;">
                        <p>‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server Django (Port 8000)</p>
                        <small>H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ b·∫≠t server backend.</small>
                    </div>`;
        }
      });
    </script>
  </body>
</html>
