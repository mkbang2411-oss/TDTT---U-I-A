<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web Demo</title>
    <link rel="stylesheet" href="Account.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="background-left">
        <img src="Picture/background.png" width="850" height="200" alt="UIA Logo">
    </div>

    <!--Side bar b√™n ph·∫£i-->
    <div class="sidebar-content">
        <div class="logo">
            <img src="Picture/UIAaa.png" width="500" height="200" alt="UIA Logo">
        </div>
        <div class="Menu">
            <div class="Menu_Account" onclick="showPage('Account_Page')">T√†i Kho·∫£n</div>
            <div class="Menu_Favorite" onclick="showPage('Favorite_Page')">Y√™u Th√≠ch</div>
            <div class="Menu_Friend" onclick="showPage('Friend_Page')">B·∫°n B√®</div>
        </div>
        <div class="Back">
            <a href="/" class="Button_back">
                <img src="Picture/ƒë.png" width="50" height="50" alt="Back">
            </a>
        </div>
    </div>

    <div class="main-content">
        <!--Account-->
        <div id="Account_Page" class="page active">
            <div class="Account">
                <p>T√†i Kho·∫£n</p>
            </div>
            <div class="avatar">
                <img src="Picture/avatar.jpg" width="200" height="200" alt="Avatar">
            </div>
            <div class="Sign-out">
                <a href="#" class="button-SignOut" id="logout-button">ƒêƒÉng Xu·∫•t</a>
            </div>
            <div class="account_Info">
                <div class="form-group">
                    <div class="input-box">
                        <label>Email</label>
                        <input type="email" placeholder="abc@gmail.com">
                    </div>
                    <div class="input-box">
                        <label>M·∫≠t kh·∫©u</label>
                        <input type="password" placeholder="***">
                    </div>
                </div>
            </div>
        </div>

        <!--Favorite-->
        <div id="Favorite_Page" class="page">
            <div class="Favorite">
                <p>Y√™u Th√≠ch</p>
            </div>
        </div>

        <!--Friends-->
        <div id="Friend_Page" class="page">
            <div class="Friend">
                <p>B·∫°n b√®</p>
            </div>

            <!-- TABS -->
            <div class="friend-tabs">
                <button class="tab-btn active" onclick="switchTab('search')">üîç T√¨m ki·∫øm</button>
                <button class="tab-btn" onclick="switchTab('requests')">üì® L·ªùi m·ªùi (<span id="request-count">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('list')">üë• Danh s√°ch b·∫°n</button>
            </div>

            <!-- TAB 1: T√åM KI·∫æM -->
            <div id="search-tab" class="tab-content active">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="search-input" class="search-input" placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c ID...">
                        <button class="search-button" onclick="searchUsers()">üîé</button>
                    </div>
                </div>
                <div id="search-results" class="friends-list"></div>
            </div>

            <!-- TAB 2: L·ªúI M·ªúI K·∫æT B·∫†N -->
            <div id="requests-tab" class="tab-content">
                <div id="friend-requests" class="friends-list"></div>
            </div>

            <!-- TAB 3: DANH S√ÅCH B·∫†N B√à -->
            <div id="list-tab" class="tab-content">
                <div id="friends-list" class="friends-list"></div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        const API_URL = 'http://127.0.0.1:8000/api/accounts';
        let CURRENT_USER_ID = null;
        let isLoadingUser = false;  // ‚úÖ Th√™m flag

        // ‚úÖ L·∫§Y TH√îNG TIN USER HI·ªÜN T·∫†I
        async function loadCurrentUser() {
            if (isLoadingUser) return;  // ‚úÖ Tr√°nh g·ªçi nhi·ªÅu l·∫ßn
            isLoadingUser = true;
            
            try {
                const response = await fetch(`${API_URL}/current-user/`, {
                    credentials: 'include'  // ‚úÖ G·ª≠i cookie
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                CURRENT_USER_ID = data.id;
                console.log('‚úÖ Current User ID:', CURRENT_USER_ID);
            } catch(error) {
                console.error('‚ùå Kh√¥ng th·ªÉ l·∫•y user hi·ªán t·∫°i:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh user. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
            } finally {
                isLoadingUser = false;
            }
        }

        // ‚úÖ G·ªåI NGAY KHI TRANG LOAD
        loadCurrentUser();

        function showPage(pageId) {
            var pages = document.querySelectorAll('.page');
            pages.forEach(function(page) {
                page.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.Menu > div').forEach(function(menu) {
                menu.classList.remove('active');
            });
            
            if(pageId === 'Account_Page') {
                document.querySelector('.Menu_Account').classList.add('active');
            } else if(pageId === 'Favorite_Page') {
                document.querySelector('.Menu_Favorite').classList.add('active');
            } else if(pageId === 'Friend_Page') {
                document.querySelector('.Menu_Friend').classList.add('active');
                // ‚úÖ ƒê·∫£m b·∫£o load xong user ID
                ensureUserLoaded().then(() => {
                    loadFriendRequests();
                    loadFriendsList();
                });
            }
        }

        // ‚úÖ TH√äM FUNCTION N√ÄY - ƒê·ª£i user load xong
        async function ensureUserLoaded() {
            if (CURRENT_USER_ID) return;  // ƒê√£ c√≥ r·ªìi
            
            // ƒê·ª£i t·ªëi ƒëa 5 gi√¢y
            for (let i = 0; i < 50; i++) {
                if (CURRENT_USER_ID) return;
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // N·∫øu v·∫´n ch∆∞a c√≥, th·ª≠ load l·∫°i
            if (!CURRENT_USER_ID) {
                await loadCurrentUser();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if(tabName === 'search') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('search-tab').classList.add('active');
            } else if(tabName === 'requests') {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('requests-tab').classList.add('active');
                ensureUserLoaded().then(() => loadFriendRequests());
            } else if(tabName === 'list') {
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                document.getElementById('list-tab').classList.add('active');
                ensureUserLoaded().then(() => loadFriendsList());
            }
        }

        // T√åM KI·∫æM USER
        async function searchUsers() {
            const query = document.getElementById('search-input').value.trim();
            if(!query) {
                Swal.fire('L·ªói', 'Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users/search/?q=${query}`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('search-results');
                if(data.users && data.users.length > 0) {
                    resultsDiv.innerHTML = data.users.map(user => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${user.username}</div>
                                    <div class="friend-email">${user.email}</div>
                                </div>
                            </div>
                            <button class="btn-add" onclick="sendFriendRequest(${user.id})">‚ûï K·∫øt b·∫°n</button>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = '<p class="no-data">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</p>';
                }
            } catch(error) {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t√¨m ki·∫øm', 'error');
            }
        }

        // G·ª¨I L·ªúI M·ªúI K·∫æT B·∫†N
        async function sendFriendRequest(receiverId) {
            // ‚úÖ ƒê·∫£m b·∫£o ƒë√£ load user ID
            await ensureUserLoaded();
            
            if(!CURRENT_USER_ID) {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh user hi·ªán t·∫°i. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
                return;
            }
            
            console.log(`üì§ G·ª≠i l·ªùi m·ªùi: sender=${CURRENT_USER_ID}, receiver=${receiverId}`);
            
            try {
                const response = await fetch(`${API_URL}/friend-request/send/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',  // ‚úÖ Th√™m
                    body: JSON.stringify({
                        sender_id: CURRENT_USER_ID,
                        receiver_id: receiverId
                    })
                });
                
                const data = await response.json();
                if(data.success) {
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n', 'success');
                } else {
                    Swal.fire('L·ªói', data.error, 'error');
                }
            } catch(error) {
                console.error('L·ªói g·ª≠i l·ªùi m·ªùi:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i l·ªùi m·ªùi', 'error');
            }
        }

        // T·∫¢I DANH S√ÅCH L·ªúI M·ªúI
        async function loadFriendRequests() {
            if(!CURRENT_USER_ID) {
                console.log('‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/friend-requests/${CURRENT_USER_ID}/`);
                const data = await response.json();
                
                const requestsDiv = document.getElementById('friend-requests');
                const count = data.requests ? data.requests.length : 0;
                document.getElementById('request-count').textContent = count;
                
                if(count > 0) {
                    requestsDiv.innerHTML = data.requests.map(req => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${req.sender_username}</div>
                                    <div class="friend-email">G·ª≠i l√∫c: ${req.created_at}</div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn-accept" onclick="acceptRequest(${req.id})">‚úì Ch·∫•p nh·∫≠n</button>
                                <button class="btn-reject" onclick="rejectRequest(${req.id})">‚úó T·ª´ ch·ªëi</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    requestsDiv.innerHTML = '<p class="no-data">Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n n√†o</p>';
                }
            } catch(error) {
                console.error('L·ªói t·∫£i l·ªùi m·ªùi:', error);
            }
        }

        // CH·∫§P NH·∫¨N L·ªúI M·ªúI
        async function acceptRequest(requestId) {
            try {
                const response = await fetch(`${API_URL}/friend-request/accept/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({request_id: requestId})
                });
                
                const data = await response.json();
                if(data.success) {
                    Swal.fire('Th√†nh c√¥ng', 'ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi', 'success');
                    loadFriendRequests();
                    loadFriendsList();
                }
            } catch(error) {
                console.error('L·ªói:', error);
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ ch·∫•p nh·∫≠n', 'error');
            }
        }

        // T·ª™ CH·ªêI L·ªúI M·ªúI
        async function rejectRequest(requestId) {
            try {
                const response = await fetch(`${API_URL}/friend-request/reject/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({request_id: requestId})
                });
                
                const data = await response.json();
                if(data.success) {
                    Swal.fire('ƒê√£ t·ª´ ch·ªëi', 'L·ªùi m·ªùi ƒë√£ b·ªã t·ª´ ch·ªëi', 'info');
                    loadFriendRequests();
                }
            } catch(error) {
                console.error('L·ªói:', error);
            }
        }

        // T·∫¢I DANH S√ÅCH B·∫†N B√à
        async function loadFriendsList() {
            if(!CURRENT_USER_ID) {
                console.log('‚è≥ Ch∆∞a c√≥ CURRENT_USER_ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/friends/${CURRENT_USER_ID}/`);
                const data = await response.json();
                
                const friendsDiv = document.getElementById('friends-list');
                if(data.friends && data.friends.length > 0) {
                    friendsDiv.innerHTML = data.friends.map(friend => `
                        <div class="friend-card">
                            <div class="friend-info">
                                <div class="friend-avatar">üë§</div>
                                <div>
                                    <div class="friend-name">${friend.username}</div>
                                    <div class="friend-email">${friend.email}</div>
                                </div>
                            </div>
                            <button class="btn-chat">üí¨ Nh·∫Øn tin</button>
                        </div>
                    `).join('');
                } else {
                    friendsDiv.innerHTML = '<p class="no-data">Ch∆∞a c√≥ b·∫°n b√® n√†o</p>';
                }
            } catch(error) {
                console.error('L·ªói t·∫£i danh s√°ch b·∫°n:', error);
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('logout-button').addEventListener('click', function(e) {
            e.preventDefault();

            Swal.fire({
                title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?',
                text: "B·∫°n s·∫Øp ƒëƒÉng xu·∫•t kh·ªèi t√†i kho·∫£n!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ƒê√∫ng, ƒêƒÉng xu·∫•t!',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('http://127.0.0.1:8000/accounts/logout/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Server t·ª´ ch·ªëi. L·ªói ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.fire('ƒê√£ ƒëƒÉng xu·∫•t!', 'B·∫°n ƒë√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng.', 'success');
                        setTimeout(() => {
                            window.location.href = 'http://127.0.0.1:5000/';
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
                        Swal.fire('L·ªói!', 'C√≥ l·ªói x·∫£y ra, kh√¥ng th·ªÉ ƒëƒÉng xu·∫•t t·ª´ server.', 'error');
                    });
                }
            });
        });

        // T√¨m ki·∫øm khi nh·∫•n Enter
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                searchUsers();
            }
        });
    </script>
</body>
</html>